import streamlit as st
import random
import time
import html
from datetime import datetime

# ==============================================================================
# ×—×œ×§ 1: ×”×’×“×¨×•×ª ××¢×¨×›×ª ×•×¢×™×¦×•×‘ (System & CSS)
# ==============================================================================

st.set_page_config(
    page_title="PICU Pro Master - ××¢×¨×›×ª ×œ××™×“×” ×•×¡×™××•×œ×¦×™×”",
    page_icon="ğŸ¥",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- ×× ×•×¢ ×¨×™× ×“×•×¨ HTML ×—×›× (××•× ×¢ ×©×‘×™×¨×ª ×©×•×¨×•×ª) ---
def render_clean_html(text, sanitize=False):
    if not text: return ""
    if sanitize:
        text = html.escape(text)
    html = text.replace("\n", "<br>")
    lines = html.split("<br>")
    formatted = []
    in_list = False
    
    for line in lines:
        cl = line.strip()
        if not cl: continue
        
        # ×›×•×ª×¨×•×ª
        if cl.startswith("###"):
            if in_list: formatted.append("</ul>"); in_list = False
            cl = f"<h3 style='color:#01579b; border-bottom:2px solid #b3e5fc; margin-top:20px; font-weight:700;'>{cl.replace('###','')}</h3>"
        elif cl.startswith("##"):
            if in_list: formatted.append("</ul>"); in_list = False
            cl = f"<div style='background:linear-gradient(90deg, #e3f2fd 0%, #fff 100%); padding:12px; border-right:5px solid #1565c0; border-radius:6px; margin-top:30px;'><h2 style='color:#0d47a1; margin:0; font-size:1.5rem; font-weight:800;'>{cl.replace('##','')}</h2></div>"
        
        # ×˜×§×¡×˜ ××•×“×’×© (×›×•×ª×¨×•×ª ×¤× ×™××™×•×ª)
        elif "**" in cl and cl.startswith("**") and (":" in cl or len(cl.split("**")[1]) < 20):
            parts = cl.split("**")
            if len(parts) >= 3:
                cl = f"<div style='margin:10px 0; background:#fafafa; padding:8px; border-radius:4px; border-right:3px solid #ef5350;'><span style='color:#c62828; font-weight:800; display:block;'>ğŸ“Œ {parts[1]}</span><span style='color:#37474f;'>{''.join(parts[2:])}</span></div>"
        
        # ×¨×©×™××•×ª
        elif cl.startswith("* ") or cl.startswith("- "):
            if not in_list: formatted.append("<ul style='margin-right:20px; list-style-type:disc;'>"); in_list = True
            content = cl[2:]
            if "**" in content: 
                parts = content.split("**")
                new_c = ""
                for i, p in enumerate(parts):
                    if i%2==1: new_c += f"<span style='font-weight:700; background-color:#fff9c4; padding:0 4px; border-radius:3px;'>{p}</span>"
                    else: new_c += p
                content = new_c
            cl = f"<li style='margin-bottom:5px; line-height:1.6;'>{content}</li>"
        else:
            if in_list: formatted.append("</ul>"); in_list = False
            cl = f"<div style='margin-bottom:8px; line-height:1.6;'>{cl}</div>"
        formatted.append(cl)
    if in_list: formatted.append("</ul>")
    return "".join(formatted)

# CSS ×’×œ×•×‘×œ×™
st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap');
    html, body, .stApp { font-family: 'Rubik', sans-serif !important; direction: rtl; text-align: right; background-color: #f8f9fa; }
    h1, h2, h3, h4, p, div, span, button, input, label { text-align: right !important; }
    
    /* ×›×¨×˜×™×¡×™×•×ª ×“×£ ×”×‘×™×ª */
    .nav-card { background: white; border-radius: 15px; padding: 20px; text-align: center !important; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 5px solid #1976d2; transition: 0.3s; cursor: pointer; height: 200px; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .nav-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); border-color: #0d47a1; }
    .nav-icon { font-size: 3.5rem; margin-bottom: 10px; }
    .nav-title { font-size: 1.3rem; font-weight: 700; color: #1565c0; }
    .nav-desc { font-size: 0.9rem; color: #90a4ae; margin-top:5px;}

    /* ×ª×•×›×Ÿ */
    .content-box { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); border-right: 8px solid #1565c0; margin-bottom: 30px; }
    
    /* ×¡×™××•×œ×˜×•×¨ */
    .sim-monitor { background: #000; color: #0f0; padding: 20px; border-radius: 10px; font-family: 'Courier New', monospace; display: flex; justify-content: space-around; border: 4px solid #333; margin-bottom: 20px; text-shadow: 0 0 5px #0f0; }
    .sim-val { font-size: 2.5rem; font-weight: bold; }
    .sim-label { font-size: 0.8rem; color: #bdbdbd; text-transform: uppercase; }

    /* ×›×¤×ª×•×¨×™× */
    .stButton button { width: 100%; border-radius: 8px; font-weight: 600; padding: 12px; border: 1px solid #ddd; transition:0.2s; background:white; }
    .stButton button:hover { background: #e3f2fd; border-color: #2196f3; color: #1565c0; transform: scale(1.01); }
    
    #MainMenu {visibility: hidden;} footer {visibility: hidden;}
</style>
""", unsafe_allow_html=True)
# ==============================================================================
# ×—×œ×§ 2: ×××’×¨ ×”×ª×¨×•×¤×•×ª (Pharmacology DB)
# ==============================================================================

DRUGS_DB = {
    "××“× ×•×–×™×Ÿ (Adenosine)": {
        "text": """## ××“× ×•×–×™×Ÿ (Adenosine)
**×§×‘×•×¦×”:** × ×•×’×“×™ ×”×¤×¨×¢×•×ª ×§×¦×‘. **×”×ª×•×•×™×”:** SVT.
### ××•×¤×Ÿ ××ª×Ÿ ×§×¨×™×˜×™:
×–××Ÿ ××—×¦×™×ª ×—×™×™× <10 ×©× ×™×•×ª. ×—×•×‘×” ×œ×ª×ª ×‘×©×™×˜×ª **Push-Flush**:
1. ×”×–×¨×§×” ××”×™×¨×” ×‘×‘×¨×– ×”×›×™ ×§×¨×•×‘ ×œ×œ×‘.
2. ×©×˜×™×¤×” ××”×™×¨×” ×©×œ ×¡×œ×™×™×Ÿ (5-10 ×"×œ).
3. ×”×¨××ª ×”×’×¤×”.
### ××™× ×•× ×™×:
* ×× ×” 1: 0.1 ×"×’/×§"×’ (××§×¡' 6 ×"×’).
* ×× ×” 2: 0.2 ×"×’/×§"×’ (××§×¡' 12 ×"×’).
* ×ª×•×¤×¢×•×ª ×œ×•×•××™: ×ª×—×•×©×ª ××—× ×§, ×”×¡××§×”, Asystole ×¨×’×¢×™×ª.""", "image": ""},
    
    "××“×¨× ×œ×™×Ÿ (Epinephrine)": {
        "text": """## ××“×¨× ×œ×™×Ÿ (Epinephrine)
**××™× ×“×™×§×¦×™×•×ª:** ×”×—×™×™××”, ×©×•×§, ×× ×¤×™×œ×§×¡×™×¡, ×¡×˜×¨×™×“×•×¨.
### ××™× ×•× ×™× ×•×¨×™×›×•×–×™× (×–×”×™×¨×•×ª!):
**1. ×”×—×™×™××” (IV/IO):** ××™× ×•×Ÿ **0.01 ×"×’/×§"×’**. ×¨×™×›×•×– 1:10,000 (0.1 ×"×œ/×§"×’). ××§×¡' 1 ×"×’. ×›×œ 3-5 ×“×§'.
**2. ×× ×¤×™×œ×§×¡×™×¡ (IM):** ××™× ×•×Ÿ **0.01 ×"×’/×§"×’**. ×¨×™×›×•×– 1:1,000 (×œ× ××“×•×œ×œ). ××§×¡' 0.5 ×"×’.
**3. ×“×¨×™×¤ (Inotrope):** 0.05-1.0 ××§"×’/×§"×’/×“×§×”.
**4. ××™× ×”×œ×¦×™×”:** 0.5 ×"×œ/×§"×’ (××§×¡' 5 ×"×œ).""", "image": ""},
    
    "××˜×¨×•×¤×™×Ÿ (Atropine)": {
        "text": """## ××˜×¨×•×¤×™×Ÿ
×× ×˜×™-×›×•×œ×™× ×¨×’×™.
**××™× ×“×™×§×¦×™×•×ª:** ×‘×¨×“×™×§×¨×“×™×” ×¡×™××¤×˜×•××˜×™×ª (×•×’××œ×™×ª), ×”×¨×¢×œ×ª ×–×¨×—× ×™× ××•×¨×’× ×™×™×, ×”×›× ×” ×œ××™× ×˜×•×‘×¦×™×” (×¢× ×§×˜××™×Ÿ).
**××™× ×•×Ÿ:** 0.02 ×"×’/×§"×’ (×× ×ª ××™× ×™××•× 0.1 ×"×’ ×œ×× ×™×¢×ª ×‘×¨×“×™×§×¨×“×™×” ×¤×¨×“×•×§×¡×œ×™×ª).
**××§×¡×™××•×:** 0.5 ×"×’ (×™×œ×“), 1 ×"×’ (××ª×‘×’×¨).""", "image": ""},
    
    "×××™××•×“×•×¨×•×Ÿ (Procor)": {
        "text": """## ×××™××•×“×•×¨×•×Ÿ (Amiodarone)
**××™× ×“×™×§×¦×™×”:** VF/pVT ×¢××™×“, ×˜×›×™××¨×™×ª××™×•×ª.
**××™× ×•×Ÿ ×”×—×™×™××”:** 5 ×"×’/×§"×’ IV/IO ×‘×•×œ×•×¡. × ×™×ª×Ÿ ×œ×—×–×•×¨ ×¢×“ 15 ×"×’/×§"×’ (××§×¡' 300 ×"×’ ×œ×× ×”).
**××™× ×•×Ÿ ×”×¢××¡×” (×œ× ×‘×”×—×™×™××”):** 5 ×"×’/×§"×’ ×‘××©×š 20-60 ×“×§×•×ª.
**×ª"×œ:** ×™×¨×™×“×ª ×œ"×“, ×‘×¨×“×™×§×¨×“×™×”.""", "image": ""},
    
    "××©×œ×’×Ÿ (Potassium)": {
        "text": """## ××©×œ×’×Ÿ (K+)
**×”×™×¤×•×§×œ××™×”:** ×—×•×‘×” ×œ×ª×§×Ÿ **××’× ×–×™×•×** ×§×•×“×! ×§×¦×‘ IV ××§×¡' 0.5-1 mEq/kg/h.
**×”×™×¤×¨×§×œ××™×” (×—×™×¨×•×):**
1. **×§×œ×¦×™×•× ×’×œ×•×§×•× ×˜:** ×”×’× ×” ×¢×œ ×”×œ×‘ (Cardioprotection).
2. **××™× ×¡×•×œ×™×Ÿ (0.1 ×™×—'/×§"×’) + ×’×œ×•×§×•×–:** ×”×›× ×¡×ª ××©×œ×’×Ÿ ×œ×ª××™×.
3. **×•× ×˜×•×œ×™×Ÿ:** ××™× ×”×œ×¦×™×”.
4. **×¤×•×¡×™×“ / Kayexalate:** ×¤×™× ×•×™.""", "image": ""},
    
    "×‘×™×§×¨×‘×•× ×˜ (Sodium Bicarbonate)": {
        "text": """## ×¡×•×“×™×•× ×‘×™×§×¨×‘×•× ×˜
**××™× ×“×™×§×¦×™×•×ª:** ×—××¦×ª ××˜×‘×•×œ×™×ª ×§×©×”, ×”×¨×¢×œ×ª ×˜×¨×™×¦×™×§×œ×™×, ×”×™×¤×¨×§×œ××™×”.
**××™× ×•×Ÿ:** 1 mEq/kg (IV ××™×˜×™).
**×“×™×œ×•×œ:** ×‘×ª×™× ×•×§×•×ª < ×—×•×“×© ×™×© ×œ×“×œ×œ 1:1 ×¢× ××™×/×¡×œ×™×™×Ÿ (×›×“×™ ×œ×× ×•×¢ ×“×™××•× ××•×—×™ ×¢×§×‘ ××•×¡××•×œ×¨×™×•×ª ×’×‘×•×”×”).""", "image": ""},
    
    "×“×•×¤××™×Ÿ (Dopamine)": {
        "text": """## ×“×•×¤××™×Ÿ
××™× ×•×˜×¨×•×¤.
**××™× ×•× ×™×:**
* 2-5 ××§"×’/×§"×’/×“×§': "×›×œ×™×ª×™" (×œ× ×™×¢×™×œ).
* 5-10 ××§"×’/×§"×’/×“×§': ×‘×˜× (×œ×‘×‘×™).
* 10-20 ××§"×’/×§"×’/×“×§': ××œ×¤× (×•×•×¡×§×•×œ×¨×™).""", "image": ""},
    
    "×”×™×“×¨×•×§×•×¨×˜×™×–×•×Ÿ": {
        "text": """## ×”×™×“×¨×•×§×•×¨×˜×™×–×•×Ÿ
**××™× ×“×™×§×¦×™×”:** ×©×•×§ ×¡×¤×˜×™ ×¢××™×“ (×—×©×“ ×œ××™ ×¡×¤×™×§×ª ××“×¨× ×œ), ××¡×˜××”.
**××™× ×•×Ÿ:** ×‘×•×œ×•×¡ 50-100 ×"×’/×"×¨ ×’×•×£ (××• 1-2 ×"×’/×§"×’).""", "image": ""},
    
    "×•× ×˜×•×œ×™×Ÿ (Salbutamol)": {
        "text": """## ×•× ×˜×•×œ×™×Ÿ
××¨×—×™×‘ ×¡×™××¤×•× ×•×ª.
**××™× ×”×œ×¦×™×”:** 0.15 ×"×’/×§"×’ (××™× ×™××•× 2.5 ×"×’). ×‘×”×ª×§×£ ×§×©×” × ×™×ª×Ÿ ×œ×ª×ª ×‘×¨×¦×£.
**IV:** ×‘××¦×‘×™ ×§×™×¦×•×Ÿ, ×‘×•×œ×•×¡ 10 ××§"×’/×§"×’ ×•××– ×“×¨×™×¤.""", "image": ""},
    
    "××’× ×–×™×•× (Magnesium)": {
        "text": """## ××’× ×–×™×•× ×¡×•×œ×¤×˜
**××™× ×“×™×§×¦×™×•×ª:** ××¡×˜××” ×§×©×”, Torsades de Pointes, ×”×™×¤×•××’× ×–××™×”.
**××™× ×•×Ÿ:** 25-50 ×"×’/×§"×’ (××§×¡' 2 ×’×¨×) ×‘××©×š 20 ×“×§×•×ª.
**×ª"×œ:** ×™×¨×™×“×ª ×œ"×“ (××ª×Ÿ ××”×™×¨).""", "image": ""},
    
    "××™×“×–×•×œ× (Dormicum)": {
        "text": """## ××™×“×–×•×œ×
×‘× ×–×•×“×™××–×¤×™×Ÿ. ×¡×“×¦×™×”/×¤×¨×›×•×¡.
**××™× ×•×Ÿ IV:** 0.1-0.2 ×"×’/×§"×’. ×“×¨×™×¤: 1-5 ××§"×’/×§"×’/×“×§×”.
**×“×’×©:** ×–×”×™×¨×•×ª ×‘×ª×™× ×•×§×•×ª (×“×™×›×•×™ × ×©×™××ª×™).
**×× ×˜×™×“×•×˜:** ×¤×œ×•××–× ×™×œ.""", "image": ""},
    
    "× ×•×¨××“×¨× ×œ×™×Ÿ (Levophed)": {
        "text": """## × ×•×¨××“×¨× ×œ×™×Ÿ
××›×•×•×¥ ×›×œ×™ ×“× ×—×–×§ (××œ×¤×). ×ª×¨×•×¤×ª ×‘×—×™×¨×” ×œ×©×•×§ ×¡×¤×˜×™ "×—×".
**××™× ×•×Ÿ:** 0.05-1.0 ××§"×’/×§"×’/×“×§×”.
**××ª×Ÿ:** ×¨×¦×•×™ ×‘×•×¨×™×“ ××¨×›×–×™ (×¡×›× ×ª × ××§).""", "image": ""},
    
    "×¤× ×™×˜×•××™×Ÿ (Epanutin)": {
        "text": """## ×¤× ×™×˜×•××™×Ÿ
×× ×˜×™-××¤×™×œ×¤×˜×™.
**×—×•×‘×”:** ×œ×“×œ×œ ×‘-Normal Saline ×‘×œ×‘×“! (××ª×’×‘×© ×‘×’×œ×•×§×•×–).
**×¤×™×œ×˜×¨:** ×—×•×‘×” ×œ×”×©×ª××© ×‘×¤×™×œ×˜×¨ 0.2 ××™×§×¨×•×Ÿ.
**×§×¦×‘:** ××™×˜×™! (××§×¡' 1 ×"×’/×§"×’/×“×§×”).""", "image": ""},
    
    "×§×˜××™×Ÿ (Ketamine)": {
        "text": """## ×§×˜××™×Ÿ
×”×¨×“××” ×“×™×¡×•×¦×™××˜×™×‘×™×ª. ×©×•××¨ ×œ"×“ ×•× ×©×™××” (××¦×•×™×Ÿ ×œ×©×•×§/××¡×˜××”).
**××™× ×•×Ÿ:** 1-2 ×"×’/×§"×’ (IV), 4-5 ×"×’/×§"×’ (IM).
**×ª"×œ:** ×¨×™×•×¨ (×œ×©×œ×‘ ××˜×¨×•×¤×™×Ÿ), ×”×–×™×•×ª.""", "image": ""},
    
    "×¨×•×§×•×¨×•× ×™×•× (Esmeron)": {
        "text": """## ×¨×•×§×•×¨×•× ×™×•×
××©×ª×§ ×©×¨×™×¨×™×.
**××™× ×˜×•×‘×¦×™×” (RSI):** 1 ×"×’/×§"×’.
**××–×”×¨×”:** ×”××˜×•×¤×œ ××©×•×ª×§ ××š ×¢×¨! ×—×•×‘×” ×œ×ª×ª ×¡×“×¦×™×” ×œ×¤× ×™.""", "image": ""}
}
# ==============================================================================
# ×—×œ×§ 3: ×××’×¨ ××¦×‘×™× ×¨×¤×•××™×™× (Medical DB)
# ==============================================================================

MEDICAL_DB = {
    "ğŸš‘ ××¦×‘×™ ×—×™×¨×•× ×•×”×—×™×™××”": {
        "icon": "ğŸš‘",
        "description": "×©×•×§, ×¡×¤×¡×™×¡, PALS, ×˜×¨××•××”, ×›×•×•×™×•×ª, ×”×¨×¢×œ×•×ª.",
        "topics": {
            "×”×—×™×™××” (PALS)": {
                "text": """## ×”×—×™×™××ª ×™×œ×“×™× (PALS)
**×¢×™×¡×•×™×™×:** ×¢×•××§ 1/3 ×‘×™×ª ×—×–×”, ×§×¦×‘ 100-120. ×™×—×¡ 15:2.
**×“×¤×™×‘×¨×™×œ×¦×™×” (VF/pVT):** ×× ×” 1: **2 J/kg**. ×× ×” 2: **4 J/kg**. ×”××©×š ×¢×“ 10 J/kg.
**×ª×¨×•×¤×•×ª:** ××“×¨× ×œ×™×Ÿ (×›×œ 3-5 ×“×§'), ×××™××•×“×•×¨×•×Ÿ.""", "image": ""},
            "×©×•×§ ×”×™×¤×•×•×œ××™": {
                "text": """## ×©×•×§ ×”×™×¤×•×•×œ××™
×”×©×›×™×— ×‘×™×•×ª×¨.
**×§×œ×™× ×™×§×”:** ×˜×›×™×§×¨×“×™×”, ××™×œ×•×™ ×§×¤×™×œ×¨×™ ××™×˜×™. ×œ"×“ × ××•×š = ×××•×—×¨!
**×˜×™×¤×•×œ:**
1. ×‘×•×œ×•×¡ × ×•×–×œ×™× 20 ×"×œ/×§"×’ (××™×–×•×˜×•× ×™).
2. ×—×–×¨×” ×¢×“ 3 ×¤×¢××™×.
3. ×“× (10 ×"×œ/×§"×’) ×× ××™×Ÿ ×©×™×¤×•×¨.""", "image": ""},
            "×©×•×§ ×¡×¤×˜×™": {
                "text": """## ×¡×¤×¡×™×¡ ×•×©×•×§ ×¡×¤×˜×™
**×˜×™×¤×•×œ Golden Hour:**
1. ×’×™×©×” ×•×¨×™×“×™×ª + ×ª×¨×‘×™×•×ª.
2. ×× ×˜×™×‘×™×•×˜×™×§×” ×¨×—×‘×” **×ª×•×š ×©×¢×”!**
3. × ×•×–×œ×™×: 20-60 ×"×œ/×§"×’.
4. ××™× ×•×˜×¨×•×¤×™×: ××“×¨× ×œ×™×Ÿ (×§×¨) / × ×•×¨××“×¨× ×œ×™×Ÿ (×—×).""", "image": ""},
            "×× ×¤×™×œ×§×¡×™×¡": {
                "text": """## ×× ×¤×™×œ×§×¡×™×¡
**×˜×™×¤×•×œ ××™×™×“×™:**
1. **××“×¨× ×œ×™×Ÿ IM:** 0.01 ×"×’/×§"×’. ×‘×™×¨×š.
2. × ×•×–×œ×™× (×“×œ×™×¤×” ×§×¤×™×œ×¨×™×ª).
3. ×•× ×˜×•×œ×™×Ÿ/×¡×˜×¨×•××™×“×™× (×§×• ×©× ×™).""", "image": ""},
            "×›×•×•×™×•×ª (Burns)": {
                "text": """## ×›×•×•×™×•×ª (Parkland)
**× ×•×–×œ×™× ×œ-24 ×©×¢×•×ª:** `4 ×"×œ * ××©×§×œ * % ×›×•×•×™×”`.
* 50% ×‘-8 ×©×¢×•×ª ×¨××©×•× ×•×ª.
* **×‘×™×œ×“×™×:** ×œ×”×•×¡×™×£ × ×•×–×œ×™ ××—×–×§×” ×¢× ×¡×•×›×¨!
**×©××™×¤×ª ×¢×©×Ÿ:** ××™× ×˜×•×‘×¦×™×” ××•×§×“××ª.""", "image": ""},
            "×”×¨×¢×œ×•×ª": {
                "text": """## ×”×¨×¢×œ×•×ª × ×¤×•×¦×•×ª
**××§××•×œ:** ×× ×˜×™×“×•×˜ NAC (Mucomyst). ×¨××•×ª ×‘×“× ××—×¨×™ 4 ×©×¢×•×ª.
**××•×¤×™××˜×™×:** ×§×•××”, ××™×©×•× ×™ ×¡×™×›×”. ×× ×˜×™×“×•×˜: × ×œ×•×§×¡×•×Ÿ (0.1 ×"×’/×§"×’).
**×–×¨×—× ×™× ××•×¨×’× ×™×™×:** ×¨×™×•×¨, ×“××¢×ª. ×˜×™×¤×•×œ: ××˜×¨×•×¤×™×Ÿ.""", "image": ""},
            "×”×›×©×ª × ×—×©": {
                "text": """## ×”×›×©×ª × ×—×© (×¦×¤×¢)
**×˜×™×¤×•×œ:**
1. ×× ×•×—×” ×•×§×™×‘×•×¢ ×”×’×¤×”.
2. **××¡×•×¨:** ×œ××¦×•×¥, ×œ×—×ª×•×š, ×—×¡× ×¢×•×¨×§×™×, ×§×¨×—.
3. ×¡×™××•×Ÿ ×’×‘×•×œ ×”× ×¤×™×—×•×ª.
4. **×× ×˜×™-×¡×¨×•×:** ×‘×”×ª×¤×©×˜×•×ª ××”×™×¨×”/×©×•×§.""", "image": ""}
        }
    },
    "ğŸ§  × ×•×™×¨×•×œ×•×’×™×”": {
        "icon": "ğŸ§ ",
        "description": "TBI, ICP, ×¡×˜×˜×•×¡, ×× ×™× ×’×™×˜×™×¡.",
        "topics": {
            "×—×‘×œ×ª ×¨××© (TBI)": {
                "text": """## ×—×‘×œ×ª ×¨××© (TBI)
**×™×¢×“:** CPP ×ª×§×™×Ÿ (MAP-ICP).
**Cushing Triad:** ×™×ª"×œ + ×‘×¨×“×™×§×¨×“×™×” + × ×©×™××” ×œ× ×¡×“×™×¨×”.
**×˜×™×¤×•×œ ×‘-ICP:**
1. ×”×¨××ª ×¨××© 30 ××¢×œ×•×ª.
2. ×¡×œ×™×™×Ÿ ×”×™×¤×¨×˜×•× ×™ 3% (3-5 ×"×œ/×§"×’).
3. ×× ×™×˜×•×œ.
4. ×”×™×¤×¨×•×•× ×˜×™×œ×¦×™×” (×¨×§ ×›××•×¦× ××—×¨×•×Ÿ).""", "image": ""},
            "×¡×˜×˜×•×¡ ××¤×™×œ×¤×˜×™×§×•×¡": {
                "text": """## ×¡×˜×˜×•×¡ ××¤×™×œ×¤×˜×™×§×•×¡
**×¤×¨×•×˜×•×§×•×œ:**
1. ABC, ×¡×•×›×¨.
2. **××™×™×“×™:** ××™×“×–×•×œ×.
3. **×”×¢××¡×”:** ×¤× ×™×˜×•××™×Ÿ (×‘×¡×œ×™×™×Ÿ!), ×§×¤×¨×”, ××• ×¤× ×•×‘×¨×‘×™×˜×œ.
4. **×”×¨×“××”:** ××™×“×–×•×œ× ×“×¨×™×¤/×¤×¨×•×¤×•×¤×•×œ.""", "image": ""},
            "×× ×™× ×’×™×˜×™×¡": {
                "text": """## ×× ×™× ×’×™×˜×™×¡
**×¡×™×× ×™×:** ×—×•×, ×§×©×™×•×Ÿ ×¢×•×¨×£, ×¤×•×˜×•×¤×•×‘×™×”, ×¤×˜×›×™×•×ª.
**×˜×™×¤×•×œ:** ×¨×•×¦×¤×™×Ÿ (100 ×"×’/×§"×’/×™×•×) + ×•×× ×§×•××™×¦×™×Ÿ.""", "image": ""},
            "DI vs SIADH": {
                "text": """## ×××–×Ÿ ××œ×—×™× ××•×—×™
**DI:** ×—×¡×¨ ADH. ×©×ª×Ÿ ××¨×•×‘×”, **×”×™×¤×¨× ×ª×¨××™×”**. ×˜×™×¤×•×œ: × ×•×–×œ×™×, DDAVP.
**SIADH:** ×¢×•×“×£ ADH. ××™×¢×•×˜ ×©×ª×Ÿ, **×”×™×¤×•× ×ª×¨××™×”**. ×˜×™×¤×•×œ: ×”×’×‘×œ×ª × ×•×–×œ×™×.""", "image": ""}
        }
    },
    "ğŸ« × ×©×™××”": {
        "icon": "ğŸ«",
        "description": "××¡×˜××”, ×‘×¨×•× ×›×™×•×œ×™×˜×™×¡, ×§×¨×•×¤.",
        "topics": {
            "×¡×˜×˜×•×¡ ××¡×˜××ª×™": {
                "text": """## ×¡×˜×˜×•×¡ ××¡×˜××ª×™
**×˜×™×¤×•×œ:** ×—××¦×Ÿ, ××™× ×”×œ×¦×™×•×ª ×¨×¦×•×¤×•×ª (×•× ×˜×•×œ×™×Ÿ+××™×¨×•×‘× ×˜), ×¡×˜×¨×•××™×“×™× IV, ××’× ×–×™×•× IV. ×§×• ××—×¨×•×Ÿ: ××™× ×˜×•×‘×¦×™×”.""", "image": ""},
            "×‘×¨×•× ×›×™×•×œ×™×˜×™×¡": {
                "text": """## ×‘×¨×•× ×›×™×•×œ×™×˜×™×¡ (RSV)
**×˜×™×¤×•×œ:** ×ª×•××š! (×—××¦×Ÿ, ×©××™×‘×•×ª). High Flow ×™×¢×™×œ.""", "image": ""},
            "×§×¨×•×¤ (Croup)": {
                "text": """## ×§×¨×•×¤
**×˜×™×¤×•×œ:** ×“×§×¡××ª×–×•×Ÿ, ××™× ×”×œ×¦×™×™×ª ××“×¨× ×œ×™×Ÿ.""", "image": ""},
            "××¤×™×’×œ×•×˜×™×˜×™×¡": {
                "text": """## ××¤×™×’×œ×•×˜×™×˜×™×¡
**×—×™×¨×•×:** ×œ× ×œ×‘×“×•×§ ×œ×•×¢! ××™× ×˜×•×‘×¦×™×” ×‘×—×“×¨ × ×™×ª×•×—.""", "image": ""}
        }
    },
    "ğŸ©¸ ×”××˜×•-××•× ×§×•×œ×•×’×™×”": {
        "icon": "ğŸ©¸",
        "description": "×œ×•×§××™×”, TLS, ××•×¦×¨×™ ×“×.",
        "topics": {
            "×œ×•×§××™×” ×•× ×•×™×˜×¨×•×¤× ×™×”": {
                "text": """## ×œ×•×§××™×” ×•× ×•×™×˜×¨×•×¤× ×™×”
**×—×•× ×•× ×•×™×˜×¨×•×¤× ×™×”:** ××¦×‘ ×—×™×¨×•×! ×¡×›× ×ª ×¡×¤×¡×™×¡.
**×˜×™×¤×•×œ:** ×× ×˜×™×‘×™×•×˜×™×§×” ×¨×—×‘×ª ×˜×•×•×— (×›×•×œ×œ ×¤×¡××•×“×•××•× ×¡) ×ª×•×š ×©×¢×”!""", "image": ""},
            "TLS (×¤×™×¨×•×§ ×’×™×“×•×œ)": {
                "text": """## Tumor Lysis Syndrome
**××¢×‘×“×”:** ×”×™×¤×¨×§×œ××™×”, ×”×™×¤×¨-××•×¨×™×¦××™×”, ×”×™×¤×•×§×œ×¦××™×”.
**×˜×™×¤×•×œ:** ×”×™×“×¨×¦×™×” (×‘×œ×™ ××©×œ×’×Ÿ!), Rasburicase (**××¡×•×¨ ×‘-G6PD!**).""", "image": ""},
            "××ª×Ÿ ××•×¦×¨×™ ×“×": {
                "text": """## ××•×¦×¨×™ ×“×
**PC:** ××™× ×•×Ÿ 10-15 ×"×œ/×§"×’. ×—×•×‘×” ×¤×™×œ×˜×¨.
**×˜×¡×™×•×ª:** 5-10 ×"×œ/×§"×’. **××¡×•×¨ ×‘××©××‘×” (IVAC)!** (×”×¨×¡ ××›×× ×™). ×œ×ª×ª ×‘×’×¨×‘×™×˜×¦×™×”.
**×”×§×¨× ×”:** ×—×•×‘×” ×‘××“×•×›××™ ×—×™×¡×•×Ÿ.""", "image": ""}
        }
    },
    "ğŸ ×’×¡×˜×¨×• ×•××˜×‘×•×œ×™": {
        "icon": "ğŸ",
        "description": "TPN, DKA, ×›×‘×“.",
        "topics": {
            "DKA": {
                "text": """## DKA (×—××¦×ª ×¡×•×›×¨×ª×™×ª)
**×˜×™×¤×•×œ:**
1. × ×•×–×œ×™× (×‘×–×”×™×¨×•×ª, ×œ× ×‘×•×œ×•×¡ ××œ× ×× ×‘×©×•×§).
2. ××™× ×¡×•×œ×™×Ÿ ×“×¨×™×¤ (×¨×§ ××—×¨×™ ×©×¢×” × ×•×–×œ×™×). ××¡×•×¨ ×‘×•×œ×•×¡!
3. ×ª×•×¡×¤×ª ××©×œ×’×Ÿ.""", "image": ""},
            "TPN": {
                "text": """## TPN
**×¡×™×‘×•×›×™×:** ×–×™×”×•× ×¦× ×ª×¨, Refeeding Syndrome (× ×¤×™×œ×ª ××œ×—×™×).""", "image": ""},
            "××™ ×¡×¤×™×§×ª ×›×‘×“": {
                "text": """## ×›×©×œ ×›×‘×“×™
**×¡×™×× ×™×:** ×¦×”×‘×ª, INR ×’×‘×•×”, ×××•× ×™×” ×’×‘×•×”×”.
**×˜×™×¤×•×œ:** ×•×™×˜××™×Ÿ K, ×¤×œ×–××”, ×× ×™×¢×ª ×‘×¦×§×ª ××•×—×™×ª.""", "image": ""}
        }
    }
}
# ××™×–×•×’ ×××’×¨×™ ×”×ª×•×›×Ÿ ×œ××‘× ×” ××—×™×“
FULL_DB = {**MEDICAL_DB}
if 'DRUGS_DB' in globals():
    drugs_topics = DRUGS_DB.get("topics", DRUGS_DB) if isinstance(DRUGS_DB, dict) else {}
    FULL_DB["ğŸ’Š ×ª×¨×•×¤×•×ª ×•×¤×¨××§×•×œ×•×’×™×”"] = {
        "icon": "ğŸ’Š",
        "description": "×××’×¨ ×ª×¨×•×¤×•×ª ×•×¤×¨××§×•×œ×•×’×™×”.",
        "topics": drugs_topics
    }
# ==============================================================================
# ×—×œ×§ 5: ×××’×¨ ×©××œ×•×ª + ××—×©×‘×•× ×™×
# ==============================================================================

ALL_QUESTIONS = [
    {"q": "××™× ×•×Ÿ ××“×¨× ×œ×™×Ÿ IV ×‘×”×—×™×™××”?", "opts": ["0.01 ×\"×’/×§\"×’", "0.1 ×\"×’/×§\"×’", "1 ×\"×’/×§\"×’", "0.5 ×\"×’"], "a": "0.01 ×\"×’/×§\"×’", "exp": "×“×™×œ×•×œ 1:10,000."},
    {"q": "×‘××” ××“×œ×œ×™× ×¤× ×™×˜×•××™×Ÿ?", "opts": ["×¡×œ×™×™×Ÿ (NS)", "×’×œ×•×§×•×– 5%", "××™×", "×”×¨×˜××Ÿ"], "a": "×¡×œ×™×™×Ÿ (NS)", "exp": "×©×•×§×¢ ×‘×’×œ×•×§×•×–."},
    {"q": "×˜×™×¤×•×œ ×¨××©×•×Ÿ ×‘×× ×¤×™×œ×§×¡×™×¡?", "opts": ["××“×¨× ×œ×™×Ÿ IM", "×¡×˜×¨×•××™×“×™×", "×•× ×˜×•×œ×™×Ÿ", "×× ×˜×™×‘×™×•×˜×™×§×”"], "a": "××“×¨× ×œ×™×Ÿ IM", "exp": "××¦×™×œ ×—×™×™×."},
    {"q": "×ª×¨×•×¤×” ××¡×•×¨×” ×‘-TLS ×¢× G6PD?", "opts": ["Rasburicase", "Allopurinol", "Furosemide", "Calcium"], "a": "Rasburicase", "exp": "×’×•×¨××ª ×œ×”××•×œ×™×–×”."},
    {"q": "×˜×™×¤×•×œ ××™×™×“×™ ×‘×”×¨× ×™××¦×™×” ××•×—×™×ª?", "opts": ["×¡×œ×™×™×Ÿ ×”×™×¤×¨×˜×•× ×™ 3%", "×”×•×¨×“×ª ×¨××©", "××ª×Ÿ × ×•×–×œ×™×", "×—×™××•×"], "a": "×¡×œ×™×™×Ÿ ×”×™×¤×¨×˜×•× ×™ 3%", "exp": "××•×¨×™×“ ICP."},
    {"q": "× ×•×¡×—×ª ×¤×¨×§×œ× ×“ ×œ×›×•×•×™×•×ª:", "opts": ["4 ×\"×œ * ×§\"×’ * % ×›×•×•×™×”", "2 ×\"×œ * ×§\"×’", "100 ×\"×œ/×§\"×’", "×œ×¤×™ ×’×™×œ"], "a": "4 ×\"×œ * ×§\"×’ * % ×›×•×•×™×”", "exp": "× ×•×–×œ×™× ×œ-24 ×©×¢×•×ª."},
    {"q": "××“×•×¢ ××¡×•×¨ ×œ×ª×ª ×˜×¡×™×•×ª ×‘××©××‘×” (IVAC)?", "opts": ["×”×¨×¡ ××›×× ×™", "×–×™×”×•×", "××”×™×¨ ××“×™", "×§×¨×™×©×”"], "a": "×”×¨×¡ ××›×× ×™", "exp": "×™×© ×œ×ª×ª ×‘×’×¨×‘×™×˜×¦×™×”."},
    {"q": "×¡×™××Ÿ ×œ-Diabetes Insipidus:", "opts": ["×©×ª×Ÿ ××¨×•×‘×”, ×”×™×¤×¨× ×ª×¨××™×”", "××™×¢×•×˜ ×©×ª×Ÿ, ×”×™×¤×•× ×ª×¨××™×”", "×¡×•×›×¨ ×’×‘×•×”", "×—×•×"], "a": "×©×ª×Ÿ ××¨×•×‘×”, ×”×™×¤×¨× ×ª×¨××™×”", "exp": "×—×¡×¨ ADH."}
]

# ××—×©×‘×•× ×™×
def calc_parkland(weight, bsa):
    total = 4 * weight * bsa
    return f"×¡×”\"×› ×œ-24 ×©×¢×•×ª: {total} ×\"×œ. (8 ×©×¢×•×ª ×¨××©×•× ×•×ª: {total/2} ×\"×œ)"

def calc_ett(age):
    uncuffed = (age / 4) + 4
    cuffed = (age / 4) + 3.5
    return f"Uncuffed: {uncuffed} | Cuffed: {cuffed}"

def calc_glucose(weight):
    return f"×‘×•×œ×•×¡ D10W (2-5 ×\"×œ/×§\"×’): {weight*2} - {weight*5} ×\"×œ."
    # ==============================================================================
# ×—×œ×§ 6: ×× ×•×¢ ×¡×™××•×œ×˜×•×¨
# ==============================================================================

class SimEngine:
    def __init__(self):
        self.reset()
    def reset(self):
        self.step = 0
        self.score = 100
        self.log = []
        self.dead = False
        # 5 ×ª×¨×—×™×©×™× ×œ×¤×—×•×ª - × ×©×ª××© ×‘-1 ××•×¨×›×‘ ×©×œ 10 ×©×œ×‘×™× ×œ×“×•×’××”
        self.data = [
            ("×™×œ×“ ×‘×Ÿ 4, ×”×’×™×¢ ×¢× ×—×•× ×•×§×•×¦×¨ × ×©×™××”. ×‘×‘×“×™×§×”: ×—×™×•×•×¨, ××™×œ×•×™ ×§×¤×™×œ×¨×™ 4 ×©× ×™×•×ª. ×“×•×¤×§ 160.",
             {"HR": 160, "BP": "90/50", "Sat": "92%"},
             [("×—××¦×Ÿ, ×•×¨×™×“, × ×•×–×œ×™× 20 ×\"×œ/×§\"×’", 10, "âœ… ×”×ª×—×œ×” ××¦×•×™× ×ª."), ("××§××•×œ ×•× ×™×˜×•×¨", -10, "âš ï¸ ×œ× ××¡×¤×™×§."), ("××™× ×˜×•×‘×¦×™×” ××™×™×“×™×ª", -30, "ğŸ’€ ××¡×•×›×Ÿ!"), ("×× ×˜×™×‘×™×•×˜×™×§×” ×‘×œ×‘×“", -5, "âš ï¸ ×¦×¨×™×š ×’× × ×•×–×œ×™×.")]),
            ("××—×¨×™ ×‘×•×œ×•×¡: ×“×•×¤×§ 150. ×œ\"×“ ×™×¨×“ ×œ-80/40. ×”×›×¨×” ×™×¨×•×“×”. ×œ×§×˜×˜ 4.5.",
             {"HR": 150, "BP": "80/40", "Sat": "93%"},
             [("×‘×•×œ×•×¡ × ×•×¡×£ + ×× ×˜×™×‘×™×•×˜×™×§×”", 10, "âœ… ×˜×™×¤×•×œ × ×›×•×Ÿ ×‘×¡×¤×¡×™×¡."), ("×¤×•×¡×™×“", -50, "ğŸ’€ ×™×”×¨×•×’ ××•×ª×•!"), ("CT ×¨××©", -20, "âŒ ×œ× ×™×¦×™×‘."), ("×¨×§ ×× ×˜×™×‘×™×•×˜×™×§×”", -5, "âš ï¸ ×¦×¨×™×š ×¢×•×“ × ×¤×—.")]),
            ("× ×©×™××” ×××•××¦×ª (60 ×œ×“×§×”). ×¡×˜×•×¨×¦×™×” 88% ×¢× ×—××¦×Ÿ. × ×¨××” ×ª×©×•×©.",
             {"HR": 160, "BP": "75/35", "Sat": "88%"},
             [("××™× ×˜×•×‘×¦×™×” (RSI) ×¢× ×§×˜××™×Ÿ", 10, "âœ… ××™× ×“×™×§×¦×™×” ×œ×”× ×©××”."), ("××™× ×˜×•×‘×¦×™×” ×¢× ×¤×¨×•×¤×•×¤×•×œ", -40, "ğŸ’€ ×™×¤×™×œ ×œ\"×“."), ("×•× ×˜×•×œ×™×Ÿ", -10, "âŒ ×œ× ×™×¢×–×•×¨."), ("×”×’×‘×¨×ª ×—××¦×Ÿ", -10, "âŒ ×œ× ××¡×¤×™×§.")]),
            ("××™×“ ××—×¨×™ ××™× ×˜×•×‘×¦×™×”, ×œ\"×“ ×¦×•× ×— ×œ-50/30. ×“×•×¤×§ ×¢×•×œ×”.",
             {"HR": 190, "BP": "50/30", "Sat": "98%"},
             [("×“×¨×™×¤ ××“×¨× ×œ×™×Ÿ/× ×•×¨××“×¨× ×œ×™×Ÿ", 10, "âœ… ×ª××™×›×” ××™× ×•×˜×¨×•×¤×™×ª."), ("×¢×•×“ ××™×“×–×•×œ×", -20, "âŒ ×™×—××™×¨ × ×¤×™×œ×”."), ("××§×¡×˜×•×‘×¦×™×”", -50, "ğŸ’€ ××¡×•×¨!"), ("×¨×§ × ×•×–×œ×™×", 0, "âš ï¸ ××•×œ×™ ×™×¢×–×•×¨.")]),
            ("×“×•× ×œ×‘! ××¡×™×¡×˜×•×œ×” ×‘××•× ×™×˜×•×¨.",
             {"HR": 0, "BP": "0/0", "Sat": "0%"},
             [("×¢×™×¡×•×™×™× + ××“×¨× ×œ×™×Ÿ", 10, "âœ… PALS."), ("×©×•×§ ×—×©××œ×™", -20, "âŒ ××¡×•×¨ ×‘××¡×™×¡×˜×•×œ×”."), ("××˜×¨×•×¤×™×Ÿ", -10, "âŒ ×œ× ×‘×¤×¨×•×˜×•×§×•×œ."), ("×‘×“×™×§×ª ×“×•×¤×§ ×“×§×”", -30, "ğŸ’€ ×‘×–×‘×•×– ×–××Ÿ.")]),
            ("×—×–×¨ ×“×•×¤×§ (ROSC). ×œ\"×“ 70/40.",
             {"HR": 150, "BP": "70/40", "Sat": "95%"},
             [("×™×™×¦×•×‘: ×××™× ×™×, ×¡×“×¦×™×”", 10, "âœ… Post-arrest care."), ("××ª×Ÿ ×‘×™×§×¨×‘×•× ×˜", 0, "âš ï¸ ×¨×§ ×× ×™×© ×—××¦×ª."), ("×”×¤×¡×§×ª ×ª×¨×•×¤×•×ª", -20, "âŒ ××¡×•×›×Ÿ."), ("××§×¡×˜×•×‘×¦×™×”", -50, "ğŸ’€ ×œ×.")]),
            ("×—×•× 39. ×¤×¨×›×•×¡ ×›×œ×œ×™ ×§×¦×¨.",
             {"HR": 140, "BP": "85/50", "Sat": "96%"},
             [("×”×¢××¡×ª ×¤× ×™×˜×•××™×Ÿ/×§×¤×¨×”", 10, "âœ… ×× ×™×¢×ª ×¤×¨×›×•×¡×™×."), ("×¢×•×“ ××“×¨× ×œ×™×Ÿ", -20, "âŒ ×”×¤×¨×¢×•×ª ×§×¦×‘."), ("×”×ª×¢×œ××•×ª", -30, "âŒ × ×–×§ ××•×—×™."), ("××ª×Ÿ ×¡×•×›×¨", 0, "âš ï¸ ×¨×§ ×‘×”×™×¤×•×’×œ×™×§××™×”.")]),
            ("×‘×“×™×§×•×ª ×“×: ×”×™×¤×•×§×œ××™×” (2.8). ××’× ×–×™×•× × ××•×š.",
             {"HR": 130, "BP": "90/60", "Sat": "98%"},
             [("×ª×™×§×•×Ÿ ××’× ×–×™×•× ×•××– ××©×œ×’×Ÿ", 10, "âœ… × ×›×•×Ÿ."), ("×¨×§ ××©×œ×’×Ÿ", -10, "âŒ ×œ× ×™×¢×œ×” ×‘×œ×™ ××’× ×–×™×•×."), ("××©×œ×’×Ÿ ×‘×•×œ×•×¡ ××”×™×¨", -50, "ğŸ’€ ×“×•× ×œ×‘!"), ("×¤×•×¡×™×“", -10, "âŒ ×™×—××™×¨.")]),
            ("×©×ª×Ÿ ×›×”×” ×•××•×¢×˜. ×§×¨×™××˜×™× ×™×Ÿ ×¢×•×œ×” (AKI).",
             {"HR": 120, "BP": "95/65", "Sat": "99%"},
             [("×”×’×‘×œ×ª × ×•×–×œ×™× ×•×××–×Ÿ", 10, "âœ… ×× ×™×¢×ª ×’×•×“×©."), ("×”×¢××¡×ª × ×•×–×œ×™×", -20, "âŒ ×‘×¦×§×ª ×¨×™××•×ª."), ("×“×™××œ×™×–×” ××™×“", -10, "âš ï¸ ××•×§×“× ××“×™."), ("××ª×Ÿ ××©×œ×’×Ÿ", -30, "ğŸ’€ ××¡×•×›×Ÿ.")]),
            ("×¡×™×•×: ×”×™×œ×“ ×™×¦×™×‘, ××•× ×©×.",
             {"HR": 110, "BP": "100/70", "Sat": "100%"},
             [("×”××©×š ××¢×§×‘ ×•×˜×™×¤×•×œ", 10, "âœ… ×¡×™×™××ª ×‘×”×¦×œ×—×”."), ("-", 0, ""), ("-", 0, ""), ("-", 0, "")] )
        ]

if 'sim' not in st.session_state: st.session_state.sim = SimEngine()
    # ==============================================================================
# ×—×œ×§ 7: ×××©×§ ××©×ª××© ×•× ×™×•×•×˜
# ==============================================================================

if 'user_info' not in st.session_state: st.session_state.user_info = {}
if 'completed' not in st.session_state: st.session_state.completed = set()
if 'page' not in st.session_state: st.session_state.page = "home"

def nav(p): st.session_state.page = p; st.rerun()

# Sidebar
with st.sidebar:
    st.image("https://img.icons8.com/color/96/nurse-male--v1.png", width=80)
    if not st.session_state.user_info:
        name = st.text_input("×©×")
        email = st.text_input("××™×™×œ")
        if st.button("×›× ×¡"):
            if email: st.session_state.user_info = {"n": name, "e": email}; st.rerun()
    else:
        st.success(f"×©×œ×•× {st.session_state.user_info['n']}")
        if st.button("×™×¦×™××”"): st.session_state.user_info = {}; st.rerun()
    st.markdown("---")
    if st.session_state.user_info:
        st.button("ğŸ  ×‘×™×ª", on_click=lambda: nav("home"))
        st.button("ğŸ“š ×œ××™×“×”", on_click=lambda: nav("learn"))
        st.button("ğŸ§® ××—×©×‘×•× ×™×", on_click=lambda: nav("calc"))
        st.button("ğŸš‘ ×¡×™××•×œ×˜×•×¨", on_click=lambda: nav("sim"))
        st.button("ğŸ“ ××‘×—×Ÿ", on_click=lambda: nav("quiz"))
        if st.session_state.user_info.get('e') == 'yishaycopp@gmail.com':
            st.button("âš™ï¸ × ×™×”×•×œ", on_click=lambda: nav("admin"))

# Pages Logic
if not st.session_state.user_info:
    st.title("PICU Pro")
    st.info("×× × ×”×ª×—×‘×¨.")
    st.stop()

if st.session_state.page == "home":
    st.markdown("<h1 style='text-align:center; color:#1565c0;'>××¨×›×– ×™×“×¢ ×•×¡×™××•×œ×¦×™×”</h1>", unsafe_allow_html=True)
    c1, c2, c3 = st.columns(3)
    with c1:
        st.markdown("<div class='nav-card'><div class='nav-icon'>ğŸ’Š</div><div>×ª×¨×•×¤×•×ª</div></div>", unsafe_allow_html=True)
        if st.button("×¤×ª×— ×ª×¨×•×¤×•×ª"): st.session_state.cat_filter = "ğŸ’Š ×ª×¨×•×¤×•×ª ×•×¤×¨××§×•×œ×•×’×™×”"; nav("learn")
    with c2:
        st.markdown("<div class='nav-card'><div class='nav-icon'>ğŸš‘</div><div>×—×™×¨×•×</div></div>", unsafe_allow_html=True)
        if st.button("×¤×ª×— ×—×™×¨×•×"): st.session_state.cat_filter = "ğŸš‘ ××¦×‘×™ ×—×™×¨×•× ×•×”×—×™×™××”"; nav("learn")
    with c3:
        st.markdown("<div class='nav-card'><div class='nav-icon'>ğŸ§ </div><div>× ×•×™×¨×•×œ×•×’×™×”</div></div>", unsafe_allow_html=True)
        if st.button("×¤×ª×— × ×•×™×¨×•×œ×•×’×™×”"): st.session_state.cat_filter = "ğŸ§  × ×•×™×¨×•×œ×•×’×™×”"; nav("learn")
    
    c4, c5 = st.columns(2)
    with c4:
        st.markdown("<div class='nav-card'><div class='nav-icon'>ğŸ©¸</div><div>×”××˜×•×œ×•×’×™×”</div></div>", unsafe_allow_html=True)
        if st.button("×¤×ª×— ×”××˜×•×œ×•×’×™×”"): st.session_state.cat_filter = "ğŸ©¸ ×”××˜×•-××•× ×§×•×œ×•×’×™×”"; nav("learn")
    with c5:
        st.markdown("<div class='nav-card'><div class='nav-icon'>ğŸ</div><div>×’×¡×˜×¨×•</div></div>", unsafe_allow_html=True)
        if st.button("×¤×ª×— ×’×¡×˜×¨×•"): st.session_state.cat_filter = "ğŸ ×’×¡×˜×¨×• ×•××˜×‘×•×œ×™"; nav("learn")

elif st.session_state.page == "learn":
    st.title("×¡×¤×¨×™×™×” ××§×¦×•×¢×™×ª")
    # ××™×–×•×’ ×©× ×™ ×”-DB
    cats = list(FULL_DB.keys())
    if 'DRUGS_DB' in globals() and "ğŸ’Š ×ª×¨×•×¤×•×ª ×•×¤×¨××§×•×œ×•×’×™×”" not in cats: cats.append("ğŸ’Š ×ª×¨×•×¤×•×ª ×•×¤×¨××§×•×œ×•×’×™×”") # ×× ×”×©×ª××©× ×• ×‘×–×” ×‘× ×¤×¨×“
    
    idx = 0
    if st.session_state.get('cat_filter') in cats: idx = cats.index(st.session_state.cat_filter)
    cat = st.selectbox("×ª×—×•×:", cats, index=idx)
    
    # ×‘×“×™×§×” ××™×¤×” ×”×“××˜×” × ××¦×
    data_source = FULL_DB
    if cat == "ğŸ’Š ×ª×¨×•×¤×•×ª ×•×¤×¨××§×•×œ×•×’×™×”" and cat in FULL_DB:
        data_source = {cat: FULL_DB[cat]} # ×ª×™×§×•×Ÿ ×œ××™×–×•×’
    
    if "×ª×¨×•×¤×•×ª" in cat:
        drugs = sorted(data_source[cat]['topics'].keys())
        choice = st.selectbox("×‘×—×¨ ×ª×¨×•×¤×” (×-×ª):", drugs)
        data = data_source[cat]['topics'][choice]
    else:
        topics = list(data_source[cat]['topics'].keys())
        cols = st.columns(3)
        for i, t in enumerate(topics):
            icon = "âœ…" if t in st.session_state.completed else "â­•"
            if cols[i%3].button(f"{icon} {t}"): st.session_state.curr_topic = t
        choice = st.session_state.get('curr_topic', topics[0])
        data = data_source[cat]['topics'][choice]
        
    st.markdown("<div class='content-box'>", unsafe_allow_html=True)
    st.markdown(render_clean_html(data['text']), unsafe_allow_html=True)
    if data.get('image'): st.image(data['image'], width=400)
    st.markdown("</div>", unsafe_allow_html=True)
    if st.checkbox(f"×¡×™×™××ª×™ ×œ×œ××•×“: {choice}", key=choice): st.session_state.completed.add(choice)

elif st.session_state.page == "calc":
    st.title("××—×©×‘×•× ×™×")
    t1, t2, t3 = st.tabs(["×›×•×•×™×•×ª", "×˜×•×‘×•×¡", "×’×œ×•×§×•×–"])
    with t1:
        w = st.number_input("××©×§×œ (×§\"×’)", 3.0, 100.0, 10.0)
        bsa = st.number_input("% ×›×•×•×™×”", 1.0, 100.0, 10.0)
        st.success(calc_parkland(w, bsa))
    with t2:
        age = st.number_input("×’×™×œ", 0.0, 18.0, 5.0)
        st.info(calc_ett(age))
    with t3:
        w2 = st.number_input("××©×§×œ", 3.0, 100.0, 10.0, key="g")
        st.warning(calc_glucose(w2))

elif st.session_state.page == "sim":
    st.title("×¡×™××•×œ×˜×•×¨")
    s = st.session_state.sim
    if st.button("×”×ª×—×œ ××—×“×©"): s.reset(); st.rerun()
    
    if s.step < len(s.data):
        d = s.data[s.step]
        st.markdown(f"""<div class='sim-monitor'>
            <div>HR: <span class='sim-val'>{d[1]['HR']}</span></div>
            <div>BP: <span class='sim-val'>{d[1]['BP']}</span></div>
            <div>SAT: <span class='sim-val'>{d[1]['Sat']}</span></div>
        </div>""", unsafe_allow_html=True)
        st.info(d[0])
        cols = st.columns(2)
        opts = d[2]
        shuffled = random.sample(opts, len(opts))
        for i, opt in enumerate(shuffled):
            if cols[i%2].button(opt[0], key=f"o{s.step}{i}"):
                s.score += opt[1]
                s.log.append(f"×©×œ×‘ {s.step+1}: {opt[2]}")
                if opt[1] <= -30: s.dead = True
                s.step += 1
                st.rerun()
    else:
        if s.dead: st.error("ğŸ’€ ×”××˜×•×¤×œ ×§×¨×¡.")
        else: st.success(f"ğŸ‰ ×¡×™×™××ª! ×¦×™×•×Ÿ: {s.score}")
        for l in s.log: st.write(l)

elif st.session_state.page == "quiz":
    st.title("××‘×—×Ÿ ×™×“×¢")
    num = st.number_input("××¡×¤×¨ ×©××œ×•×ª:", 1, len(ALL_QUESTIONS), 5)
    if st.button("×¦×•×¨ ××‘×—×Ÿ"):
        st.session_state.q_curr = random.sample(ALL_QUESTIONS, num)
        st.session_state.q_res = None
        
    if 'q_curr' in st.session_state:
        score = 0
        with st.form("qf"):
            for i, q in enumerate(st.session_state.q_curr):
                st.write(f"**{i+1}. {q['q']}**")
                ops = q['opts'].copy()
                random.shuffle(ops)
                sel = st.radio(f"×ª×©×•×‘×” {i}", ops, key=f"q{i}", label_visibility="collapsed")
                if sel == q['a']: score += 1
                st.markdown("---")
            if st.form_submit_button("×”×’×©"):
                st.session_state.q_res = score
                
        if st.session_state.q_res is not None:
            st.metric("×¦×™×•×Ÿ", f"{int(st.session_state.q_res/len(st.session_state.q_curr)*100)}%")
            for i, q in enumerate(st.session_state.q_curr):
                with st.expander(f"×”×¡×‘×¨ ×œ×©××œ×” {i+1}"):
                    st.info(f"×ª×©×•×‘×”: {q['a']}")
                    st.write(q['exp'])

elif st.session_state.page == "admin":
    st.title("× ×™×”×•×œ")
    st.info("× ×™×ª×Ÿ ×œ×”×“×‘×™×§ ×›××Ÿ ×˜×§×¡×˜ ××• ×œ×”×¢×œ×•×ª ×§×•×‘×¥ ×ª×•×›×Ÿ (txt/md) ×•××¡×“×¨ ××•×ª×• ×‘×“×£ ×‘×”×ª××.")
    uploaded = st.file_uploader("×”×¢×œ×” ×§×•×‘×¥ ×˜×§×¡×˜/Markdown", type=["txt", "md"])
    pasted = st.text_area("××• ×”×“×‘×§ ×›××Ÿ ×˜×§×¡×˜ ×—×•×¤×©×™")
    
    file_content = ""
    if uploaded:
        raw = uploaded.getvalue()
        try:
            file_content = raw.decode("utf-8")
        except UnicodeDecodeError:
            st.warning("×œ× × ×™×ª×Ÿ ×œ×¤×¢× ×— ××ª ×”×§×•×‘×¥ ×‘-UTF-8, ××•×¦×’ ×¢× ×”×—×œ×¤×ª ×ª×•×•×™× ×‘×¢×™×™×ª×™×™×.")
            file_content = raw.decode("utf-8", errors="replace")
    
    if st.button("×˜×¢×Ÿ ×œ×ª×¦×•×’×”"):
        content = file_content.strip() or pasted.strip()
        if content:
            st.session_state["admin_preview"] = content
            st.success("×§×™×‘×œ×ª×™ ××ª ×”×ª×•×›×Ÿ. ×ª×¦×•×’×” ××§×“×™××” ××•×¤×™×¢×” ×œ××˜×”.")
        else:
            st.warning("×™×© ×œ×”×“×‘×™×§ ×˜×§×¡×˜ ××• ×œ×‘×—×•×¨ ×§×•×‘×¥.")
    
    if st.session_state.get("admin_preview"):
        st.subheader("×ª×¦×•×’×” ××§×“×™××”")
        st.markdown(render_clean_html(st.session_state["admin_preview"], sanitize=True), unsafe_allow_html=True)
