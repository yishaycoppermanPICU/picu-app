import streamlit as st
import random
import json
import os
import time

# --- ×”×’×“×¨×ª ×§×•×‘×¥ × ×ª×•× ×™× (Persistence) ---
DB_FILE = "picu_full_db.json"

# --- ×ª×•×›×Ÿ ××œ×: ××‘×•×¡×¡ ×¢×œ ×”×§×‘×¦×™× ×©×œ×š (×”×¢×ª×§ ××œ×) ---
# ×”×¢×¨×”: ×–×”×• ×‘×¡×™×¡ ×”× ×ª×•× ×™× ×”×¨××©×•× ×™. ×›×œ ×©×™× ×•×™ ×‘× ×™×”×•×œ ×™×™×©××¨ ××¢×œ×™×•.
DEFAULT_CONTENT = {
    "××¦×‘×™ ×—×™×¨×•× ×•×”×—×™×™××”": {
        "icon": "ğŸš¨",
        "description": "×¤×¨×•×˜×•×§×•×œ×™ ×”×—×™×™××” (PALS), ×©×•×§, ×¡×¤×¡×™×¡ ×•×˜×¨××•××”.",
        "topics": {
            "×©×•×§ ×”×™×¤×•×•×œ××™ (Hypovolemic)": {
                "text": """## ×©×•×§ ×”×™×¤×•×•×œ××™ / ×”××•×¨×’×™
**×”×’×“×¨×”:** ××¦×‘ ×¤×ª×•×¤×™×–×™×•×œ×•×’×™ ×“×™× ××™ ×•×œ× ×™×¦×™×‘ ×”×××•×¤×™×™×Ÿ ×‘×¤×¨×¤×•×–×™×” ×œ×§×•×™×” ×œ×¨×§××•×ª.

### ×’×•×¨××™×:
×”×ª×™×™×‘×©×•×ª, ×”×§××•×ª, ×“×™××•×, ×”×©×ª× ×” ××¨×•×‘×” (DKA), ×“×œ×™×¤×” ×§×¤×™×œ×¨×™×ª (×›×•×•×™×•×ª, ×¡×¤×¡×™×¡).

### ×¡×™×× ×™× ×§×œ×™× ×™×™× ×œ×¤×™ ×©×œ×‘×™×:
1.  **×©×œ×‘ 1 (×¤×™×¦×•×™):** ×œ"×“ ×ª×§×™×Ÿ, ××™×œ×•×™ ×§×¤×™×œ×¨×™ ×ª×§×™×Ÿ, ×“×•×¤×§ ×•× ×©×™××” ×¡×“×™×¨×™×, ××¦×‘ ×× ×˜×œ×™ ×ª×§×™×Ÿ.
2.  **×©×œ×‘ 2:** ×œ"×“ ×ª×§×™×Ÿ/× ××•×š, ××™×œ×•×™ ×§×¤×™×œ×¨×™ ××™×˜×™, ×–×™×¢×” ×§×¨×”, ×˜×›×™×§×¨×“×™×”, ×˜×›×™×¤× ×™××”, ×™×¨×™×“×” ×‘×›××•×ª ×©×ª×Ÿ.
3.  **×©×œ×‘ 3 (Decompensated):** ×œ"×“ ×¡×™×¡×˜×•×œ×™ ×¦×•× ×—, ××™×œ×•×™ ×§×¤×™×œ×¨×™ ××™×˜×™, ×©×™× ×•×™×™× ×‘××¦×‘ ×”×›×¨×”, ×¢×•×¨ ×—×™×•×•×¨ ×•×§×¨.
4.  **×©×œ×‘ 4:** ×œ"×“ ×™×¨×•×“ ×××•×“, ×—×•×¡×¨ ×”×›×¨×”/×§×•××”, ×œ×œ× ×©×ª×Ÿ, ×§×¨×™×¡×” ×§×¨×“×™×•×•×¡×§×•×œ×¨×™×ª.

### ×˜×™×¤×•×œ ×‘×—×™×¨×•×:
1.  **× ×ª×™×‘ ××•×•×™×¨:** ×—××¦×Ÿ 100%. ×‘×™×œ×“×™× ×œ× ×™×¦×™×‘×™× - ××™× ×˜×•×‘×¦×™×” (×¨×¦×•×™ ×§×˜××™×Ÿ).
2.  **×’×™×©×” ×•×¨×™×“×™×ª:** ×¨×¦×•×™ ×©× ×™ ×•× ×¤×œ×•× ×™× ×¢×‘×™× ××• IO.
3.  **× ×•×–×œ×™×:** ×‘×•×œ×•×¡ ×§×¨×™×¡×˜×œ×•××™×“×™× (×¡×œ×™×™×Ÿ/×”×¨×˜××Ÿ) **20 ×"×œ/×§"×’** ×ª×•×š 5-10 ×“×§×•×ª.
    * × ×™×ª×Ÿ ×œ×—×–×•×¨ ×¢×“ 3 ×¤×¢××™× (×¡×”"×› 60 ×"×œ/×§"×’).
    * ×©×™××•×© ×‘××›×©×™×¨×™ ×œ×—×¥ ××• ××–×¨×§×™× ×œ××ª×Ÿ ××”×™×¨.
4.  **×©×•×§ ×”××•×¨×’×™:** ×× ××™×Ÿ ×©×™×¤×•×¨ ×œ××—×¨ × ×•×–×œ×™× -> ××ª×Ÿ ×“× (PC) ×œ×¤×™ 10 ×"×œ/×§"×’.
5.  **×™×¢×“×™×:** ××™×œ×•×™ ×§×¤×™×œ×¨×™ < 2 ×©× ×™×•×ª, ×ª×¤×•×§×ª ×©×ª×Ÿ > 1 ×"×œ/×§"×’/×©×¢×”, ×œ"×“ ×ª×§×™×Ÿ ×œ×’×™×œ.""",
                "image": "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1d/Capillary_refill.gif/220px-Capillary_refill.gif"
            },
            "×¡×¤×¡×™×¡ (Sepsis)": {
                "text": """## ×¡×¤×¡×™×¡ ×•×©×•×§ ×¡×¤×˜×™
**×”×’×“×¨×”:** ×–×™×”×•× ×—×©×•×“ ××• ×××•××ª + SIRS (×—×•×, ×˜×›×™×§×¨×“×™×”, ×˜×›×™×¤× ×™××”, ×œ×•×™×§×•×¦×™×˜×•×–×™×¡).

### ×“×¨×’×•×ª ×—×•××¨×”:
* **Sepsis:** ×–×™×”×•× + SIRS.
* **Severe Sepsis:** ×¡×¤×¡×™×¡ + ×›×©×œ ××™×‘×¨×™× (ARDS, ×˜×¨×•××‘×•×¦×™×˜×•×¤× ×™×”, ×¢×œ×™×™×ª ×§×¨×™××˜×™× ×™×Ÿ).
* **Septic Shock:** ×¡×¤×¡×™×¡ + ×ª×ª ×œ×—×¥ ×“× ×©××™× ×• ××’×™×‘ ×œ× ×•×–×œ×™×.

### "×—×‘×™×œ×ª ×”×˜×™×¤×•×œ" ×‘×©×¢×” ×”×¨××©×•× ×” (Golden Hour):
1.  **×’×™×©×” ×•×¨×™×“×™×ª/IO:** ×ª×•×š ×“×§×•×ª.
2.  **×ª×¨×‘×™×•×ª ×“×:** ×œ×¤× ×™ ×× ×˜×™×‘×™×•×˜×™×§×” (××œ× ×× ××¢×›×‘ ××©××¢×•×ª×™×ª).
3.  **×× ×˜×™×‘×™×•×˜×™×§×”:** ×¨×—×‘×ª ×˜×•×•×— (×œ××©×œ Meropenem 20mg/kg) - **×—×•×‘×” ×ª×•×š ×©×¢×”!**
4.  **× ×•×–×œ×™×:** ×‘×•×œ×•×¡ 20 ×"×œ/×§"×’ (×¢×“ 60 ×"×œ/×§"×’) ×ª×•×š × ×™×˜×•×¨ ×¢×•××¡ (×›×‘×“, ×¨×™××•×ª).
5.  **×‘×“×™×§×ª ×œ×§×˜×˜:** ××“×“ ×œ×¤×¨×¤×•×–×™×”.

### ×˜×™×¤×•×œ ×‘×©×•×§ ×¢××™×“ (Refractory):
* ×× ××™×Ÿ ×ª×’×•×‘×” ×œ× ×•×–×œ×™× (60 ×"×œ/×§"×’) -> ×”×ª×—×œ×ª ×××™× ×™×.
* **×©×•×§ ×§×¨ (Cold Shock):** ×¤×¨×¤×•×–×™×” ×™×¨×•×“×” -> **××“×¨× ×œ×™×Ÿ** (0.05-0.3 mcg/kg/min).
* **×©×•×§ ×—× (Warm Shock):** ×“×¤×§×™× ×”×•×œ××™×, ×œ"×“ × ××•×š -> **× ×•×¨××“×¨× ×œ×™×Ÿ**.
* **×—×©×“ ×œ××™ ×¡×¤×™×§×ª ××“×¨× ×œ:** ×”×™×“×¨×•×§×•×¨×˜×™×–×•×Ÿ.""",
                "image": ""
            },
            "×× ×¤×™×œ×§×¡×™×¡ (Anaphylaxis)": {
                "text": """## ×× ×¤×™×œ×§×¡×™×¡
×ª×’×•×‘×” ××œ×¨×’×™×ª ×¡×™×¡×˜××™×ª ×•××¡×›× ×ª ×—×™×™×.
**×¡×™×× ×™×:** ××•×¨×˜×™×§×¨×™×”, ×× ×’×™×•××“××”, ×¡×˜×¨×™×“×•×¨, ×¦×¤×¦×•×¤×™×, ×”×§××•×ª, ×™×¨×™×“×ª ×œ"×“.

### ×˜×™×¤×•×œ ××™×™×“×™ (×§×• ×¨××©×•×Ÿ):
1.  **××“×¨× ×œ×™×Ÿ IM:** ×”×˜×™×¤×•×œ ×”××¦×™×œ ×—×™×™× ×”×™×—×™×“ ×‘×©×œ×‘ ×”××™×™×“×™!
    * **××™× ×•×Ÿ:** 0.01 ×"×’/×§"×’ (××§×¡' 0.5 ×"×’). ×¨×™×›×•×– 1:1,000.
    * **××™×§×•×:** ×™×¨×š (Vastus Lateralis).
    * **×—×–×¨×”:** ×›×œ 5-15 ×“×§×•×ª ×× ××™×Ÿ ×©×™×¤×•×¨.
2.  **×”×©×›×‘×”:** ×”×¨××ª ×¨×’×œ×™×™× ×œ×©×™×¤×•×¨ ×”×—×–×¨ ×•×¨×™×“×™.
3.  **×—××¦×Ÿ:** 100%.
4.  **× ×•×–×œ×™×:** 20 ×"×œ/×§"×’ ×‘×•×œ×•×¡ ××”×™×¨.

### ×˜×™×¤×•×œ ×§×• ×©× ×™:
* **×•× ×˜×•×œ×™×Ÿ:** ××™× ×”×œ×¦×™×” ×œ×‘×¨×•× ×›×•×¡×¤××–×.
* **×¡×˜×¨×•××™×“×™× (IV):** ×¡×•×œ×•××“×¨×•×œ 1-2 ×"×’/×§"×’ (×œ×× ×™×¢×ª ×ª×’×•×‘×” ×××•×—×¨×ª).
* **×× ×˜×™×”×™×¡×˜××™× ×™×:** ×¤× ×™×¡×˜×™×œ/×œ×•×¨×¡×˜×™×Ÿ.""",
                "image": ""
            }
        }
    },
    "×ª×¨×•×¤×•×ª ×•×¤×¨×•×˜×•×§×•×œ×™×": {
        "icon": "ğŸ’Š",
        "description": "××™× ×•× ×™×, ××•×¤× ×™ ××ª×Ÿ ×•×“×’×©×™ ×‘×˜×™×—×•×ª.",
        "topics": {
            "××“×¨× ×œ×™×Ÿ (Adrenaline)": {
                "text": """## ××“×¨× ×œ×™×Ÿ (Epinephrine)
**××™× ×“×™×§×¦×™×•×ª:** ×”×—×™×™××”, ×‘×¨×“×™×§×¨×“×™×” ×¡×™××¤×˜×•××˜×™×ª, ×× ×¤×™×œ×§×¡×™×¡, ×¡×˜×¨×™×“×•×¨.

### ××™× ×•× ×™× ×•×“×¨×š ××ª×Ÿ:
* **×”×—×™×™××” (IV/IO):**
    * ××™× ×•×Ÿ: **0.01 ×"×’/×§"×’** (0.1 ×"×œ/×§"×’ ××ª××™×¡×ª 1:10,000).
    * ××§×¡': 1 ×"×’.
    * ×ª×“×™×¨×•×ª: ×›×œ 3-5 ×“×§×•×ª.
* **×× ×¤×™×œ×§×¡×™×¡ (IM):**
    * ××™× ×•×Ÿ: **0.01 ×"×’/×§"×’** (××“×™×œ×•×œ 1:1,000).
    * ××§×¡': 0.5 ×"×’.
* **××™× ×”×œ×¦×™×” (×¡×˜×¨×™×“×•×¨):**
    * ××™× ×•×Ÿ: 0.5 ×"×œ/×§"×’ (××§×¡' 5 ×"×œ).
* **×“×¨×™×¤ ××ª××©×š:**
    * ×˜×•×•×—: 0.05 - 1.0 mcg/kg/min.""",
                "image": ""
            },
            "××“× ×•×–×™×Ÿ (SVT)": {
                "text": """## ××“× ×•×–×™×Ÿ (Adenosine)
**××™× ×“×™×§×¦×™×”:** SVT.

### ××•×¤×Ÿ ××ª×Ÿ (×§×¨×™×˜×™!):
×–××Ÿ ××—×¦×™×ª ×—×™×™× ×§×¦×¨ ×××•×“ (<10 ×©× ×™×•×ª). ×—×•×‘×” ×œ×ª×ª ×‘×©×™×˜×ª **Push-Flush**:
1.  ×”×–×¨×§×” ××”×™×¨×” ×‘×‘×¨×– ×”×›×™ ×§×¨×•×‘ ×œ×œ×‘.
2.  ××™×“ ×©×˜×™×¤×” ×‘×•×œ×•×¡ ×©×œ 5-10 ×"×œ ×¡×œ×™×™×Ÿ.

### ××™× ×•× ×™×:
1.  **×× ×” ×¨××©×•× ×”:** 0.1 ×"×’/×§"×’ (××§×¡' 6 ×"×’).
2.  **×× ×” ×©× ×™×”:** 0.2 ×"×’/×§"×’ (××§×¡' 12 ×"×’).
* ×ª×•×¤×¢×•×ª ×œ×•×•××™: ×ª×—×•×©×ª "×‘×¢×™×˜×”" ×‘×—×–×”, ×”×¡××§×”, ××¡×™×¡×˜×•×œ×” ×¨×’×¢×™×ª.""",
                "image": ""
            },
            "×ª×™×§×•×Ÿ ××œ×§×˜×¨×•×œ×™×˜×™×": {
                "text": """## ×ª×™×§×•×Ÿ ××©×œ×’×Ÿ ×•××’× ×–×™×•×
### ××©×œ×’×Ÿ (Potassium)
* **×¢×¨×›×™× ×ª×§×™× ×™×:** 3.5-5.0 mEq/L.
* **×—×•×§ ×—×©×•×‘:** ×”×™×¤×•××’× ×–××™×” ×’×•×¨××ª ×œ×”×™×¤×•×§×œ××™×” ×¢××™×“×” -> **×œ×ª×§×Ÿ ××’× ×–×™×•× ×§×•×“×!**
* **×§×¦×‘ ××ª×Ÿ IV:**
    * ×¤×¨×™×¤×¨×™: ××§×¡' 10 mEq/h.
    * ××¨×›×–×™: ××§×¡' 40 mEq/h (×ª×—×ª × ×™×˜×•×¨).

### ×”×™×¤×¨×§×œ××™×” (×˜×™×¤×•×œ ×—×™×¨×•×):
1.  **×§×œ×¦×™×•× ×’×œ×•×§×•× ×˜:** ×”×’× ×” ×¢×œ ×”×œ×‘ (×× ×™×¢×ª ×”×¤×¨×¢×•×ª ×§×¦×‘).
2.  **××™× ×¡×•×œ×™×Ÿ (0.1 ×™×—'/×§"×’) + ×’×œ×•×§×•×–:** ×”×›× ×¡×ª ××©×œ×’×Ÿ ×œ×ª××™×.
3.  **×•× ×˜×•×œ×™×Ÿ:** ××™× ×”×œ×¦×™×”.
4.  **×¤×•×¡×™×“:** ×¤×™× ×•×™ ×‘×©×ª×Ÿ.""",
                "image": ""
            }
        }
    },
    "×”××•×˜×•-××•× ×§×•×œ×•×’×™×”": {
        "icon": "ğŸ©¸",
        "description": "TLS, ×× ××™×”, ××•×¦×¨×™ ×“×.",
        "topics": {
            "Tumor Lysis Syndrome (TLS)": {
                "text": """## Tumor Lysis Syndrome (TLS)
××¦×‘ ×—×™×¨×•× ××•× ×§×•×œ×•×’×™ ×”× ×’×¨× ××¤×™×¨×•×§ ××¡×™×‘×™ ×©×œ ×ª××™ ×’×™×“×•×œ.
**×××¤×™×™× ×™×:** ×”×™×¤×¨××•×¨×™×¦××™×”, ×”×™×¤×¨×§×œ××™×”, ×”×™×¤×¨×¤×•×¡×¤×˜××™×” -> ×”×™×¤×•×§×œ×¦××™×”.

### ×¡×™×›×•× ×™×:
* ×¤×’×™×¢×” ×›×œ×™×™×ª×™×ª ×—×¨×™×¤×” (AKI) ×××©×§×¢×™ ×—×•××¦×” ××•×¨×™×ª/×¡×™×“×Ÿ-×–×¨×—×Ÿ.
* ×”×¤×¨×¢×•×ª ×§×¦×‘ ×•××•×•×ª (××”×™×¤×¨×§×œ××™×”).

### ×× ×™×¢×” ×•×˜×™×¤×•×œ:
1.  **×”×™×“×¨×¦×™×”:** ××’×¨×¡×™×‘×™×ª (×¤×™ 2-3 ××”×ª×—×–×•×§×”) ×œ×©×˜×™×¤×ª ×”×›×œ×™×•×ª.
2.  **××œ×•×¤×¨×™× ×•×œ:** ×× ×™×¢×ª ×™×™×¦×•×¨ ×—×•××¦×” ××•×¨×™×ª.
3.  **×¨×¡×‘×•×¨×™×§×– (Rasburicase):** ×¤×™×¨×•×§ ×—×•××¦×” ××•×¨×™×ª ×§×™×™××ª (×™×¢×™×œ ×™×•×ª×¨).
    * *×§×•× ×˜×¨××™× ×“×™×§×¦×™×”:* ×—×¡×¨ G6PD (×¡×›× ×ª ×”××•×œ×™×–×”).
4.  **×ª×™×§×•×Ÿ ××œ×§×˜×¨×•×œ×™×˜×™×:** ×˜×™×¤×•×œ ×‘×”×™×¤×¨×§×œ××™×”. ×”×™×¤×•×§×œ×¦××™×” ××ª×§× ×™× ×¨×§ ×× ×¡×™××¤×˜×•××˜×™×ª!""",
                "image": ""
            },
             "××ª×Ÿ ××•×¦×¨×™ ×“×": {
                "text": """## ××ª×Ÿ ××•×¦×¨×™ ×“×
### ×× ×ª ×“× (Packed Cells - PC)
* **××™× ×•×Ÿ:** 10-15 ×"×œ/×§"×’ (×œ×”×¢×œ××ª ×”××•×’×œ×•×‘×™×Ÿ ×‘-2-3 ×’×¨×).
* **×–××Ÿ ××ª×Ÿ:** ×©×¢×ª×™×™×-××¨×‘×¢ ×©×¢×•×ª (×‘×—×™×¨×•×: ×‘×•×œ×•×¡).
* **×“×’×©:** ×™×© ×œ×”×©×ª××© ×‘×¡×˜ ×¢× ×¤×™×œ×˜×¨.

### ×˜×¡×™×•×ª (Platelets)
* **××™× ×•×Ÿ:** 5-10 ×"×œ/×§"×’.
* **××™× ×“×™×§×¦×™×”:** ×˜×¨×•××‘×•×¦×™×˜×•×¤× ×™×” < 10,000 ××• ×“×™××•× ×¤×¢×™×œ.
* **×“×’×©:** ×œ× ×œ×ª×ª ×‘××©××‘×” (×”×•×¨×¡ ××ª ×”×˜×¡×™×•×ª), ××œ× ×‘×’×¨×‘×™×˜×¦×™×” ××• ×¤×•×© ×¢×“×™×Ÿ.

### ×¤×œ×–××” (FFP)
* **××™× ×•×Ÿ:** 10-15 ×"×œ/×§"×’.
* **×ª×›×•×œ×”:** ×›×œ ×¤×§×˜×•×¨×™ ×”×§×¨×™×©×”.
* **××™× ×“×™×§×¦×™×”:** DIC, ×“×™××•× ××¡×™×‘×™, ××—×œ×ª ×›×‘×“.""",
                "image": ""
             }
        }
    },
    "×˜×¨××•××” ×•× ×•×™×¨×•×œ×•×’×™×”": {
        "icon": "ğŸ§ ",
        "description": "×¤×’×™×¢×•×ª ×¨××©, GCS, ×¤×¨×›×•×¡×™×.",
        "topics": {
            "×—×‘×œ×ª ×¨××© (TBI)": {
                "text": """## ×—×‘×œ×ª ×¨××© ×˜×¨××•××˜×™×ª (TBI)
**××“×“ ×’×œ×–×’×• (GCS):** < 8 ××—×™×™×‘ ××™× ×˜×•×‘×¦×™×”.
**×™×¢×“:** ×©××™×¨×” ×¢×œ CPP (×œ×—×¥ ×–×™×œ×•×— ××•×—×™).
`CPP = MAP - ICP`

### ×˜×¨×™××“×” ×¢"×© ×§×•×©×™× ×’ (Cushing Triad)
×¡×™×× ×™× ×œ×¢×œ×™×™×ª ICP ×•×œ×—×¥ ×¢×œ ×’×–×¢ ×”××•×—:
1.  ×™×ª×¨ ×œ×—×¥ ×“× (×œ×—×¥ ×“×•×¤×§ ×¨×—×‘).
2.  ×‘×¨×“×™×§×¨×“×™×”.
3.  × ×©×™××” ×œ× ×¡×“×™×¨×”.

### ×˜×™×¤×•×œ ×‘-ICP ××•×’×‘×¨
* ×”×¨××ª ×¨××© 30 ××¢×œ×•×ª, ×× ×— ×™×©×¨.
* **×¡×œ×™×™×Ÿ ×”×™×¤×¨×˜×•× ×™ 3%:** 3-5 ×"×œ/×§"×’ (×‘×•×œ×•×¡).
* **×× ×™×˜×•×œ:** 0.5-1 ×’×¨×/×§"×’ (×× ××•×¡××•×œ×¨×™×•×ª < 320).
* ×”×™×¤×¨×•×•× ×˜×™×œ×¦×™×” ××ª×•× ×” (PCO2 30-35) ×¨×§ ×›××•×¦× ××—×¨×•×Ÿ.""",
                "image": ""
            }
        }
    }
}

# --- ×©××œ×•×ª ×œ×××’×¨ (××©×•×™×›×•×ª ×œ× ×•×©××™×) ---
ALL_QUESTIONS = [
    {"q": "××” ×”××™× ×•×Ÿ ×©×œ ××“×¨× ×œ×™×Ÿ IV ×‘×”×—×™×™××”?", "opts": ["0.01 ×\"×’/×§\"×’", "0.1 ×\"×’/×§\"×’", "1 ×\"×’/×§\"×’", "0.5 ×\"×’/×§\"×’"], "a": "0.01 ×\"×’/×§\"×’", "topic": "××“×¨× ×œ×™×Ÿ (Adrenaline)", "exp": "×“×™×œ×•×œ 1:10,000."},
    {"q": "××™×š × ×•×ª× ×™× ××“× ×•×–×™×Ÿ ×œ-SVT?", "opts": ["×¤×•×© ××”×™×¨ + ×©×˜×™×¤×”", "×“×¨×™×¤ ××™×˜×™", "IM", "PO"], "a": "×¤×•×© ××”×™×¨ + ×©×˜×™×¤×”", "topic": "××“× ×•×–×™×Ÿ (SVT)", "exp": "×–××Ÿ ××—×¦×™×ª ×—×™×™× ×§×¦×¨ ×××•×“."},
    {"q": "××”×• ×‘×•×œ×•×¡ ×”× ×•×–×œ×™× ×”×¨××©×•× ×™ ×‘×©×•×§?", "opts": ["20 ×\"×œ/×§\"×’", "50 ×\"×œ/×§\"×’", "5 ×\"×œ/×§\"×’", "100 ×\"×œ/×§\"×’"], "a": "20 ×\"×œ/×§\"×’", "topic": "×©×•×§ ×”×™×¤×•×•×œ××™ (Hypovolemic)", "exp": "× ×™×ª×Ÿ ×œ×—×–×•×¨ ×¢×“ 60 ×\"×œ/×§\"×’."},
    {"q": "××” ×›×•×œ×œ×ª ×”×˜×¨×™××“×” ×¢\"×© ×§×•×©×™× ×’?", "opts": ["×‘×¨×“×™×§×¨×“×™×”, ×™×ª\"×œ, × ×©×™××” ×œ× ×¡×“×™×¨×”", "×˜×›×™×§×¨×“×™×”, ×ª×ª\"×œ, ×—×•×", "×›××‘×™ ×¨××©", "××™×©×•× ×™× ×¦×¨×™×"], "a": "×‘×¨×“×™×§×¨×“×™×”, ×™×ª\"×œ, × ×©×™××” ×œ× ×¡×“×™×¨×”", "topic": "×—×‘×œ×ª ×¨××© (TBI)", "exp": "×¡×™××Ÿ ×œ×¢×œ×™×™×ª ICP."},
    {"q": "××” ×”×˜×™×¤×•×œ ×”×¨××©×•×Ÿ ×‘×× ×¤×™×œ×§×¡×™×¡?", "opts": ["××“×¨× ×œ×™×Ÿ IM", "×¡×˜×¨×•××™×“×™× IV", "×•× ×˜×•×œ×™×Ÿ", "×× ×˜×™×”×™×¡×˜××™×Ÿ"], "a": "××“×¨× ×œ×™×Ÿ IM", "topic": "×× ×¤×™×œ×§×¡×™×¡ (Anaphylaxis)", "exp": "××•× ×¢ ×§×¨×™×¡×” ×”××•×“×™× ××™×ª ×•× ×©×™××ª×™×ª."},
    {"q": "××™×–×• ×ª×¨×•×¤×” × ×™×ª× ×ª ×‘×”×™×¤×¨×§×œ××™×” ×œ×”×’× ×” ×¢×œ ×”×œ×‘?", "opts": ["×§×œ×¦×™×•× ×’×œ×•×§×•× ×˜", "××™× ×¡×•×œ×™×Ÿ", "×¤×•×¡×™×“", "×•× ×˜×•×œ×™×Ÿ"], "a": "×§×œ×¦×™×•× ×’×œ×•×§×•× ×˜", "topic": "×ª×™×§×•×Ÿ ××œ×§×˜×¨×•×œ×™×˜×™×", "exp": "××™×™×¦×‘ ×××‘×¨× ×”, ×œ× ××•×¨×™×“ ××©×œ×’×Ÿ."},
    {"q": "××”×• ×—×œ×•×Ÿ ×”×–××Ÿ ×œ××ª×Ÿ ×× ×˜×™×‘×™×•×˜×™×§×” ×‘×¡×¤×¡×™×¡?", "opts": ["×©×¢×” ××—×ª", "4 ×©×¢×•×ª", "24 ×©×¢×•×ª", "××—×¨×™ ×ª×¨×‘×™×ª"], "a": "×©×¢×” ××—×ª", "topic": "×¡×¤×¡×™×¡ (Sepsis)", "exp": "The Golden Hour."},
    {"q": "××”×™ ×ª×•×¤×¢×ª ×”×œ×•×•××™ ×”××¡×•×›× ×ª ×©×œ TLS?", "opts": ["×”×™×¤×¨×§×œ××™×” ×•×”×¤×¨×¢×•×ª ×§×¦×‘", "×”×™×¤×•×’×œ×™×§××™×”", "×”×™×¤×•×ª×¨××™×”", "×“×™××•×"], "a": "×”×™×¤×¨×§×œ××™×” ×•×”×¤×¨×¢×•×ª ×§×¦×‘", "topic": "Tumor Lysis Syndrome (TLS)", "exp": "×©×—×¨×•×¨ ××©×œ×’×Ÿ ××ª××™× ××¤×•×¨×§×™×."},
]

# --- × ×™×”×•×œ ×“××˜×” ---
def load_db():
    if not os.path.exists(DB_FILE):
        return DEFAULT_CONTENT
    return DEFAULT_CONTENT # ×‘×¤×™×ª×•×— × ×—×–×™×¨ ×“×™×¤×•×œ×˜ ×›×“×™ ×œ××¤×¡ ×©×’×™××•×ª

def save_db(data):
    # ×›××Ÿ ×‘×¢×ª×™×“ × ×©××•×¨ ×œ×§×•×‘×¥
    pass

# --- ×”×’×“×¨×ª ×¢××•×“ ---
st.set_page_config(page_title="×Ö²×—Ö¸×™×•Ö¼×ª - ××¢×¨×›×ª ×œ××™×“×”", page_icon="ğŸ¥", layout="wide", initial_sidebar_state="expanded")

# --- CSS ×¢×™×¦×•×‘ ---
st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;700&display=swap');
    
    html, body, .stApp {
        font-family: 'Rubik', sans-serif;
        direction: rtl;
        text-align: right;
        background-color: #f4f6f9;
    }
    h1, h2, h3 { color: #0d47a1; text-align: right !important; }
    p, li, div { text-align: right !important; }
    
    .category-card {
        background: white; padding: 20px; border-radius: 12px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center;
        border-top: 5px solid #1976d2; cursor: pointer; transition: 0.2s;
        height: 100%;
    }
    .category-card:hover { transform: translateY(-3px); }
    
    .content-box {
        background: white; padding: 40px; border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-right: 5px solid #0d47a1;
    }
    
    .scenario-box {
        background: #e3f2fd; padding: 20px; border-radius: 10px;
        border: 1px solid #bbdefb; margin-bottom: 20px;
    }
    
    .stButton button { width: 100%; border-radius: 8px; font-weight: bold; }
    .stProgress > div > div > div > div { background-color: #4caf50; }
    
    #MainMenu {visibility: hidden;} footer {visibility: hidden;}
</style>
""", unsafe_allow_html=True)

# --- Session State ---
if 'db' not in st.session_state: st.session_state.db = load_db()
if 'user_info' not in st.session_state: st.session_state.user_info = {}
if 'completed_topics' not in st.session_state: st.session_state.completed_topics = set()
if 'scenario_state' not in st.session_state: st.session_state.scenario_state = None

# --- ×œ×•×’×™×§×” ×œ×ª×¨×—×™×© ××ª×’×œ×’×œ ---
def init_scenario():
    st.session_state.scenario_state = {
        "step": 1,
        "history": [],
        "hp": 100, # ××“×“ ×‘×¨×™××•×ª ×•×™×¨×˜×•××œ×™
        "vitals": {"HR": 170, "BP": "75/40", "Sat": "88%"}
    }

# --- ×¡×¨×’×œ ×¦×“ ---
with st.sidebar:
    st.image("https://img.icons8.com/color/96/nurse-male--v1.png", width=70)
    st.title("×¤×¨×•×¤×™×œ ××™×©×™")
    
    if not st.session_state.user_info:
        with st.form("login"):
            st.write("× × ×œ×”×–×“×”×•×ª:")
            name = st.text_input("×©×")
            email = st.text_input("××™×™×œ")
            if st.form_submit_button("×›× ×™×¡×”"):
                if email:
                    st.session_state.user_info = {"name": name, "email": email}
                    st.rerun()
    else:
        st.success(f"××—×•×‘×¨: {st.session_state.user_info['name']}")
        if st.button("×™×¦×™××”"):
            st.session_state.user_info = {}
            st.rerun()
            
    st.markdown("---")
    
    if st.session_state.user_info:
        # ×ª×¤×¨×™×˜ × ×™×•×•×˜ ××œ× ×œ××©×ª××© ×¨×©×•×
        menu = st.radio("× ×™×•×•×˜:", ["ğŸ  ×“×£ ×”×‘×™×ª", "ğŸ“– ××¨×›×– ×œ××™×“×”", "ğŸš‘ ×ª×¨×—×™×© ××ª×’×œ×’×œ", "âš™ï¸ × ×™×”×•×œ"])
    else:
        st.info("×”×ª×—×‘×¨ ×›×“×™ ×œ×’×©×ª ×œ×ª×›× ×™×.")
        menu = "ğŸ  ×“×£ ×”×‘×™×ª"

# --- ×¢××•×“×™× ---

if menu == "ğŸ  ×“×£ ×”×‘×™×ª":
    st.title("×Ö²×—Ö¸×™×•Ö¼×ª - ×˜×™×¤×•×œ × ××¨×¥ ×™×œ×“×™× (PICU)")
    st.subheader("××¢×¨×›×ª ×œ××™×“×”, ×¤×¨×•×˜×•×§×•×œ×™× ×•×¡×™××•×œ×¦×™×•×ª")
    
    col1, col2 = st.columns([2, 1])
    with col1:
        st.markdown("""
        <div class="content-box">
        ×‘×¨×•×›×™× ×”×‘××™×. ×”××¢×¨×›×ª ××›×™×œ×” ××ª ×›×œ ×”×™×“×¢ ×”×“×¨×•×© ×œ××©××¨×ª:
        * **×¤×¨×•×˜×•×§×•×œ×™×:** ×©×•×§, ×”×—×™×™××”, ×ª×¨×•×¤×•×ª.
        * **×¡×™××•×œ×¦×™×•×ª:** ×ª×¨×—×™×©×™× ×§×œ×™× ×™×™× ×‘×–××Ÿ ×××ª.
        * **××‘×—× ×™×:** ×ª×¨×’×•×œ ×™×“×¢ ×œ×›×œ × ×•×©×.
        </div>
        """, unsafe_allow_html=True)
    
    with col2:
        st.warning("âš ï¸ **×©×™× ×œ×‘:**\n×™×© ×œ×ª×§×Ÿ ××’× ×–×™×•× ×œ×¤× ×™ ××©×œ×’×Ÿ ×‘×—×•×œ×™× ×¢× ×—×•×¡×¨ ××©×•×œ×‘!")
        st.info("ğŸ’¡ **×˜×™×¤ ×™×•××™:**\n×‘×—×©×“ ×œ×¡×¤×¡×™×¡ - ×× ×˜×™×‘×™×•×˜×™×§×” ×ª×•×š ×©×¢×” ××¦×™×œ×” ×—×™×™×.")

elif menu == "ğŸ“– ××¨×›×– ×œ××™×“×”":
    st.title("ğŸ“– ×”×¡×¤×¨×™×™×” ×”××§×¦×•×¢×™×ª")
    
    # ×—×™×©×•×‘ ×”×ª×§×“××•×ª
    total_topics = sum(len(c['topics']) for c in st.session_state.db.values())
    done = len(st.session_state.completed_topics)
    st.progress(done / total_topics if total_topics > 0 else 0)
    st.caption(f"×”×©×œ××ª {done} ××ª×•×š {total_topics} × ×•×©××™×")
    
    # ×‘×—×™×¨×ª ×§×˜×’×•×¨×™×”
    cats = list(st.session_state.db.keys())
    selected_cat = st.selectbox("×‘×—×¨ ×§×˜×’×•×¨×™×”:", cats)
    cat_data = st.session_state.db[selected_cat]
    
    # ×›×¤×ª×•×¨×™× ×œ×ª×ª×™-× ×•×©××™×
    subtopics = list(cat_data['topics'].keys())
    cols = st.columns(3)
    for i, sub in enumerate(subtopics):
        status = "âœ…" if sub in st.session_state.completed_topics else "â­•"
        if cols[i % 3].button(f"{status} {sub}", use_container_width=True):
            st.session_state.curr_topic = sub

    # ×”×¦×’×ª ×ª×•×›×Ÿ × ×‘×—×¨
    if 'curr_topic' in st.session_state and st.session_state.curr_topic in cat_data['topics']:
        topic = st.session_state.curr_topic
        data = cat_data['topics'][topic]
        
        st.markdown("---")
        st.markdown(f"## {topic}")
        st.markdown(f"""<div class="content-box">{data['text']}</div>""", unsafe_allow_html=True)
        
        if data.get('image'): st.image(data['image'], width=400)
        
        # ×›×¤×ª×•×¨ ×¡×™×•×
        if st.checkbox("×¡×™×™××ª×™ ×œ×œ××•×“ × ×•×©× ×–×”", value=(topic in st.session_state.completed_topics), key=topic):
            st.session_state.completed_topics.add(topic)
        else:
            st.session_state.completed_topics.discard(topic)
            
        # ××‘×—×Ÿ ××”×™×¨ ×¢×œ ×”× ×•×©×
        with st.expander(f"ğŸ“ ×‘×—×Ÿ ××ª ×¢×¦××š ×¢×œ: {topic}"):
            # ×¡×™× ×•×Ÿ ×©××œ×•×ª ×¨×œ×•×•× ×˜×™×•×ª ×œ× ×•×©×
            relevant_q = [q for q in ALL_QUESTIONS if q.get('topic') == topic]
            if relevant_q:
                q = random.choice(relevant_q)
                st.write(f"**{q['q']}**")
                ans = st.radio("×ª×©×•×‘×”:", q['opts'], key=f"q_{topic}")
                if st.button("×‘×“×•×§ ×ª×©×•×‘×”", key=f"btn_{topic}"):
                    if ans == q['a']:
                        st.success("× ×›×•×Ÿ ×××•×“!")
                    else:
                        st.error(f"×˜×¢×•×ª. ×”×ª×©×•×‘×” ×”×™×: {q['a']}")
                        st.info(q['exp'])
            else:
                st.write("××™×Ÿ ×©××œ×•×ª ×–××™× ×•×ª ×œ× ×•×©× ×–×” ×›×¨×’×¢.")

elif menu == "ğŸš‘ ×ª×¨×—×™×© ××ª×’×œ×’×œ":
    st.title("ğŸš‘ ×¡×™××•×œ×¦×™×”: ×™×œ×“ ×‘×©×•×§ ×‘××™×•×Ÿ")
    
    if st.button("×”×ª×—×œ ×¡×™××•×œ×¦×™×” ××—×“×©"):
        init_scenario()
        st.rerun()
        
    if st.session_state.scenario_state is None:
        init_scenario()
    
    state = st.session_state.scenario_state
    
    # ×ª×¦×•×’×ª ××“×“×™× ×‘×–××Ÿ ×××ª
    col1, col2, col3, col4 = st.columns(4)
    col1.metric("×“×•×¤×§ (HR)", state['vitals']['HR'])
    col2.metric("×œ\"×“ (BP)", state['vitals']['BP'])
    col3.metric("×¡×˜×•×¨×¦×™×”", state['vitals']['Sat'])
    col4.metric("×¦×™×•×Ÿ ×‘×¨×™××•×ª", f"{state['hp']}%")
    
    st.markdown("---")
    
    # ××›×•× ×ª ××¦×‘×™× (State Machine)
    if state['step'] == 1:
        st.markdown("""
        ### ğŸ›‘ ×©×œ×‘ 1: ×§×‘×œ×ª ×—×•×œ×”
        ×‘×Ÿ 3, ×”×’×™×¢ ×¢×§×‘ ×™×©× ×•× ×™×•×ª ×•×—×•× ×’×‘×•×”.
        ×‘×‘×“×™×§×”: ×—×™×•×•×¨, ×’×¤×™×™× ×§×¨×•×ª, ××™×œ×•×™ ×§×¤×™×œ×¨×™ 4 ×©× ×™×•×ª. × ×•×©× ××”×¨.
        **××” ×”×¤×¢×•×œ×” ×”×¨××©×•× ×” ×©×œ×š?**
        """)
        
        act = st.radio("×‘×—×¨ ×¤×¢×•×œ×”:", [
            "××ª×Ÿ ××§××•×œ ×œ×”×•×¨×“×ª ×—×•×",
            "×—×™×‘×•×¨ ×œ×—××¦×Ÿ, ×¤×ª×™×—×ª ×•×¨×™×“ ×•××ª×Ÿ ×‘×•×œ×•×¡ × ×•×–×œ×™× 20 ×\"×œ/×§\"×’",
            "××™× ×˜×•×‘×¦×™×” ××™×™×“×™×ª ×¢× ×¤×¨×•×¤×•×¤×•×œ",
            "××ª×Ÿ ××“×¨× ×œ×™×Ÿ IM"
        ])
        
        if st.button("×‘×¦×¢ ×¤×¢×•×œ×”"):
            if "× ×•×–×œ×™×" in act:
                state['history'].append("âœ… ×‘×•×œ×•×¡ × ×•×–×œ×™× ×•×—××¦×Ÿ - ×¤×¢×•×œ×” ××¦×•×™× ×ª.")
                state['vitals']['HR'] = 150
                state['vitals']['BP'] = "85/50"
                state['vitals']['Sat'] = "94%"
                state['step'] = 2
                st.success("××¦×‘ ×”×™×œ×“ ×”×©×ª×¤×¨ ×§×œ×•×ª. ×××©×™×›×™×.")
            elif "××§××•×œ" in act:
                state['hp'] -= 20
                state['history'].append("âŒ ××§××•×œ ×œ× ××˜×¤×œ ×‘×©×•×§. ××¦×‘ ×”×™×œ×“ ×”×“×¨×“×¨.")
                st.error("×˜×¢×•×ª. ×”×™×œ×“ ×‘×©×•×§, ××§××•×œ ×œ× ×“×—×•×£.")
            else:
                state['hp'] -= 30
                st.error("×¤×¢×•×œ×” ××¡×•×›× ×ª ××• ×œ× ××ª××™××” ×œ×©×œ×‘ ×–×”.")
            st.rerun()

    elif state['step'] == 2:
        st.markdown("""
        ### âš ï¸ ×©×œ×‘ 2: ×”×¢×¨×›×” ×—×•×–×¨×ª
        ×”×™×œ×“ ×§×™×‘×œ × ×•×–×œ×™×. ×¢×“×™×™×Ÿ ×˜×›×™×§×¨×“×™ (150), ×œ"×“ ×’×‘×•×œ×™.
        ×”×ª×§×‘×œ×” ×ª×©×•×‘×ª ××¢×‘×“×”: **×œ×•×™×§×•×¦×™×˜×™× 25,000, ×œ×§×˜×˜ 4.5**.
        ×™×© ×—×©×“ ×œ×¡×¤×¡×™×¡. ××” ×›×¢×ª?
        """)
        
        act = st.radio("×‘×—×¨ ×¤×¢×•×œ×”:", [
            "××ª×Ÿ ×× ×˜×™×‘×™×•×˜×™×§×” ×¨×—×‘×ª ×˜×•×•×— (××¨×•×¤× ×) ×ª×•×š ×©×¢×”",
            "××ª×Ÿ ×‘×•×œ×•×¡ × ×•×–×œ×™× × ×•×¡×£ 20 ×\"×œ/×§\"×’",
            "×©×ª×™ ×”×ª×©×•×‘×•×ª × ×›×•× ×•×ª",
            "×œ×”××ª×™×Ÿ ×œ×ª×¨×‘×™×ª ×“× ×¡×•×¤×™×ª"
        ])
        
        if st.button("×‘×¦×¢ ×¤×¢×•×œ×”"):
            if "×©×ª×™ ×”×ª×©×•×‘×•×ª" in act:
                state['history'].append("âœ… ×× ×˜×™×‘×™×•×˜×™×§×” + × ×•×–×œ×™× - × ×™×”×•×œ ×¡×¤×¡×™×¡ ××¢×•×œ×”.")
                state['vitals']['HR'] = 130
                state['vitals']['BP'] = "90/60"
                state['step'] = 3
                st.success("×”×™×œ×“ ××ª×™×™×¦×‘.")
            elif "×œ×”××ª×™×Ÿ" in act:
                state['hp'] = 0
                st.error("âŒ ×”××ª× ×” ×‘×¡×¤×¡×™×¡ = ××•×•×ª. ×”××©×—×§ × ×’××¨.")
                state['step'] = 99
            else:
                state['hp'] -= 10
                st.warning("× ×›×•×Ÿ ×—×œ×§×™×ª. ×‘×¡×¤×¡×™×¡ ×¦×¨×™×š ×’× × ×•×–×œ×™× ×•×’× ×× ×˜×™×‘×™×•×˜×™×§×”.")
                state['step'] = 3
            st.rerun()

    elif state['step'] == 3:
        st.balloons()
        st.markdown("### ğŸ‰ ×¡×™×•× ×¡×™××•×œ×¦×™×”")
        st.success(f"×”×¦×œ×—×ª ×œ×™×™×¦×‘ ××ª ×”×™×œ×“! ×¦×™×•×Ÿ ×¡×•×¤×™: {state['hp']}")
        st.write("×¡×™×›×•× ×¤×¢×•×œ×•×ª:")
        for h in state['history']:
            st.write(h)
        if st.button("×”×ª×—×œ ××—×“×©"):
            init_scenario()
            st.rerun()

    elif state['step'] == 99:
        st.error("ğŸ’€ ×”×™×œ×“ ×§×¨×¡. ×”×¡×™××•×œ×¦×™×” × ×›×©×œ×”.")
        if st.button("× ×¡×” ×©×•×‘"):
            init_scenario()
            st.rerun()

elif menu == "âš™ï¸ × ×™×”×•×œ":
    st.title("×××©×§ × ×™×”×•×œ")
    
    # ×‘×“×™×§×ª ×”×¨×©××” ×œ×¤×™ ×”××™×™×œ ×©×œ×š
    if st.session_state.user_info.get('email') == 'yishaycopp@gmail.com':
        st.success("××–×•×”×” ×›×× ×”×œ ××¢×¨×›×ª (Admin) ğŸ”“")
        
        tab1, tab2 = st.tabs(["×¢×¨×™×›×ª ×ª×•×›×Ÿ", "×”×’×“×¨×•×ª"])
        
        with tab1:
            st.write("×›××Ÿ ×ª×•×›×œ ×œ×¢×¨×•×š ××ª ×”×˜×§×¡×˜×™× ×‘××ª×¨ ×‘×–××Ÿ ×××ª.")
            cat = st.selectbox("× ×•×©×:", list(st.session_state.db.keys()), key="adm_cat")
            sub = st.selectbox("×¤×¨×•×˜×•×§×•×œ:", list(st.session_state.db[cat]['topics'].keys()), key="adm_sub")
            
            curr_text = st.session_state.db[cat]['topics'][sub]['text']
            new_text = st.text_area("×¢×¨×•×š ×ª×•×›×Ÿ:", value=curr_text, height=300)
            
            if st.button("×©××•×¨ ×©×™× ×•×™×™×"):
                st.session_state.db[cat]['topics'][sub]['text'] = new_text
                st.success("×”×ª×•×›×Ÿ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!")
                
    else:
        st.error("××™×Ÿ ×œ×š ×”×¨×©××•×ª × ×™×”×•×œ. (×¨×§ yishaycopp@gmail.com)")
