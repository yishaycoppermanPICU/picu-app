import streamlit as st
import random
import json
import os
import time

# --- ×”×’×“×¨×•×ª ×§×•×‘×¥ × ×ª×•× ×™× ---
DB_FILE = "picu_data.json"

# --- ×ª×•×›×Ÿ ×”×œ×™××•×“ (××‘×•×¡×¡ ×¢×œ ×”×§×‘×¦×™× ×©×”×¢×œ×™×ª - × ×§×™ ××©×’×™××•×ª) ---
DEFAULT_CONTENT = {
    "××¦×‘×™ ×—×™×¨×•× ×•×”×—×™×™××”": {
        "icon": "ğŸš‘",
        "description": "×¤×¨×•×˜×•×§×•×œ×™ ×”×—×™×™××” (PALS), ×©×•×§, ×¡×¤×¡×™×¡ ×•×˜×¨××•××”.",
        "topics": {
            "×©×•×§ ×”×™×¤×•×•×œ××™ (Hypovolemic)": {
                "text": """### ğŸ©¸ ×©×•×§ ×”×™×¤×•×•×œ××™ / ×”××•×¨×’×™
**×”×’×“×¨×”:** ×¤×¨×¤×•×–×™×” ×œ×§×•×™×” ×œ×¨×§××•×ª ×¢×§×‘ ××•×‘×“×Ÿ × ×¤×— ×“× ××• × ×•×–×œ×™×.

#### ğŸ“‰ ×¡×™×× ×™× ×§×œ×™× ×™×™× ×œ×¤×™ ×©×œ×‘×™×
1.  **×©×œ×‘ 1 (×¤×™×¦×•×™):** ×œ"×“ ×ª×§×™×Ÿ, ×“×•×¤×§ ×•× ×©×™××” ×¡×“×™×¨×™×. ×”×™×œ×“ ×¢×©×•×™ ×œ×”×™×•×ª ×‘××™-×©×§×˜.
2.  **×©×œ×‘ 2:** ×˜×›×™×§×¨×“×™×”, ×˜×›×™×¤× ×™××”, ××™×œ×•×™ ×§×¤×™×œ×¨×™ ××™×˜×™ (>2 ×©× ×™×•×ª), ×™×¨×™×“×” ×‘×ª×¤×•×§×ª ×©×ª×Ÿ.
3.  **×©×œ×‘ 3 (Decompensated):** ×™×¨×™×“×ª ×œ×—×¥ ×“× (×¡×™××Ÿ ×××•×—×¨ ×•××¡×•×›×Ÿ!), ×©×™× ×•×™ ×‘×”×›×¨×”.
4.  **×©×œ×‘ 4:** ×§×¨×™×¡×”. ×¢×•×¨ ×—×™×•×•×¨/×©×™×©, ×—×•×¡×¨ ×”×›×¨×”, ×× ×•×¨×™×”.

#### âš¡ ×˜×™×¤×•×œ ×‘×—×™×¨×•×
* **×’×™×©×” ×•×¨×™×“×™×ª:** ×¨×¦×•×™ ×©× ×™ ×•× ×¤×œ×•× ×™× ×¢×‘×™× ××• IO (×ª×•×š ×’×¨××™).
* **× ×•×–×œ×™×:** ×‘×•×œ×•×¡ ×§×¨×™×¡×˜×œ×•××™×“×™× (×¡×œ×™×™×Ÿ/×”×¨×˜××Ÿ) **20 ×"×œ/×§"×’** ×‘×”×–×¨×§×” ××”×™×¨×” (5-10 ×“×§').
* **×”×¢×¨×›×” ×—×•×–×¨×ª:** × ×™×ª×Ÿ ×œ×—×–×•×¨ ×¢×œ ×”×‘×•×œ×•×¡ ×¢×“ 3 ×¤×¢××™× (×¡×”"×› 60 ×"×œ/×§"×’).
* **×©×•×§ ×”××•×¨×’×™:** ×× ××™×Ÿ ×©×™×¤×•×¨ ×œ××—×¨ × ×•×–×œ×™× -> ××ª×Ÿ ×“× (PC) ×œ×¤×™ 10 ×"×œ/×§"×’.""",
                "image": "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1d/Capillary_refill.gif/220px-Capillary_refill.gif"
            },
            "×¡×¤×¡×™×¡ (Sepsis)": {
                "text": """### ğŸ¦  ×¡×¤×¡×™×¡ ×•×©×•×§ ×¡×¤×˜×™
**×”×’×“×¨×”:** ×–×™×”×•× ×—×©×•×“/×××•××ª + SIRS (×—×•×, ×˜×›×™×§×¨×“×™×”, ×˜×›×™×¤× ×™××”, ×œ×•×™×§×•×¦×™×˜×•×–×™×¡).

#### â³ ×”×˜×™×¤×•×œ ×‘×©×¢×” ×”×¨××©×•× ×” (Golden Hour)
1.  **×ª×¨×‘×™×•×ª ×“×:** ×œ×§×—×ª ×œ×¤× ×™ ×× ×˜×™×‘×™×•×˜×™×§×” (××œ× ×× ××¢×›×‘ ××ª×Ÿ).
2.  **×× ×˜×™×‘×™×•×˜×™×§×”:** ×¨×—×‘×ª ×˜×•×•×— (×œ××©×œ Meropenem 20mg/kg) - **×—×•×‘×” ×ª×•×š ×©×¢×”!**
3.  **× ×•×–×œ×™×:** ×‘×•×œ×•×¡ 20 ×"×œ/×§"×’ (×¢×“ 60 ×"×œ/×§"×’) ×ª×•×š × ×™×˜×•×¨ ×¢×•××¡.
4.  **×‘×“×™×§×ª ×œ×§×˜×˜:** ××“×“ ×¨×’×™×© ×œ×¤×¨×¤×•×–×™×”.

#### ğŸ’‰ ×˜×™×¤×•×œ ×‘×©×•×§ ×¢××™×“ (Refractory)
* ×× ××™×Ÿ ×ª×’×•×‘×” ×œ× ×•×–×œ×™× -> ×”×ª×—×œ×ª ×××™× ×™× (**× ×•×¨××“×¨× ×œ×™×Ÿ** ×œ×©×•×§ ×—×/××•×¨×—×‘, **××“×¨× ×œ×™×Ÿ** ×œ×©×•×§ ×§×¨/××›×•×•×¥).
* ×©×•×§ ×¢××™×“ ×œ×§×˜×›×•×œ××™× ×™× -> ×œ×©×§×•×œ **×”×™×“×¨×•×§×•×¨×˜×™×–×•×Ÿ** (×‘×—×©×“ ×œ××™ ×¡×¤×™×§×ª ××“×¨× ×œ).""",
                "image": ""
            },
            "×× ×¤×™×œ×§×¡×™×¡ (Anaphylaxis)": {
                "text": """### ğŸ ×× ×¤×™×œ×§×¡×™×¡
×ª×’×•×‘×” ××œ×¨×’×™×ª ××¡×›× ×ª ×—×™×™×.
**×¡×™×× ×™×:** ××•×¨×˜×™×§×¨×™×”, × ×¤×™×—×•×ª (×× ×’×™×•××“××”), ×¡×˜×¨×™×“×•×¨, ×¦×¤×¦×•×¤×™×, ×™×¨×™×“×ª ×œ"×“.

#### ğŸš€ ×˜×™×¤×•×œ ××¦×™×œ ×—×™×™× (×§×• ×¨××©×•×Ÿ)
1.  **××“×¨× ×œ×™×Ÿ IM:** ×”×˜×™×¤×•×œ ×”×—×©×•×‘ ×‘×™×•×ª×¨!
    * **××™× ×•×Ÿ:** 0.01 ×"×’/×§"×’ (××§×¡' 0.5 ×"×’ ×œ×× ×”).
    * **×¨×™×›×•×–:** 1:1,000 (×××¤×•×œ×” ×œ× ××“×•×œ×œ×ª).
    * **××™×§×•×:** ×™×¨×š (Vastus Lateralis).
    * **×—×–×¨×”:** ×›×œ 5-15 ×“×§×•×ª ×× ××™×Ÿ ×©×™×¤×•×¨.

#### ğŸ’Š ×˜×™×¤×•×œ ×ª×•××š (×§×• ×©× ×™)
* **× ×•×–×œ×™×:** 20 ×"×œ/×§"×’ ×‘×•×œ×•×¡.
* **×•× ×˜×•×œ×™×Ÿ:** ××™× ×”×œ×¦×™×” ×œ×‘×¨×•× ×›×•×¡×¤××–×.
* **×¡×˜×¨×•××™×“×™× ×•×× ×˜×™×”×™×¡×˜××™× ×™×:** ×¨×§ ×œ××—×¨ ×”×ª×™×™×¦×‘×•×ª (×œ×× ×™×¢×ª ×ª×’×•×‘×” ×××•×—×¨×ª).""",
                "image": ""
            }
        }
    },
    "×ª×¨×•×¤×•×ª ×•×¤×¨×•×˜×•×§×•×œ×™×": {
        "icon": "ğŸ’Š",
        "description": "××™× ×•× ×™×, ××•×¤× ×™ ××ª×Ÿ ×•×“×’×©×™ ×‘×˜×™×—×•×ª.",
        "topics": {
            "××“×¨× ×œ×™×Ÿ (Adrenaline)": {
                "text": """### âš¡ ××“×¨× ×œ×™×Ÿ (Epinephrine)
**××™× ×“×™×§×¦×™×•×ª:** ×”×—×™×™××”, ×‘×¨×“×™×§×¨×“×™×”, ×× ×¤×™×œ×§×¡×™×¡, ×¡×˜×¨×™×“×•×¨.

#### ğŸ“ ××™× ×•× ×™× ×•×“×¨×š ××ª×Ÿ
* **×”×—×™×™××” (IV/IO):**
    * ××™× ×•×Ÿ: **0.01 ×"×’/×§"×’** (0.1 ×"×œ/×§"×’ ××“×™×œ×•×œ 1:10,000).
    * ××§×¡': 1 ×"×’. ×—×–×¨×” ×›×œ 3-5 ×“×§×•×ª.
* **×× ×¤×™×œ×§×¡×™×¡ (IM):**
    * ××™× ×•×Ÿ: **0.01 ×"×’/×§"×’** (××“×™×œ×•×œ 1:1,000).
* **××™× ×”×œ×¦×™×” (×¡×˜×¨×™×“×•×¨):**
    * ××™× ×•×Ÿ: 0.5 ×"×œ/×§"×’ (××§×¡' 5 ×"×œ).""",
                "image": ""
            },
            "××“× ×•×–×™×Ÿ (SVT)": {
                "text": """### ğŸ’“ ××“× ×•×–×™×Ÿ (Adenosine)
**××™× ×“×™×§×¦×™×”:** SVT (Supraventricular Tachycardia).

#### âš ï¸ ×“×’×© ×§×¨×™×˜×™ ×œ××ª×Ÿ
×–××Ÿ ××—×¦×™×ª ×—×™×™× ×§×¦×¨ ×××•×“ (<10 ×©× ×™×•×ª).
×—×•×‘×” ×œ×ª×ª ×‘×©×™×˜×ª **Push-Flush**:
1.  ×”×–×¨×§×” ××”×™×¨×” ("×¤×•×©") ×‘×‘×¨×– ×”×›×™ ×§×¨×•×‘ ×œ×œ×‘.
2.  ××™×“ ××—×¨×™×” ×©×˜×™×¤×” ×‘×•×œ×•×¡ ×©×œ 5-10 ×"×œ ×¡×œ×™×™×Ÿ.

#### ğŸ“ ××™× ×•× ×™×
1.  **×× ×” ×¨××©×•× ×”:** 0.1 ×"×’/×§"×’ (××§×¡' 6 ×"×’).
2.  **×× ×” ×©× ×™×”:** 0.2 ×"×’/×§"×’ (××§×¡' 12 ×"×’).""",
                "image": ""
            },
            "×ª×™×§×•×Ÿ ××œ×§×˜×¨×•×œ×™×˜×™×": {
                "text": """### ğŸ§ª ××©×œ×’×Ÿ ×•××’× ×–×™×•×
#### ××©×œ×’×Ÿ (Potassium)
* **×¢×¨×›×™× ×ª×§×™× ×™×:** 3.5-5.0 mEq/L.
* **×—×•×§ ×‘×¨×–×œ:** ×‘×—×•×œ×™× ×¢× ×”×™×¤×•×§×œ××™×” ×•×”×™×¤×•××’× ×–××™×” -> **×™×© ×œ×ª×§×Ÿ ××’× ×–×™×•× ×ª×—×™×œ×”!** (××—×¨×ª ×”××©×œ×’×Ÿ ×™×•×¤×¨×© ×‘×©×ª×Ÿ).
* **×§×¦×‘ ××ª×Ÿ IV:**
    * ×¤×¨×™×¤×¨×™: ××§×¡' 10 mEq/h.
    * ××¨×›×–×™: ××§×¡' 40 mEq/h (×ª×—×ª × ×™×˜×•×¨).

#### ×”×™×¤×¨×§×œ××™×” (×˜×™×¤×•×œ ×—×™×¨×•×)
1.  **×§×œ×¦×™×•× ×’×œ×•×§×•× ×˜:** ×”×’× ×” ×¢×œ ×”×œ×‘ (Cardioprotection).
2.  **××™× ×¡×•×œ×™×Ÿ + ×’×œ×•×§×•×–:** ×”×›× ×¡×ª ××©×œ×’×Ÿ ×œ×ª××™×.
3.  **×•× ×˜×•×œ×™×Ÿ:** ××™× ×”×œ×¦×™×”.""",
                "image": ""
            }
        }
    },
    "×˜×¨××•××” ×•× ×•×™×¨×•×œ×•×’×™×”": {
        "icon": "ğŸ§ ",
        "description": "×¤×’×™×¢×•×ª ×¨××© (TBI), GCS ×•×˜×™×¤×•×œ ×‘-ICP.",
        "topics": {
            "×—×‘×œ×ª ×¨××© (TBI)": {
                "text": """### ğŸ¤• ×—×‘×œ×ª ×¨××© (TBI)
**×™×¢×“:** ×©××™×¨×” ×¢×œ CPP (×œ×—×¥ ×–×™×œ×•×— ××•×—×™).
`CPP = MAP - ICP`

#### ğŸš© ×˜×¨×™××“×” ×¢"×© ×§×•×©×™× ×’ (Cushing Triad)
×¡×™×× ×™× ×œ×¢×œ×™×™×ª ICP ×•×œ×—×¥ ×¢×œ ×’×–×¢ ×”××•×— (×¡×›× ×ª ×”×¨× ×™××¦×™×”):
1.  **×™×ª×¨ ×œ×—×¥ ×“×** (×¢× ×œ×—×¥ ×“×•×¤×§ ×¨×—×‘).
2.  **×‘×¨×“×™×§×¨×“×™×”**.
3.  **× ×©×™××” ×œ× ×¡×“×™×¨×”**.

#### ğŸ“‰ ×˜×™×¤×•×œ ×‘-ICP ××•×’×‘×¨
* ×”×¨××ª ××¨××©×•×ª ×”××™×˜×” (30 ××¢×œ×•×ª) ×•×× ×— ×¨××© ×™×©×¨.
* **×¡×œ×™×™×Ÿ ×”×™×¤×¨×˜×•× ×™ 3%:** 3-5 ×"×œ/×§"×’.
* **×× ×™×˜×•×œ:** 0.5-1 ×’×¨×/×§"×’ (×× ××•×¡××•×œ×¨×™×•×ª < 320).""",
                "image": ""
            }
        }
    }
}

# --- ×××’×¨ ×©××œ×•×ª ---
ALL_QUESTIONS = [
    {
        "q": "××” ×”××™× ×•×Ÿ ×©×œ ××“×¨× ×œ×™×Ÿ IV ×‘×”×—×™×™××”?",
        "opts": ["0.01 ×\"×’/×§\"×’ (1:10,000)", "0.1 ×\"×’/×§\"×’ (1:1,000)", "1 ×\"×’/×§\"×’", "0.5 ×\"×’/×§\"×’"],
        "a": "0.01 ×\"×’/×§\"×’ (1:10,000)",
        "exp": "×‘×”×—×™×™××” × ×•×ª× ×™× ×“×™×œ×•×œ ×’×‘×•×” (1:10,000) ×‘××™× ×•×Ÿ 0.01 ×\"×’/×§\"×’. ×“×™×œ×•×œ 1:1,000 ××™×•×¢×“ ×œ×©×¨×™×¨ (IM)."
    },
    {
        "q": "×›×™×¦×“ ×™×© ×œ×ª×ª ××“× ×•×–×™×Ÿ ×œ×˜×™×¤×•×œ ×‘-SVT?",
        "opts": ["×¤×•×© ××”×™×¨ + ×©×˜×™×¤×”", "×“×¨×™×¤ ××™×˜×™", "IM ×‘×™×¨×š", "PO"],
        "a": "×¤×•×© ××”×™×¨ + ×©×˜×™×¤×”",
        "exp": "×œ××“× ×•×–×™×Ÿ ×–××Ÿ ××—×¦×™×ª ×—×™×™× ×§×¦×¨ ×××•×“. ×—×•×‘×” ×œ×ª×ª ×‘×©×™×˜×ª Push-Flush ×›×“×™ ×©×™×’×™×¢ ×œ×œ×‘ ×œ×¤× ×™ ×©×™×ª×¤×¨×§."
    },
    {
        "q": "××”×• ×‘×•×œ×•×¡ ×”× ×•×–×œ×™× ×”×¨××©×•× ×™ ×‘×©×•×§ ×”×™×¤×•×•×œ××™?",
        "opts": ["20 ×\"×œ/×§\"×’", "50 ×\"×œ/×§\"×’", "5 ×\"×œ/×§\"×’", "10 ×\"×œ/×§\"×’"],
        "a": "20 ×\"×œ/×§\"×’",
        "exp": "×”×˜×™×¤×•×œ ×”×¨××©×•× ×™ ×”×•× 20 ×\"×œ/×§\"×’ ×§×¨×™×¡×˜×œ×•××™×“×™× ×ª×•×š 5-10 ×“×§×•×ª."
    },
    {
        "q": "××” ×›×•×œ×œ×ª ×”×˜×¨×™××“×” ×¢\"×© ×§×•×©×™× ×’?",
        "opts": ["×‘×¨×“×™×§×¨×“×™×”, ×™×ª×¨ ×œ×—×¥ ×“×, × ×©×™××” ×œ× ×¡×“×™×¨×”", "×˜×›×™×§×¨×“×™×”, ×ª×ª ×œ×—×¥ ×“×, ×—×•×", "×›××‘×™ ×¨××© ×•×”×§××•×ª", "××™×©×•× ×™× ×¦×¨×™×"],
        "a": "×‘×¨×“×™×§×¨×“×™×”, ×™×ª×¨ ×œ×—×¥ ×“×, × ×©×™××” ×œ× ×¡×“×™×¨×”",
        "exp": "×–×”×• ×¡×™××Ÿ ×××•×—×¨ ×œ×¢×œ×™×™×ª ×œ×—×¥ ×ª×•×š ×’×•×œ×’×•×œ×ª×™ (ICP) ×•×œ×—×¥ ×¢×œ ×’×–×¢ ×”××•×—."
    },
    {
        "q": "×‘×˜×™×¤×•×œ ×‘×× ×¤×™×œ×§×¡×™×¡, ××™×–×• ×ª×¨×•×¤×” × ×™×ª× ×ª ×¨××©×•× ×”?",
        "opts": ["××“×¨× ×œ×™×Ÿ IM", "×¡×˜×¨×•××™×“×™× IV", "×•× ×˜×•×œ×™×Ÿ", "×× ×˜×™×”×™×¡×˜××™×Ÿ"],
        "a": "××“×¨× ×œ×™×Ÿ IM",
        "exp": "××“×¨× ×œ×™×Ÿ ×”×•× ×”×˜×™×¤×•×œ ×”×™×—×™×“ ×”××¦×™×œ ×—×™×™× ××™×™×“×™×ª ×•××•× ×¢ ×§×¨×™×¡×” ×”××•×“×™× ××™×ª."
    },
    {
        "q": "×‘×™×œ×“ ×¢× ×”×™×¤×•×§×œ××™×” ×•×”×™×¤×•××’× ×–××™×”, ××” ×¡×“×¨ ×”×˜×™×¤×•×œ?",
        "opts": ["×ª×™×§×•×Ÿ ××’× ×–×™×•× ×§×•×“×", "×ª×™×§×•×Ÿ ××©×œ×’×Ÿ ×§×•×“×", "××™×Ÿ ×—×©×™×‘×•×ª", "×¨×§ ××©×œ×’×Ÿ"],
        "a": "×ª×™×§×•×Ÿ ××’× ×–×™×•× ×§×•×“×",
        "exp": "×—×•×¡×¨ ×‘××’× ×–×™×•× ××§×©×” ×¢×œ ×”×›×œ×™×” ×œ×©××•×¨ ××©×œ×’×Ÿ, ×•×œ×›×Ÿ ×”×”×™×¤×•×§×œ××™×” ×ª×”×™×” ×¢××™×“×” ×œ×˜×™×¤×•×œ ×œ×œ× ×ª×™×§×•×Ÿ ×”××’× ×–×™×•×."
    },
    {
        "q": "×ª×•×š ×›××” ×–××Ÿ ×™×© ×œ×ª×ª ×× ×˜×™×‘×™×•×˜×™×§×” ×‘×—×©×“ ×œ×¡×¤×¡×™×¡?",
        "opts": ["×ª×•×š ×©×¢×” (Golden Hour)", "×ª×•×š 4 ×©×¢×•×ª", "×¨×§ ××—×¨×™ ×ª×©×•×‘×ª ×ª×¨×‘×™×ª", "×ª×•×š 24 ×©×¢×•×ª"],
        "a": "×ª×•×š ×©×¢×” (Golden Hour)",
        "exp": "×¢×™×›×•×‘ ×‘××ª×Ÿ ×× ×˜×™×‘×™×•×˜×™×§×” ××¢×œ×” ××©××¢×•×ª×™×ª ××ª ×”×ª××•×ª×” ×‘×©×•×§ ×¡×¤×˜×™."
    }
]

# --- ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ ---
def load_db():
    if not os.path.exists(DB_FILE):
        return DEFAULT_CONTENT
    # ×‘××¦×‘ ×××ª ×”×™×™× ×• ×˜×•×¢× ×™× ××”×§×•×‘×¥, ×›××Ÿ × ×—×–×™×¨ ××ª ×”×“×™×¤×•×œ×˜ ×›×“×™ ×œ×× ×•×¢ ×©×’×™××•×ª ×‘×§×¨×™××” ×¨××©×•× ×”
    return DEFAULT_CONTENT 

# --- ×”×’×“×¨×ª ×¢××•×“ ---
st.set_page_config(page_title="×Ö²×—Ö¸×™×•Ö¼×ª - ×œ××™×“×” ×—×›××”", page_icon="ğŸ¥", layout="wide", initial_sidebar_state="expanded")

# --- CSS ×œ×¢×™×¦×•×‘ ---
st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;700&display=swap');
    
    html, body, .stApp {
        font-family: 'Rubik', sans-serif;
        direction: rtl;
        text-align: right;
        background-color: #f8f9fa;
    }
    
    /* ×›×•×ª×¨×•×ª */
    h1, h2, h3, h4 { 
        color: #1565c0; 
        font-weight: 700; 
        text-align: right !important;
        margin-bottom: 0.5em;
    }
    
    /* ×˜×§×¡×˜ */
    p, li, div, span {
        text-align: right !important;
        font-size: 1.1rem;
        line-height: 1.6;
    }
    
    /* ×›×¨×˜×™×¡×™×™×ª × ×•×©× ×¨××©×™ */
    .category-card {
        background-color: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border-top: 5px solid #1976d2;
        text-align: center !important;
        cursor: pointer;
        transition: 0.3s;
        height: 100%;
    }
    .category-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    /* ×›×¨×˜×™×¡×™×™×ª ×ª×•×›×Ÿ ×œ×™××•×“×™ */
    .content-box {
        background-color: #ffffff;
        padding: 40px;
        border-radius: 15px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        margin-top: 20px;
        border-right: 6px solid #1565c0;
    }
    
    /* ×›×¨×˜×™×¡×™×™×ª ×©××œ×” */
    .question-box {
        background-color: #e3f2fd;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        border-right: 5px solid #2196f3;
    }
    
    /* ××©×•×‘ ×ª×©×•×‘×•×ª */
    .success-box { background-color: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-top: 10px; }
    .error-box { background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-top: 10px; }
    
    /* ×›×¤×ª×•×¨×™× ×•×˜×¤×¡×™× */
    .stButton button { width: 100%; border-radius: 8px; font-weight: bold; }
    div[data-baseweb="select"] { direction: rtl; }
    
    /* ×”×¡×ª×¨×ª ××œ×× ×˜×™× ××™×•×ª×¨×™× */
    #MainMenu {visibility: hidden;} footer {visibility: hidden;}
</style>
""", unsafe_allow_html=True)

# --- × ×™×”×•×œ Session State ---
if 'db' not in st.session_state: st.session_state.db = load_db()
if 'completed_topics' not in st.session_state: st.session_state.completed_topics = set()
if 'correct_questions' not in st.session_state: st.session_state.correct_questions = set()

# --- ×—×™×©×•×‘ ×”×ª×§×“××•×ª ---
total_subtopics = sum(len(cat['topics']) for cat in st.session_state.db.values())
completed_count = len(st.session_state.completed_topics)
progress_val = completed_count / total_subtopics if total_subtopics > 0 else 0

# --- ×¡×¨×’×œ ×¦×“ ---
with st.sidebar:
    st.title("ğŸ¥ ×Ö²×—Ö¸×™×•Ö¼×ª")
    st.caption("×¢× ×™×©×™ ×§×•×¤×¨××Ÿ | PICU")
    
    st.markdown("---")
    st.markdown(f"**×”×ª×§×“××•×ª ×œ××™×“×”: {int(progress_val*100)}%**")
    st.progress(progress_val)
    st.markdown(f"× ×•×©××™× ×©×”×•×©×œ××•: {completed_count}/{total_subtopics}")
    
    st.markdown("---")
    menu = st.radio("×ª×¤×¨×™×˜:", ["ğŸ  ×“×£ ×”×‘×™×ª", "ğŸ“– ××¨×›×– ×œ××™×“×”", "ğŸ“ ××‘×—×Ÿ ×™×“×¢"])

# --- ×¢××•×“×™× ---

if menu == "ğŸ  ×“×£ ×”×‘×™×ª":
    st.title("×‘×¨×•×›×™× ×”×‘××™× ×œ××¢×¨×›×ª ×”×œ××™×“×” ğŸ¥")
    st.markdown("### ×˜×™×¤×•×œ × ××¨×¥ ×™×œ×“×™× - ×¤×¨×•×˜×•×§×•×œ×™× ×•× ×”×œ×™×")
    
    st.markdown("---")
    
    # ×”×¦×’×ª ×”×§×˜×’×•×¨×™×•×ª ×›×›×¨×˜×™×¡×™×
    cols = st.columns(len(st.session_state.db))
    for i, (cat_name, data) in enumerate(st.session_state.db.items()):
        with cols[i]:
            st.markdown(f"""
            <div class="category-card">
                <div style="font-size: 3rem;">{data['icon']}</div>
                <h3>{cat_name}</h3>
                <p>{data.get('description', '')}</p>
            </div>
            """, unsafe_allow_html=True)
            
    st.markdown("---")
    col1, col2 = st.columns(2)
    with col1:
        st.info("ğŸ’¡ **×˜×™×¤ ×™×•××™:** ×‘×”×—×™×™××”, ×× ×™×© ×”×™×¤×¨×§×œ××™×”, ×ª×Ÿ ×§×œ×¦×™×•× ×’×œ×•×§×•× ×˜ ×œ×”×’× ×” ×¢×œ ×”×œ×‘ ×œ×¤× ×™ ××ª×Ÿ ××™× ×¡×•×œ×™×Ÿ.")
    with col2:
        st.warning("âš ï¸ **×‘×˜×™×—×•×ª:** ×”××™× ×•×Ÿ ×œ××“×¨× ×œ×™×Ÿ ×‘×”×—×™×™××” ×”×•× 0.01 ×\"×’ ×œ×§\"×’ (×•×œ× 0.1!).")

elif menu == "ğŸ“– ××¨×›×– ×œ××™×“×”":
    st.title("ğŸ“– ××¨×›×– ×œ××™×“×”")
    
    # ×‘×—×™×¨×ª × ×•×©× ×¨××©×™
    cats = list(st.session_state.db.keys())
    selected_cat = st.selectbox("×‘×—×¨ × ×•×©× ×¨××©×™:", cats)
    cat_data = st.session_state.db[selected_cat]
    
    # ×‘×—×™×¨×ª ×ª×ª-× ×•×©× (×›×¤×ª×•×¨×™× ××¢×•×¦×‘×™×)
    st.markdown(f"#### {cat_data['icon']} {selected_cat} - ×‘×—×™×¨×ª ×¤×¨×•×˜×•×§×•×œ:")
    
    subtopics = list(cat_data['topics'].keys())
    # ×¤×¨×™×¡×ª ×›×¤×ª×•×¨×™×
    cols = st.columns(3)
    for idx, sub in enumerate(subtopics):
        is_done = "âœ…" if sub in st.session_state.completed_topics else "â­•"
        if cols[idx % 3].button(f"{is_done} {sub}", key=sub, use_container_width=True):
            st.session_state.current_subtopic = sub
    
    # ×”×¦×’×ª ×”×ª×•×›×Ÿ
    if 'current_subtopic' in st.session_state and st.session_state.current_subtopic in subtopics:
        sub = st.session_state.current_subtopic
        content = cat_data['topics'][sub]
        
        st.markdown("---")
        # ×›×•×ª×¨×ª ×”× ×•×©×
        st.markdown(f"## {sub}")
        
        # ×’×•×£ ×”×ª×•×›×Ÿ
        st.markdown(f"""<div class="content-box">{content['text']}</div>""", unsafe_allow_html=True)
        
        # ××“×™×”
        if content.get('image'):
            st.image(content['image'], caption="×ª×¨×©×™× ×œ×”××—×©×”", width=400)
        
        st.markdown("---")
        
        # ×›×¤×ª×•×¨ ×¡×™×•× ×œ××™×“×”
        is_checked = sub in st.session_state.completed_topics
        if st.checkbox("×¡×™×™××ª×™ ×œ×œ××•×“ ××ª ×”× ×•×©× ×”×–×” âœ…", value=is_checked):
            st.session_state.completed_topics.add(sub)
        else:
            st.session_state.completed_topics.discard(sub)

elif menu == "ğŸ“ ××‘×—×Ÿ ×™×“×¢":
    st.title("ğŸ“ ××‘×—×Ÿ ×™×“×¢ ×•××™×•×× ×•×ª")
    st.markdown("×‘×—×Ÿ ××ª ×¢×¦××š ×¢×œ ×”×¤×¨×•×˜×•×§×•×œ×™× ×©× ×œ××“×•.")
    
    # ×¡×™× ×•×Ÿ ×©××œ×•×ª ×©×›×‘×¨ × ×¢× ×• × ×›×•×Ÿ (××•×¤×¦×™×•× ×œ×™ - ×›×¨×’×¢ × ×¦×™×’ ×”×›×œ ×œ×ª×¨×’×•×œ ×—×•×–×¨)
    # pool = [q for q in ALL_QUESTIONS if q['q'] not in st.session_state.correct_questions]
    pool = ALL_QUESTIONS
    
    if 'quiz_selection' not in st.session_state:
        st.session_state.quiz_selection = random.sample(pool, min(5, len(pool)))
        
    if st.button("ğŸ”„ ×”×’×¨×œ ×©××œ×•×ª ×—×“×©×•×ª"):
        st.session_state.quiz_selection = random.sample(pool, min(5, len(pool)))
        st.rerun()
    
    with st.form("quiz_form"):
        score = 0
        total = len(st.session_state.quiz_selection)
        
        for i, q in enumerate(st.session_state.quiz_selection):
            # ×‘×“×™×§×” ×× ×”×©××œ×” ×›×‘×¨ × ×¤×ª×¨×” ×‘×¢×‘×¨
            is_solved_before = q['q'] in st.session_state.correct_questions
            suffix = " (×¤×ª×¨×ª × ×›×•×Ÿ ×‘×¢×‘×¨ â­)" if is_solved_before else ""
            
            st.markdown(f"""<div class="question-box"><strong>×©××œ×” {i+1}:</strong> {q['q']}{suffix}</div>""", unsafe_allow_html=True)
            
            # ××¤×ª×— ×™×™×—×•×“×™ ×œ×›×œ ×©××œ×” ×‘×˜×•×¤×¡
            ans = st.radio(f"×ª×©×•×‘×” {i+1}:", q['opts'], key=f"q_{i}", index=None, label_visibility="collapsed")
            
            if ans == q['a']:
                score += 1
            
            st.markdown("---")
        
        submitted = st.form_submit_button("×”×’×© ××‘×—×Ÿ ğŸ")
        
        if submitted:
            st.markdown(f"### ×¦×™×•×Ÿ: {score}/{total}")
            if score == total:
                st.balloons()
            
            # ×”×¦×’×ª ×ª×©×•×‘×•×ª ×•×”×¡×‘×¨×™×
            for i, q in enumerate(st.session_state.quiz_selection):
                user_ans = st.session_state.get(f"q_{i}")
                st.subheader(f"×©××œ×” {i+1}")
                
                if user_ans == q['a']:
                    st.markdown(f"<div class='success-box'>âœ… <b>× ×›×•×Ÿ!</b></div>", unsafe_allow_html=True)
                    st.session_state.correct_questions.add(q['q'])
                else:
                    st.markdown(f"<div class='error-box'>âŒ <b>×˜×¢×•×ª.</b> ×”×ª×©×•×‘×” ×”× ×›×•× ×”: {q['a']}</div>", unsafe_allow_html=True)
                
                st.info(f"ğŸ’¡ **×”×¡×‘×¨:** {q['exp']}")
                st.markdown("---")
