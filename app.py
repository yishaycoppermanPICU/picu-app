import streamlit as st
import pandas as pd
import random
from datetime import datetime

# --- ×”×’×“×¨×ª ×¢××•×“ ×•×¢×™×¦×•×‘ ---
st.set_page_config(page_title="×Ö²×—Ö¸×™×•Ö¼×ª - ×œ××™×“×” ×œ×˜×™×¤×•×œ × ××¨×¥", layout="wide", initial_sidebar_state="expanded")

# ×¢×™×¦×•×‘ ×œ×™××™×Ÿ-×œ×©×××œ (RTL) ×•×”×ª×××•×ª ×•×™×–×•××œ×™×•×ª
st.markdown("""
<style>
    .stApp { direction: rtl; text-align: right; }
    h1, h2, h3, h4, h5, h6, p, div, span, label, .stMarkdown { text-align: right !important; }
    .stSidebar { direction: rtl; text-align: right; }
    .stTextInput input, .stTextArea textarea, .stSelectbox div[data-baseweb="select"] { direction: rtl; text-align: right; }
    .stRadio, .stCheckbox { direction: rtl; text-align: right; }
    h1 { color: #2E86C1; }
    .stButton button { width: 100%; border-radius: 8px; font-weight: bold; }
    /* ×”×“×’×©×ª ×ª×©×•×‘×” × ×›×•× ×”/×©×’×•×™×” */
    .correct { background-color: #d4edda; padding: 10px; border-radius: 5px; border-right: 5px solid #28a745; }
    .incorrect { background-color: #f8d7da; padding: 10px; border-radius: 5px; border-right: 5px solid #dc3545; }
</style>
""", unsafe_allow_html=True)

# --- ×××’×¨ ×—×•××¨ ×œ×™××•×“ (××ª×•×š ×”×§×‘×¦×™× ×©×œ×š - × ×§×™ ××”×¢×¨×•×ª) ---
study_materials = {
    "×ª×¨×•×¤×•×ª ×•×”×—×™×™××”": {
        "××©×œ×’×Ÿ (Potassium)": """
        **×¢×¨×›×™× ×ª×§×™× ×™×:** 3.5-5 mEq/L.
        **×”×™×¤×•×§×œ××™×”:** ××ª×—×ª ×œ-3.5.
        
        **×“×’×©×™ ××ª×Ÿ:**
        * ××ª×Ÿ ×¤×•××™ ×”×•× ×”××•××œ×¥.
        * ××ª×Ÿ IV: ×¨×¦×•×™ ×‘×•×¨×™×“ ××¨×›×–×™. ×§×¦×‘ ××§×¡×™××œ×™ 1 mEq/kg/h (××• 40 mEq/h).
        * ×× × ×•×ª× ×™× ×‘×•×¨×™×“ ×¤×¨×™×¤×¨×™: ×§×¦×‘ ××§×¡×™××œ×™ 10 mEq/h.
        * **×—×•×§ ×—×©×•×‘:** ×‘×—×•×œ×™× ×¢× ×”×™×¤×•××’× ×–××™×” ×•×”×™×¤×•×§×œ××™×”, ×™×© ×œ×ª×§×Ÿ ××’× ×–×™×•× ×ª×—×™×œ×”, ××—×¨×ª ×”×”×™×¤×•×§×œ××™×” ×ª×”×™×” ×¢××™×“×” ×œ×˜×™×¤×•×œ.
        """,
        "××“×¨× ×œ×™×Ÿ (Adrenaline)": """
        **×‘×”×—×™×™××”:**
        * ××™× ×•×Ÿ: 0.01 mg/kg (×©×–×” 0.1 ×"×œ ×œ×§"×’ ×‘×ª××™×¡×” ×©×œ 1:10,000).
        * ××§×¡×™××•× ×œ×× ×”: 1 mg.
        * × ×™×ª×Ÿ ×œ×—×–×•×¨ ×›×œ 2 ×“×§×•×ª.
        
        **×‘××™× ×”×œ×¦×™×” (×¡×˜×¨×™×“×•×¨):**
        * ××™× ×•×Ÿ: 400 mcg/kg (××§×¡' 5 ×"×’).
        """,
        "××“× ×•×–×™×Ÿ (Adenosine)": """
        **×”×ª×•×•×™×”:** SVT.
        **××•×¤×Ÿ ××ª×Ÿ:** ×¤×•×© ××”×™×¨ + ×©×˜×™×¤×” ××”×™×¨×” (5-10 ×"×œ ×¡×œ×™×™×Ÿ) ×‘×‘×¨×– ×”×›×™ ×§×¨×•×‘ ×œ×œ×‘ (×‘×’×œ×œ ×–××Ÿ ××—×¦×™×ª ×—×™×™× ×§×¦×¨ ×××•×“).
        **××™× ×•×Ÿ:** ×× ×” ×¨××©×•× ×” 0.1 mg/kg (××§×¡' 6 ×"×’). ×× ×” ×©× ×™×™×” 0.2 mg/kg (××§×¡' 12 ×"×’).
        """,
        "×¡×“×¦×™×” ×•××™× ×˜×•×‘×¦×™×”": """
        **××™×“×–×•×œ× (×“×•×¨××™×§×•×):** ××™× ×•×Ÿ 0.1-0.05 mg/kg. ×™×© ×œ×”×™×–×”×¨ ×‘×ª×™× ×•×§×•×ª ××ª×—×ª ×œ×’×™×œ ×—×¦×™ ×©× ×” (×“×™×›×•×™ × ×©×™××ª×™).
        **×§×˜××™×Ÿ:** ×©×•××¨ ×¢×œ ×¨×¤×œ×§×¡ × ×©×™××” ×•×œ×—×¥ ×“× (××ª××™× ×œ×©×•×§). ××™× ×•×Ÿ 1-2 mg/kg.
        **×¨×•×§×•×¨×•× ×™×•×:** ××©×ª×§ ×©×¨×™×¨×™×. ××™× ×•×Ÿ 1 mg/kg (RSI). ×—×•×‘×” ×œ×ª×ª ×¡×“×¦×™×” ×œ×¤× ×™!
        """
    },
    "××¦×‘×™ ×—×™×¨×•× ×•×¤×¨×•×˜×•×§×•×œ×™×": {
        "×¡×¤×¡×™×¡ (Sepsis)": """
        **×”×’×“×¨×”:** ×—×©×“ ×œ×–×™×”×•× + SIRS (×—×•×/×”×™×¤×•×ª×¨××™×”, ×œ×•×™×§×•×¦×™×˜×•×–×™×¡/×¤× ×™×”, ×˜×›×™×§×¨×“×™×”/×¤× ×™××”).
        
        **×˜×™×¤×•×œ ××™×™×“×™ (×ª×•×š ×©×¢×”):**
        1. ×’×™×©×” ×•×¨×™×“×™×ª + ×ª×¨×‘×™×•×ª (×× ×œ× ××¢×›×‘ ×× ×˜×™×‘×™×•×˜×™×§×”).
        2. ×× ×˜×™×‘×™×•×˜×™×§×” ×¨×—×‘×ª ×˜×•×•×— (×œ××©×œ ××¨×•×¤× × 20 mg/kg).
        3. × ×•×–×œ×™×: 20 ml/kg ×‘×•×œ×•×¡ (×¢×“ 60 ml/kg ×ª×•×š × ×™×˜×•×¨ ×¢×•××¡).
        4. ×‘×“×™×§×ª ×œ×§×˜×˜.
        
        **×©×•×§ ×¡×¤×˜×™ ×¢××™×“:** ×× ××™×Ÿ ×ª×’×•×‘×” ×œ× ×•×–×œ×™× -> × ×•×¨××“×¨× ×œ×™×Ÿ/××“×¨× ×œ×™×Ÿ.
        """,
        "×©×•×§ ×”×™×¤×•×•×œ××™": """
        **×¡×™×× ×™×:** ×˜×›×™×§×¨×“×™×” (×¤×™×¦×•×™ ×¨××©×•× ×™), ××™×œ×•×™ ×§×¤×™×œ×¨×™ ××™×˜×™, ×™×¨×™×“×” ×‘××ª×Ÿ ×©×ª×Ÿ. ×œ"×“ ×™×•×¨×“ ×¨×§ ×‘×©×œ×‘ ×××•×—×¨ (×¡×™××Ÿ ××‘×©×¨ ×¨×¢×•×ª!).
        **×˜×™×¤×•×œ:** ×”×—×–×¨ × ×•×–×œ×™× ××’×¨×¡×™×‘×™ (×§×¨×™×¡×˜×œ×•××™×“×™×) 20 ml/kg.
        """,
        "×˜×¨××•××ª ×¨××© (TBI)": """
        **CPP (×œ×—×¥ ×–×™×œ×•×— ××•×—×™):** MAP - ICP. ×™×¢×“ ×‘×™×œ×“×™×: ×¡×‘×™×‘ 40-50.
        **×˜×¨×™××“×” ×¢"×© ×§×•×©×™× ×’ (×¢×œ×™×™×ª ICP):** ×™×ª×¨ ×œ"×“ + ×‘×¨×“×™×§×¨×“×™×” + × ×©×™××” ×œ× ×¡×“×™×¨×”.
        **×˜×™×¤×•×œ ×‘-ICP ×’×‘×•×”:** ×”×¨××ª ×¨××© 30 ××¢×œ×•×ª, ×¡×œ×™×™×Ÿ ×”×™×¤×¨×˜×•× ×™ (3%) ××• ×× ×™×˜×•×œ, ×”× ×©××” ×¢× PCO2 ×¡×‘×™×‘ 35-40 (×”×™×¤×¨×•×•× ×˜×™×œ×¦×™×” ××ª×•× ×”).
        """
    },
    "×§×¨×“×™×•×œ×•×’×™×” ×•×”××˜×•-××•× ×§×•×œ×•×’×™×”": {
        "×× ×¤×™×œ×§×¡×™×¡": """
        **×˜×™×¤×•×œ ×§×• ×¨××©×•×Ÿ:** ××“×¨× ×œ×™×Ÿ IM ×‘×™×¨×š.
        **××™× ×•×Ÿ:** 0.01 mg/kg.
        **×˜×™×¤×•×œ × ×•×¡×£:** × ×•×–×œ×™×, ×•× ×˜×•×œ×™×Ÿ, ×¡×˜×¨×•××™×“×™× (×œ× ×‘×©×œ×‘ ×”××™×™×“×™).
        """,
        "Tumor Lysis Syndrome (TLS)": """
        **×××¤×™×™× ×™×:** ×”×™×¤×¨××•×¨×™×¦××™×”, ×”×™×¤×¨×§×œ××™×”, ×”×™×¤×¨×¤×•×¡×¤×˜××™×”, ×”×™×¤×•×§×œ×¦××™×”.
        **×× ×™×¢×”:** ×”×™×“×¨×¦×™×” ×’×‘×•×”×” + ××œ×•×¤×¨×™× ×•×œ/×¨×¡×‘×•×¨×™×§×–.
        **×¡×›× ×”:** ×”×™×¤×¨×§×œ××™×” ×©××•×‘×™×œ×” ×œ×”×¤×¨×¢×•×ª ×§×¦×‘.
        """
    }
}

# --- ×××’×¨ ×©××œ×•×ª (× ×§×™ ××©×’×™××•×ª) ---
all_questions = [
    {
        "topic": "×ª×¨×•×¤×•×ª",
        "question": "×™×œ×“ ××’×™×¢ ×‘×”×—×™×™××”. ××” ×”××™× ×•×Ÿ ×”××§×•×‘×œ ×œ××“×¨× ×œ×™×Ÿ IV/IO?",
        "options": ["0.01 mg/kg", "0.1 mg/kg", "1 mg/kg", "0.5 mg/kg"],
        "correct": "0.01 mg/kg",
        "explanation": "×”××™× ×•×Ÿ ×‘×”×—×™×™××ª ×™×œ×“×™× ×”×•× 0.01 ××´×’ ×œ×§×´×’ (1:10,000). ××™× ×•×Ÿ ×©×œ 0.1 ×”×•× ×¤×™ 10 ×•×¢×œ×•×œ ×œ×”×™×•×ª ×§×˜×œ× ×™."
    },
    {
        "topic": "×ª×¨×•×¤×•×ª",
        "question": "×›×™×¦×“ ×™×© ×œ×ª×ª ××“× ×•×–×™×Ÿ ×œ×˜×™×¤×•×œ ×‘-SVT?",
        "options": ["×“×¨×™×¤ ××™×˜×™ ×‘××©×š 10 ×“×§×•×ª", "×¤×•×© ××”×™×¨ ×‘×•×¨×™×“ ××¨×›×–×™/×§×¨×•×‘ ×œ×œ×‘ ×•××™×“ ×©×˜×™×¤×”", "××ª×Ÿ ×¤×•××™", "IM ×‘×™×¨×š"],
        "correct": "×¤×•×© ××”×™×¨ ×‘×•×¨×™×“ ××¨×›×–×™/×§×¨×•×‘ ×œ×œ×‘ ×•××™×“ ×©×˜×™×¤×”",
        "explanation": "×œ××“× ×•×–×™×Ÿ ×–××Ÿ ××—×¦×™×ª ×—×™×™× ×§×¦×¨ ×××•×“ (×©× ×™×•×ª), ×œ×›×Ÿ ×—×•×‘×” ×œ×ª×ª ×‘×¤×•×© ××”×™×¨ ×•×©×˜×™×¤×” ×›×“×™ ×©×™×’×™×¢ ×œ×œ×‘ ×œ×¤× ×™ ×©×™×ª×¤×¨×§."
    },
    {
        "topic": "×¤×¨×•×˜×•×§×•×œ×™×",
        "question": "×‘×—×©×“ ×œ×¡×¤×¡×™×¡, ××” ×›××•×ª ×”× ×•×–×œ×™× (×‘×•×œ×•×¡) ×”×¨××©×•× ×™×ª ×©×™×© ×œ×ª×ª?",
        "options": ["20 ml/kg", "50 ml/kg", "5 ml/kg", "100 ml/kg"],
        "correct": "20 ml/kg",
        "explanation": "×œ×¤×™ ×¤×¨×•×˜×•×§×•×œ ×¡×¤×¡×™×¡, ××ª×—×™×œ×™× ×‘-10-20 ××´×œ ×œ×§×´×’ ××™×–×•×˜×•× ×™×™× (×¡×œ×™×™×Ÿ/×”×¨×˜××Ÿ) ×ª×•×š ×”×¢×¨×›×” ×—×•×–×¨×ª."
    },
    {
        "topic": "×˜×¨××•××”",
        "question": "××” ×›×•×œ×œ×ª ×”×˜×¨×™××“×” ×¢\"×© ×§×•×©×™× ×’ (Cushing Triad) ×”××¢×™×“×” ×¢×œ ×œ×—×¥ ×ª×•×š ×’×•×œ×’×•×œ×ª×™ ×’×‘×•×”?",
        "options": ["×˜×›×™×§×¨×“×™×”, ×™×¨×™×“×ª ×œ\"×“, ×—×•×", "×‘×¨×“×™×§×¨×“×™×”, ×™×ª×¨ ×œ×—×¥ ×“×, × ×©×™××” ×œ× ×¡×“×™×¨×”", "××™×©×•× ×™× ×¦×¨×™×, ×”×–×¢×”, ×©×œ×©×•×œ", "×›××‘ ×¨××©, ×˜×©×˜×•×© ×¨××™×”, ×”×§××•×ª"],
        "correct": "×‘×¨×“×™×§×¨×“×™×”, ×™×ª×¨ ×œ×—×¥ ×“×, × ×©×™××” ×œ× ×¡×“×™×¨×”",
        "explanation": "×–×”×• ×× ×’× ×•×Ÿ ×¤×™×¦×•×™ ××•×—×™ ×‘× ×™×¡×™×•×Ÿ ×œ×©××•×¨ ×¢×œ CPP ××•×œ ICP ×’×‘×•×”."
    },
    {
        "topic": "×ª×¨×•×¤×•×ª",
        "question": "××”×• ×¡×“×¨ ×”×˜×™×¤×•×œ ×”× ×›×•×Ÿ ×‘×™×œ×“ ×¢× ×”×™×¤×•×§×œ××™×” ×•×”×™×¤×•××’× ×–××™×”?",
        "options": ["×ª×™×§×•×Ÿ ××©×œ×’×Ÿ ×•××– ××’× ×–×™×•×", "×ª×™×§×•×Ÿ ××’× ×–×™×•× ×•××– ××©×œ×’×Ÿ", "×ª×™×§×•×Ÿ ×‘×• ×–×× ×™ ×‘×œ×‘×“", "××™×Ÿ ×—×©×™×‘×•×ª ×œ×¡×“×¨"],
        "correct": "×ª×™×§×•×Ÿ ××’× ×–×™×•× ×•××– ××©×œ×’×Ÿ",
        "explanation": "×—×•×¡×¨ ×‘××’× ×–×™×•× ××§×©×” ×¢×œ ×”×›×œ×™×” ×œ×©××•×¨ ××©×œ×’×Ÿ. ×œ×œ× ×ª×™×§×•×Ÿ ××’× ×–×™×•×, ×”×”×™×¤×•×§×œ××™×” ×ª×”×™×” ×¢××™×“×” ×œ×˜×™×¤×•×œ."
    },
    {
        "topic": "×¤×¨×•×˜×•×§×•×œ×™×",
        "question": "××”×• ×”×˜×™×¤×•×œ ×”×ª×¨×•×¤×ª×™ ×”×¨××©×•× ×™ (×§×• ×¨××©×•×Ÿ) ×‘×× ×¤×™×œ×§×¡×™×¡?",
        "options": ["×¡×˜×¨×•××™×“×™× IV", "××“×¨× ×œ×™×Ÿ IM", "×× ×˜×™×”×™×¡×˜××™× ×™× PO", "××™× ×”×œ×¦×™×™×ª ×•× ×˜×•×œ×™×Ÿ"],
        "correct": "××“×¨× ×œ×™×Ÿ IM",
        "explanation": "××™×Ÿ ×§×•× ×˜×¨××™× ×“×™×§×¦×™×” ×œ××“×¨× ×œ×™×Ÿ ×‘×× ×¤×™×œ×§×¡×™×¡. ×–×”×• ×”×˜×™×¤×•×œ ××¦×™×œ ×”×—×™×™× ×”×™×—×™×“ ×”××™×™×“×™."
    }
]

# --- × ×™×”×•×œ ××©×ª××© (Session State) ---
if 'user_info' not in st.session_state:
    st.session_state.user_info = {}
if 'leaderboard' not in st.session_state:
    st.session_state.leaderboard = []

# --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ---
def save_score(user, score, topic):
    st.session_state.leaderboard.append({
        "×©×": user['name'],
        "××—×œ×§×”": user['department'],
        "×‘×™×ª ×—×•×œ×™×": user['hospital'],
        "× ×•×©×": topic,
        "×¦×™×•×Ÿ": score,
        "×ª××¨×™×š": datetime.now().strftime("%d/%m %H:%M")
    })

# --- ×ª×¤×¨×™×˜ ×¦×“ (Sidebar) ---
with st.sidebar:
    st.title("×¤×¨×•×¤×™×œ ××©×ª××©")
    
    # ×‘×“×™×§×” ×”×× ×”××©×ª××© ×›×‘×¨ ××—×•×‘×¨
    if not st.session_state.user_info:
        st.info("×”×–×Ÿ ×¤×¨×˜×™× ×œ×›× ×™×¡×” ×œ××¢×¨×›×ª")
        with st.form("login_form"):
            name = st.text_input("×©× ××œ×")
            email = st.text_input("××™××™×™×œ")
            hospital = st.selectbox("×‘×™×ª ×—×•×œ×™×", ["×©×™×‘× - ×ª×œ ×”×©×•××¨", "×©× ×™×™×“×¨", "××™×›×™×œ×•×‘ - ×“× ×”", "×”×“×¡×”", "×¨××‘\"×", "×¡×•×¨×•×§×”", "××—×¨"])
            department = st.text_input("××—×œ×§×”", value="×˜×™×¤×•×œ × ××¨×¥ ×™×œ×“×™×")
            
            # ×ª×•×¡×¤×ª "×–×›×•×¨ ××•×ª×™" (×ª×§×£ ×œ×¡×©×Ÿ ×”× ×•×›×—×™)
            remember_me = st.checkbox("×–×›×•×¨ ××•×ª×™")
            
            submit_login = st.form_submit_button("××™×©×•×¨ ×¤×¨×˜×™× ×•×›× ×™×¡×”")
        
        if submit_login:
            if name and email:
                st.session_state.user_info = {
                    "name": name, 
                    "email": email, 
                    "hospital": hospital, 
                    "department": department,
                    "remember": remember_me
                }
                st.success(f"×‘×¨×•×š ×”×‘×, {name}!")
                st.rerun()
            else:
                st.error("×—×•×‘×” ×œ××œ× ×©× ×•××™××™×™×œ")
    else:
        user = st.session_state.user_info
        st.success(f"××—×•×‘×¨ ×›: {user['name']}")
        st.caption(f"{user['hospital']} | {user['department']}")
        
        if st.button("×™×¦×™××”"):
            st.session_state.user_info = {}
            st.rerun()

    st.markdown("---")
    menu = st.radio("×ª×¤×¨×™×˜:", ["×“×£ ×”×‘×™×ª", "×—×•××¨ ×œ×™××•×“", "××‘×—×Ÿ ×™×“×¢", "×˜×‘×œ×ª ×”××•×‘×™×œ×™× ğŸ†", "× ×™×”×•×œ"])

# --- ×œ×•×’×™×§×” ×¨××©×™×ª ---

if menu == "×“×£ ×”×‘×™×ª":
    st.title("×Ö²×—Ö¸×™×•Ö¼×ª - ×œ××™×“×” ×œ×˜×™×¤×•×œ × ××¨×¥")
    st.subheader(f"×‘×¨×•×›×™× ×”×‘××™×, {st.session_state.user_info.get('name', '××•×¨×—/×ª')}")
    st.markdown("""
    ××¢×¨×›×ª ×–×• ××‘×•×¡×¡×ª ×¢×œ ×”×¤×¨×•×˜×•×§×•×œ×™× ×”×¢×“×›× ×™×™× ×©×œ ×”××—×œ×§×”.
    
    **××” ×‘××¢×¨×›×ª?**
    * ğŸ“š **×—×•××¨ ×¢×™×•× ×™:** ×¡×™×›×•××™× ×¢×œ ×ª×¨×•×¤×•×ª, ×”×—×™×™××”, ×¡×¤×¡×™×¡ ×•×˜×¨××•××”.
    * ğŸ“ **××‘×—× ×™×:** ×©××œ×•×ª ×××¨×™×§××™×•×ª ×œ×ª×¨×’×•×œ ×™×“×¢ ×¢× ×”×¡×‘×¨×™× ××¤×•×¨×˜×™×.
    * ğŸ† **×ª×—×¨×•×ª:** ×¦×‘×™×¨×ª × ×§×•×“×•×ª ×•×”×©×•×•××” ×‘×™×Ÿ ××—×œ×§×•×ª.
    """)
    
    col1, col2 = st.columns(2)
    with col1:
        st.info("ğŸ’¡ **×˜×™×¤ ×™×•××™:** ×‘×”×—×™×™××”, ×× ×™×© ×”×™×¤×¨×§×œ××™×”, ×ª×Ÿ ×§×œ×¦×™×•× ×’×œ×•×§×•× ×˜ ×œ×”×’× ×” ×¢×œ ×”×œ×‘ ×œ×¤× ×™ ××ª×Ÿ ××™× ×¡×•×œ×™×Ÿ.")
    with col2:
        st.warning("âš ï¸ **×©×™× ×œ×‘:** ×”××™× ×•×Ÿ ×œ××“×¨× ×œ×™×Ÿ ×‘×”×—×™×™××” ×”×•× 0.01 ×\"×’ ×œ×§\"×’ (×•×œ× 0.1!).")

elif menu == "×—×•××¨ ×œ×™××•×“":
    st.header("ğŸ“š ×—×•××¨ ×œ×™××•×“ ×•×¤×¨×•×˜×•×§×•×œ×™×")
    
    category = st.selectbox("×‘×—×¨ ×§×˜×’×•×¨×™×”:", list(study_materials.keys()))
    topic = st.selectbox("×‘×—×¨ × ×•×©×:", list(study_materials[category].keys()))
    
    st.markdown("---")
    st.subheader(topic)
    st.markdown(study_materials[category][topic])
    
    st.markdown("---")
    st.caption("××‘×•×¡×¡ ×¢×œ ×§×‘×¦×™ × ×”×œ×™×: '×ª×¨×•×¤×•×ª ×‘×˜×™×¤×•×œ × ××¨×¥' ×•-'××¦×‘×™× ××™×™×¦×’×™×'.")

elif menu == "××‘×—×Ÿ ×™×“×¢":
    st.header("ğŸ“ ××‘×—×Ÿ ×™×“×¢ ×‘×˜×™×¤×•×œ × ××¨×¥")
    
    if not st.session_state.user_info:
        st.error("×¢×œ×™×š ×œ×”×ª×—×‘×¨ ×‘×ª×¤×¨×™×˜ ×”×¦×“ ×›×“×™ ×œ×‘×¦×¢ ××‘×—×Ÿ ×•×œ×©××•×¨ ×¦×™×•×Ÿ.")
    else:
        # ×”×’×“×¨×•×ª ××‘×—×Ÿ
        col1, col2 = st.columns(2)
        with col1:
            quiz_mode = st.radio("×¡×•×’ ××‘×—×Ÿ:", ["×›×œ ×”× ×•×©××™× (××¢×•×¨×‘×œ)", "×ª×¨×•×¤×•×ª ×‘×œ×‘×“", "×¤×¨×•×˜×•×§×•×œ×™× ×‘×œ×‘×“"])
        with col2:
            num_q = st.slider("××¡×¤×¨ ×©××œ×•×ª:", 1, len(all_questions), 3)
        
        if st.button("×”×ª×—×œ ××‘×—×Ÿ ×—×“×©"):
            # ×¡×™× ×•×Ÿ ×©××œ×•×ª
            filtered_q = all_questions
            if quiz_mode == "×ª×¨×•×¤×•×ª ×‘×œ×‘×“":
                filtered_q = [q for q in all_questions if q['topic'] == "×ª×¨×•×¤×•×ª"]
            elif quiz_mode == "×¤×¨×•×˜×•×§×•×œ×™× ×‘×œ×‘×“":
                filtered_q = [q for q in all_questions if q['topic'] != "×ª×¨×•×¤×•×ª"]
            
            # ×‘×—×™×¨×” ×¨× ×“×•××œ×™×ª
            if len(filtered_q) > 0:
                st.session_state.current_quiz = random.sample(filtered_q, min(num_q, len(filtered_q)))
                st.session_state.quiz_answers = {}
                st.session_state.quiz_active = True
                st.rerun()
            else:
                st.warning("×œ× × ××¦××• ×©××œ×•×ª ×‘×§×˜×’×•×¨×™×” ×–×•.")

        if st.session_state.get('quiz_active'):
            st.markdown("---")
            score = 0
            count = 0
            
            with st.form("quiz_form"):
                for i, q in enumerate(st.session_state.current_quiz):
                    st.subheader(f"×©××œ×” {i+1}: {q['question']}")
                    # ×¢×¨×‘×•×‘ ×ª×©×•×‘×•×ª ×œ×ª×¦×•×’×” (×¤×¢× ××—×ª ×‘×œ×‘×“)
                    opts = q['options'].copy()
                    if f"shuffled_{i}" not in st.session_state:
                         random.shuffle(opts)
                         st.session_state[f"shuffled_{i}"] = opts
                    
                    user_ans = st.radio(f"×‘×—×¨ ×ª×©×•×‘×” ({i})", st.session_state[f"shuffled_{i}"], label_visibility="collapsed", key=f"q_{i}")
                    st.markdown("---")
                
                finish = st.form_submit_button("×”×’×© ××‘×—×Ÿ")
            
            if finish:
                st.session_state.quiz_active = False # ×¡×™×•× ××¦×‘ ×¢×¨×™×›×”
                correct_count = 0
                
                for i, q in enumerate(st.session_state.current_quiz):
                    user_selection = st.session_state.get(f"q_{i}")
                    st.subheader(f"×©××œ×” {i+1}: {q['question']}")
                    
                    if user_selection == q['correct']:
                        st.markdown(f"<div class='correct'>âœ… <b>×ª×©×•×‘×ª×š × ×›×•× ×”:</b> {user_selection}</div>", unsafe_allow_html=True)
                        correct_count += 1
                    else:
                        st.markdown(f"<div class='incorrect'>âŒ <b>×ª×©×•×‘×ª×š ×©×’×•×™×”:</b> {user_selection}<br><b>×”×ª×©×•×‘×” ×”× ×›×•× ×”:</b> {q['correct']}</div>", unsafe_allow_html=True)
                    
                    st.info(f"â„¹ï¸ **×”×¡×‘×¨:** {q['explanation']}")
                    st.markdown("---")
                
                if len(st.session_state.current_quiz) > 0:
                    final_score = int((correct_count / len(st.session_state.current_quiz)) * 100)
                    st.metric("×¦×™×•×Ÿ ×¡×•×¤×™", f"{final_score}%")
                    
                    # ×©××™×¨×ª ×”×¦×™×•×Ÿ
                    save_score(st.session_state.user_info, final_score, quiz_mode)
                    if final_score > 80:
                        st.balloons()

elif menu == "×˜×‘×œ×ª ×”××•×‘×™×œ×™× ğŸ†":
    st.header("ğŸ† ×˜×‘×œ×ª ×”××œ×•×¤×™×")
    if st.session_state.leaderboard:
        df = pd.DataFrame(st.session_state.leaderboard)
        st.dataframe(df, use_container_width=True)
        
        st.subheader("×“×™×¨×•×’ ×œ×¤×™ ×‘×ª×™ ×—×•×œ×™×")
        avg_hospital = df.groupby("×‘×™×ª ×—×•×œ×™×")["×¦×™×•×Ÿ"].mean()
        st.bar_chart(avg_hospital)
    else:
        st.info("×¢×“×™×™×Ÿ ××™×Ÿ × ×ª×•× ×™×. ×”×™×” ×”×¨××©×•×Ÿ ×œ×”×™×‘×—×Ÿ!")

elif menu == "× ×™×”×•×œ":
    st.header("âš™ï¸ ×××©×§ × ×™×”×•×œ")
    user_email = st.session_state.user_info.get('email', '')
    
    if user_email == 'yishaycopp@gmail.com':
        st.success("×–×•×”×” ×× ×”×œ ××¢×¨×›×ª: ×™×©×™ ×§×•×¤×¨××Ÿ")
        st.write("×›××Ÿ ×ª×•×›×œ ×œ×”×•×¡×™×£ ×©××œ×•×ª ×—×“×©×•×ª ×‘×¢×ª×™×“ (×›×¨×’×¢ ××‘×•×¡×¡ ×§×•×“).")
    else:
        st.error("â›” ××™×Ÿ ×œ×š ×”×¨×©××ª ×’×™×©×” ×œ×“×£ ×–×”.")
