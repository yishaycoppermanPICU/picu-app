import streamlit as st
import random
import time

# ==============================================================================
# 1. ×”×’×“×¨×•×ª ××¢×¨×›×ª ×•×¢×™×¦×•×‘ (CSS ××ª×§×“×)
# ==============================================================================

st.set_page_config(
    page_title="PICU Master Class - ××¢×¨×›×ª ×œ××™×“×” ×•×¡×™××•×œ×¦×™×”",
    page_icon="ğŸ¥",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ×¤×•× ×§×¦×™×™×ª ×¨×™× ×“×•×¨ HTML × ×§×™ (×œ×× ×™×¢×ª ×©×‘×™×¨×ª ×˜×§×¡×˜)
def render_clean_html(text):
    html = text.replace("\n", "<br>")
    lines = html.split("<br>")
    formatted_lines = []
    in_list = False
    
    for line in lines:
        clean_line = line.strip()
        if clean_line.startswith("###"):
            clean_line = f"<h3 style='color:#0277bd; margin-top:20px; border-bottom:2px solid #e1f5fe; padding-bottom:5px;'>{clean_line.replace('###', '')}</h3>"
        elif clean_line.startswith("##"):
            clean_line = f"<h2 style='color:#01579b; border-right:5px solid #ffca28; padding-right:10px;'>{clean_line.replace('##', '')}</h2>"
        
        # ×”×“×’×©×•×ª
        if "**" in clean_line:
            parts = clean_line.split("**")
            new_line = ""
            for i, part in enumerate(parts):
                new_line += f"<span style='font-weight:700; color:#b71c1c;'>{part}</span>" if i % 2 == 1 else part
            clean_line = new_line
            
        # ×¨×©×™××•×ª
        if clean_line.startswith("* ") or clean_line.startswith("- "):
            if not in_list:
                formatted_lines.append("<ul style='margin-right:25px; list-style-type: square;'>")
                in_list = True
            clean_line = f"<li style='margin-bottom:5px;'>{clean_line[2:]}</li>"
        else:
            if in_list:
                formatted_lines.append("</ul>")
                in_list = False
                
        formatted_lines.append(clean_line)
    
    if in_list: formatted_lines.append("</ul>")
    return f"<div style='direction:rtl; text-align:right; font-family:Rubik,sans-serif; font-size:1.1rem; line-height:1.7;'>{''.join(formatted_lines)}</div>"

st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap');
    
    /* Global RTL & Font */
    html, body, .stApp { font-family: 'Rubik', sans-serif !important; direction: rtl; text-align: right; background-color: #f0f4f8; }
    
    /* Headers & Text */
    h1, h2, h3, p, div, span { text-align: right !important; }
    
    /* Custom Components */
    .protocol-card {
        background: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05); border-top: 6px solid #0288d1;
        margin-bottom: 20px;
    }
    
    .scenario-monitor {
        background-color: #000000; color: #00ff00; font-family: 'Courier New', monospace;
        padding: 15px; border-radius: 10px; border: 4px solid #424242;
        display: flex; justify-content: space-around; align-items: center; margin-bottom: 20px;
        box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);
    }
    .monitor-val { font-size: 2rem; font-weight: bold; text-shadow: 0 0 5px #00ff00; }
    .monitor-lbl { font-size: 0.8rem; color: #aaa; }
    
    .choice-btn-container { margin-bottom: 10px; }
    
    /* Buttons */
    .stButton button {
        width: 100%; border-radius: 8px; font-weight: 600; padding: 12px;
        transition: all 0.2s ease-in-out;
    }
    .stButton button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    
    /* Sidebar */
    [data-testid="stSidebar"] { background-color: #ffffff; border-left: 1px solid #e0e0e0; }
    
    #MainMenu {visibility: hidden;} footer {visibility: hidden;}
</style>
""", unsafe_allow_html=True)


# ==============================================================================
# 2. ××¡×“ ×”× ×ª×•× ×™× ×”××œ× (The Encyclopedia)
# ==============================================================================

FULL_DB = {
    "ğŸš‘ ××¦×‘×™ ×—×™×¨×•× ×•×”×—×™×™××”": {
        "description": "×©×•×§, ×¡×¤×¡×™×¡, PALS, ×˜×¨××•××” ×•×›×•×•×™×•×ª.",
        "subcategories": {
            "×¡×•×’×™ ×©×•×§ (Shock)": {
                "×©×•×§ ×”×™×¤×•×•×œ××™": {
                    "text": """## ×©×•×§ ×”×™×¤×•×•×œ××™ (Hypovolemic Shock)
**×”×’×“×¨×”:** ×™×¨×™×“×” ×‘×¤×¨×¤×•×–×™×” ×¢×§×‘ ××•×‘×“×Ÿ × ×¤×— (×“× ××• × ×•×–×œ×™×).
**×’×•×¨××™×:** ×’×¡×˜×¨×•×× ×˜×¨×™×˜×™×¡, DKA, ×›×•×•×™×•×ª, ×“×™××•×, Diabetes Insipidus.

### ×§×œ×™× ×™×§×” ×œ×¤×™ ×©×œ×‘×™×:
* **×¤×™×¦×•×™ (Compensated):** ×˜×›×™×§×¨×“×™×”, ×’×¤×™×™× ×§×¨×™×¨×•×ª, ××™×œ×•×™ ×§×¤×™×œ×¨×™ > 2 ×©× ×™×•×ª. **×œ×—×¥ ×“× ×ª×§×™×Ÿ!**
* **×‘×œ×ª×™ ××¤×¦×” (Uncompensated):** ×™×¨×™×“×ª ×œ"×“ (×¡×™××Ÿ ×××•×—×¨ ×‘×™×œ×“×™×!), ×˜×›×™×¤× ×™××”, ××™×¢×•×˜ ×©×ª×Ÿ (<1 ×"×œ/×§"×’/×©×¢×”), ×©×™× ×•×™ ×‘×”×›×¨×”.
* **×‘×œ×ª×™ ×”×¤×™×š:** ×‘×¨×“×™×§×¨×“×™×”, ×§×¨×™×¡×”.

### ×¤×¨×•×˜×•×§×•×œ ×˜×™×¤×•×œ:
1. **× ×ª×™×‘ ××•×•×™×¨:** ×—××¦×Ÿ 100%. ×©×§×•×œ ××™× ×˜×•×‘×¦×™×” ×× ××¦×‘ ×”×”×›×¨×” ×™×¨×•×“ (GCS<8).
2. **×’×™×©×”:** 2 ×•× ×¤×œ×•× ×™× ×¢×‘×™× (××• IO ×× × ×›×©×œ ×ª×•×š 90 ×©× ×™×•×ª).
3. **× ×•×–×œ×™×:** ×‘×•×œ×•×¡ 20 ×"×œ/×§"×’ ×¡×œ×™×™×Ÿ/×”×¨×˜××Ÿ ×ª×•×š 5-10 ×“×§×•×ª.
   * ×—×–×¨×”: ×¢×“ 60 ×"×œ/×§"×’.
   * *×—×¨×™×’:* DKA (× ×•×–×œ×™× ×‘×–×”×™×¨×•×ª, 10 ×"×œ/×§"×’), ×›×©×œ ×œ×‘×‘×™.
4. **×“×:** ×‘×©×•×§ ×”××•×¨×’×™ ×©×œ× ××’×™×‘ ×œ× ×•×–×œ×™× -> 10 ×"×œ/×§"×’ PC.""",
                    "image": "https://upload.wikimedia.org/wikipedia/commons/thumb/c/ce/Shock_types.png/640px-Shock_types.png"
                },
                "×©×•×§ ×¡×¤×˜×™": {
                    "text": """## ×¡×¤×¡×™×¡ ×•×©×•×§ ×¡×¤×˜×™
**SIRS:** ×©× ×™×™× ××ª×•×š: ×—×•×/×”×™×¤×•×ª×¨××™×”, ×˜×›×™×§×¨×“×™×”/×‘×¨×“×™×§×¨×“×™×”, ×˜×›×™×¤× ×™××”, ×œ×•×™×§×•×¦×™×˜×•×–×™×¡/×¤× ×™×”.
**Septic Shock:** ×¡×¤×¡×™×¡ + ×ª×ª ×œ×—×¥ ×“× ×©××™× ×• ××’×™×‘ ×œ× ×•×–×œ×™×.

### The Golden Hour (×—×‘×™×œ×ª ×©×¢×” ×¨××©×•× ×”):
1. **×—××¦×Ÿ ×•× ×™×˜×•×¨:** ×—×™×‘×•×¨ ×œ××•× ×™×˜×•×¨ ×¨×¦×™×£.
2. **×’×™×©×” ×•×¨×™×“×™×ª/IO:** ××™×™×“×™×ª.
3. **× ×•×–×œ×™×:** ×‘×•×œ×•×¡×™× ×©×œ 20 ×"×œ/×§"×’ (×¢×“ 60) ×ª×•×š ×”×¢×¨×›×ª ×›×‘×“ ×•×¨×™××•×ª (Rales).
4. **×× ×˜×™×‘×™×•×˜×™×§×”:** **×ª×•×š 60 ×“×§×•×ª!** (Meropenem / Ceftriaxone + Vancomycin). ×ª×¨×‘×™×•×ª ×œ×¤× ×™, ××œ× ×× ××¢×›×‘.
5. **×ª××™×›×” ×”××•×“×™× ××™×ª (Vasoactive):**
   * **×©×•×§ ×§×¨ (Cold Shock):** ××™×œ×•×™ ×§×¤×™×œ×¨×™ ××™×˜×™, ×¢×•×¨ ×§×¨ -> **××“×¨× ×œ×™×Ÿ** (0.05-0.3 mcg/kg/min).
   * **×©×•×§ ×—× (Warm Shock):** ××™×œ×•×™ ××”×™×¨ (Flash), ×“×¤×§×™× ×”×•×œ××™×, ×œ"×“ × ××•×š -> **× ×•×¨××“×¨× ×œ×™×Ÿ**.
6. **×§×•×¨×˜×™×§×•×¡×˜×¨×•××™×“×™×:** ×”×™×“×¨×•×§×•×¨×˜×™×–×•×Ÿ (×‘×—×©×“ ×œ××™ ×¡×¤×™×§×ª ××“×¨× ×œ/×©×•×§ ×¢××™×“).""",
                    "image": ""
                },
                "×× ×¤×™×œ×§×¡×™×¡": {
                    "text": """## ×× ×¤×™×œ×§×¡×™×¡
×ª×’×•×‘×” ××œ×¨×’×™×ª ××¡×›× ×ª ×—×™×™× (× ×©×™××ª×™×ª + ×”××•×“×™× ××™×ª).

### ×˜×™×¤×•×œ ××™×™×“×™ (×§×• ×¨××©×•×Ÿ):
1. **××“×¨× ×œ×™×Ÿ (IM):**
   * ××™× ×•×Ÿ: **0.01 ×"×’/×§"×’**.
   * ×¨×™×›×•×–: **1:1,000** (×œ× ××“×•×œ×œ!).
   * ××™×§×•×: ×™×¨×š.
   * ×—×–×¨×”: ×›×œ 5-15 ×“×§×•×ª.
2. **×”×©×›×‘×”:** ×”×¨××ª ×¨×’×œ×™×™× (Trendelenburg).
3. **× ×•×–×œ×™×:** 20 ×"×œ/×§"×’ ×‘×•×œ×•×¡ (×œ×¤×™×¦×•×™ ×¢×œ ×“×œ×™×¤×” ×§×¤×™×œ×¨×™×ª).

### ×˜×™×¤×•×œ ×§×• ×©× ×™:
* ×•× ×˜×•×œ×™×Ÿ (××™× ×”×œ×¦×™×”).
* ×¡×•×œ×•××“×¨×•×œ (IV).
* ×× ×˜×™×”×™×¡×˜××™× ×™× (IV/PO).""",
                    "image": ""
                }
            },
            "×˜×¨××•××” ×•×›×•×•×™×•×ª": {
                "×›×•×•×™×•×ª (Burns)": {
                    "text": """## ×›×•×•×™×•×ª ×•× ×•×¡×—×ª ×¤×¨×§×œ× ×“
**×¡×›× ×•×ª:** ×”×™×¤×•×•×œ××™×” (×“×œ×™×¤×ª ×¤×œ×–××”), ×©××™×¤×ª ×¢×©×Ÿ, ×”×™×¤×•×ª×¨××™×”, ×–×™×”×•×.

### ×—×™×©×•×‘ × ×•×–×œ×™× (Parkland Formula):
`4 ×"×œ * ××©×§×œ (×§"×’) * % ×©×˜×— ×›×•×•×™×” (TBSA)`
* **×—×œ×•×§×”:** 50% ×‘-8 ×©×¢×•×ª ×¨××©×•× ×•×ª, 50% ×‘-16 ×”×©×¢×•×ª ×”×‘××•×ª.
* **×¡×•×’ × ×•×–×œ:** ×”×¨×˜××Ÿ (Ringer Lactate) ××•×¢×“×£.
* **×“×’×© ×™×œ×“×™×:** ×™×© ×œ×”×•×¡×™×£ × ×•×–×œ×™ ××—×–×§×” (Maintenance) ×”××›×™×œ×™× ×’×œ×•×§×•×–!

### ×©××™×¤×ª ×¢×©×Ÿ (Inhalation Injury):
* ×—×©×“: ×›×•×•×™×•×ª ×‘×¤× ×™×, ×©×¢×¨×•×ª ××£ ×—×¨×•×›×•×ª, ×¤×™×— ×‘×›×™×—, ×¦×¨×™×“×•×ª, ×¡×˜×¨×™×“×•×¨.
* **×˜×™×¤×•×œ:** ××™× ×˜×•×‘×¦×™×” ××•×§×“××ª (×œ×¤× ×™ ×”×ª×¤×ª×—×•×ª ×‘×¦×§×ª ×—×•×¡××ª)!""",
                    "image": ""
                },
                "×”×¨×¢×œ×•×ª": {
                    "text": """## ×”×¨×¢×œ×•×ª × ×¤×•×¦×•×ª ×‘×™×œ×“×™×
**××§××•×œ (Paracetamol):**
* ×¤×’×™×¢×” ×›×‘×“×™×ª ×§×©×”.
* ×¨××•×ª ×‘×“×: ×œ××“×•×“ 4 ×©×¢×•×ª ××—×¨×™ ×”×‘×œ×™×¢×”.
* ×× ×˜×™×“×•×˜: **N-Acetylcysteine (NAC/Mucomyst)**.

**××•×¤×™××˜×™× (××•×¨×¤×™×Ÿ, ××ª×“×•×Ÿ):**
* ×¡×™×× ×™×: ×§×•××”, ××™×©×•× ×™ ×¡×™×›×” (Pinpoint), ×“×™×›×•×™ × ×©×™××ª×™.
* ×× ×˜×™×“×•×˜: **× ×œ×•×§×¡×•×Ÿ (Narcan)**. ××™× ×•×Ÿ 0.1 ×"×’/×§"×’.

**××•×¨×’× ×•×¤×•×¡×¤×˜×™× (×—×•××¨×™ ×”×“×‘×¨×”):**
* ×¡×™×× ×™×: ×¨×™×•×¨, ×“××¢×ª, ×©×œ×©×•×œ, ×‘×¨×“×™×§×¨×“×™×”, ×›×™×•×•×¥ ××™×©×•× ×™×.
* ×˜×™×¤×•×œ: **××˜×¨×•×¤×™×Ÿ** (×œ×™×™×‘×•×© ×”×¤×¨×©×•×ª) + ×¤×¨×œ×™×“×•×§×¡×™×.""",
                    "image": ""
                }
            }
        }
    },
    "ğŸ’Š ×¤×¨××§×•×œ×•×’×™×” ×•×ª×¨×•×¤×•×ª": {
        "description": "×¡×“×¦×™×”, ××™× ×•×˜×¨×•×¤×™×, ××œ×§×˜×¨×•×œ×™×˜×™×, ×‘×˜×™×—×•×ª.",
        "subcategories": {
            "×¡×“×¦×™×” ×•×× ×œ×’×–×™×”": {
                "×§×˜××™×Ÿ (Ketamine)": {
                    "text": """## ×§×˜××™×Ÿ (Ketamine)
×¡× ×“×™×¡×•×¦×™××˜×™×‘×™. ××©××¨ ×¨×¤×œ×§×¡ × ×©×™××” ×•××¢×œ×” ×œ"×“ (×¡×™××¤×˜×•××™××˜×™).
**×”×ª×•×•×™×”:** ××™× ×˜×•×‘×¦×™×” ×‘×—×•×œ×” ×œ× ×™×¦×™×‘ (×©×•×§), ××¡×˜××” ×§×©×”.

### ××™× ×•× ×™×:
* **IV:** ×× ×” ×©×œ 1-2 ×"×’/×§"×’.
* **IM:** ×× ×” ×©×œ 4-5 ×"×’/×§"×’.
* **×“×¨×™×¤:** 10-20 ××§"×’/×§"×’/×“×§×”.

### ×ª×•×¤×¢×•×ª ×œ×•×•××™:
* ×¨×™×•×¨ ××•×’×‘×¨ (Sialorrhea) - × ×™×ª×Ÿ ×œ×©×œ×‘ ×’×œ×™×§×•×¤×™×¨×•×œ×˜/××˜×¨×•×¤×™×Ÿ.
* ×”×–×™×•×ª (Hallucinations) ×‘×”×ª×¢×•×¨×¨×•×ª.
* ×œ×¨×™× ×’×•×¡×¤××–× (× ×“×™×¨).""",
                    "image": ""
                },
                "××™×“×–×•×œ× (Dormicum)": {
                    "text": """## ××™×“×–×•×œ× (Midazolam)
×‘× ×–×•×“×™××–×¤×™×Ÿ ×§×¦×¨ ×˜×•×•×—.
**××™× ×•×Ÿ:** 0.1 ×"×’/×§"×’ (IV).
**×¡×™×›×•× ×™×:** ×“×™×›×•×™ × ×©×™××ª×™ (×‘××™×•×—×“ ×‘×©×™×œ×•×‘ ×¢× ××•×¤×™××˜×™×), ×™×¨×™×“×ª ×œ×—×¥ ×“×.
**×× ×˜×™×“×•×˜:** ×¤×œ×•××–× ×™×œ (Flumazenil).""",
                    "image": ""
                },
                "×¨×•×§×•×¨×•× ×™×•× (Esmeron)": {
                    "text": """## ×¨×•×§×•×¨×•× ×™×•× (Rocuronium)
××©×ª×§ ×©×¨×™×¨×™× (Non-depolarizing).
**××™× ×˜×•×‘×¦×™×” (RSI):** 1 ×"×’/×§"×’.
**×–××Ÿ ×”×©×¤×¢×”:** 30-40 ×©× ×™×•×ª. ××©×š: 30-45 ×“×§×•×ª.
**××–×”×¨×”:** ×”××˜×•×¤×œ ××©×•×ª×§ ××š ×¢×¨! ×—×•×‘×” ×œ×ª×ª ×¡×“×¦×™×” ×œ×¤× ×™.""",
                    "image": ""
                }
            },
            "××™× ×•×˜×¨×•×¤×™× ×•×§×¨×“×™××œ×™": {
                "××“×¨× ×œ×™×Ÿ (Epinephrine)": {
                    "text": """## ××“×¨× ×œ×™×Ÿ (Epinephrine)
××’×•× ×™×¡×˜ ××œ×¤×+×‘×˜×.
**×”×—×™×™××”:** 0.01 ×"×’/×§"×’ (×“×™×œ×•×œ 1:10,000).
**×“×¨×™×¤ (Inotrope):** 0.05-1.0 ××§"×’/×§"×’/×“×§×”. ××™× ×•×Ÿ × ××•×š = ×‘×˜× (×œ×‘), ××™× ×•×Ÿ ×’×‘×•×” = ××œ×¤× (×›×œ×™ ×“×).""",
                    "image": ""
                },
                "××™×œ×¨×™× ×•×Ÿ (Milrinone)": {
                    "text": """## ××™×œ×¨×™× ×•×Ÿ (Milrinone)
××¢×›×‘ PDE3. × ×§×¨× Ino-dilator (××›×•×•×¥ ×œ×‘ + ××¨×—×™×‘ ×›×œ×™ ×“×).
**×”×ª×•×•×™×”:** ××™ ×¡×¤×™×§×ª ×œ×‘, ×™×ª×¨ ×œ×—×¥ ×“× ×¨×™××ª×™ (PHTN).
**××™× ×•×Ÿ:** 0.3-0.75 ××§"×’/×§"×’/×“×§×”.
**×¡×™×›×•×Ÿ:** ×ª×ª ×œ×—×¥ ×“× (Hypotension).""",
                    "image": ""
                }
            },
            "××œ×§×˜×¨×•×œ×™×˜×™×": {
                "×ª×™×§×•×Ÿ ××œ×§×˜×¨×•×œ×™×˜×™×": {
                    "text": """## ×ª×™×§×•×Ÿ ×”×¤×¨×¢×•×ª ××œ×§×˜×¨×•×œ×™×˜×¨×™×•×ª
**××©×œ×’×Ÿ (K):**
* ×”×™×¤×•×§×œ××™×”: ×ª×™×§×•×Ÿ PO ×¢×“×™×£. ×‘-IV ×§×¦×‘ ××§×¡' 0.5-1 mEq/kg/h.
* **×—×•×§:** ×œ×ª×§×Ÿ ××’× ×–×™×•× ×œ×¤× ×™ ××©×œ×’×Ÿ!
* ×”×™×¤×¨×§×œ××™×”: ×§×œ×¦×™×•× ×’×œ×•×§×•× ×˜ (×”×’× ×” ×¢×œ ×”×œ×‘), ××™× ×¡×•×œ×™×Ÿ+×’×œ×•×§×•×–, ×•× ×˜×•×œ×™×Ÿ.

**× ×ª×¨×Ÿ (Na):**
* ×”×™×¤×•× ×ª×¨××™×” ×§×©×” (×¡×™××¤×˜×•××˜×™×ª/×¤×¨×›×•×¡): ×¡×œ×™×™×Ÿ ×”×™×¤×¨×˜×•× ×™ 3% (3-5 ×"×œ/×§"×’).
* ×ª×™×§×•×Ÿ ××™×˜×™ ×œ×× ×™×¢×ª CPM (×‘×¦×§×ª ××•×—×™×ª/×”×¨×¡ ××™××œ×™×Ÿ).""",
                    "image": ""
                }
            }
        }
    },
    "ğŸ§  × ×•×™×¨×•×œ×•×’×™×”": {
        "description": "GCS, ×¤×¨×›×•×¡×™×, DI/SIADH, ×× ×™× ×’×™×˜×™×¡.",
        "subcategories": {
            "×—×‘×œ×ª ×¨××© (TBI)": {
                "× ×™×”×•×œ ICP": {
                    "text": """## ×œ×—×¥ ×ª×•×š ×’×•×œ×’×•×œ×ª×™ ××•×’×‘×¨ (ICP)
**×™×¢×“:** ×©××™×¨×” ×¢×œ CPP > 40-50. (CPP = MAP - ICP).
**×˜×¨×™××“×” ×¢"×© ×§×•×©×™× ×’:** ×™×ª"×œ + ×‘×¨×“×™×§×¨×“×™×” + × ×©×™××” ×œ× ×¡×“×™×¨×” (×¡×›× ×ª ×”×¨× ×™××¦×™×”!).

### ×˜×™×¤×•×œ ×‘-ICP ××•×’×‘×¨:
1. ×”×¨××ª ×¨××© 30 ××¢×œ×•×ª (× ×™×§×•×– ×•×¨×™×“×™).
2. ×¡×œ×™×™×Ÿ ×”×™×¤×¨×˜×•× ×™ 3% (3-5 ×"×œ/×§"×’).
3. ×× ×™×˜×•×œ (0.5-1 ×’×¨×/×§"×’).
4. ×”×™×¤×¨×•×•× ×˜×™×œ×¦×™×” ××ª×•× ×” (CO2 30-35) - ×¨×§ ×‘××¦×‘ ×—×™×¨×•× ×§×™×¦×•× ×™.""",
                    "image": ""
                }
            },
            "×¤×¨×›×•×¡×™×": {
                "×¡×˜×˜×•×¡ ××¤×™×œ×¤×˜×™×§×•×¡": {
                    "text": """## ×¡×˜×˜×•×¡ ××¤×™×œ×¤×˜×™×§×•×¡
×¤×¨×›×•×¡ > 5 ×“×§×•×ª.

### ×¤×¨×•×˜×•×§×•×œ ×˜×™×¤×•×œ:
1. **ABC:** ×—××¦×Ÿ, ×’×œ×•×§×•×– (×œ×©×œ×•×œ ×”×™×¤×•×’×œ×™×§××™×”).
2. **×§×• 1 (×‘× ×–×•×“×™××–×¤×™× ×™×):** ××™×“×–×•×œ× 0.1 ×"×’/×§"×’ (IV/IM).
3. **×§×• 2 (×”×¢××¡×”):**
   * ×¤× ×™×˜×•××™×Ÿ (Epanutin): 20 ×"×’/×§"×’. **×—×•×‘×” ×‘×¡×œ×™×™×Ÿ ×‘×œ×‘×“!**
   * ×œ×‘×˜×™×¨×¦×˜× (Keppra): 20-60 ×"×’/×§"×’.
   * ×¤× ×•×‘×¨×‘×™×˜×œ: ×‘×ª×™× ×•×§×•×ª.
4. **×§×• 3 (×”×¨×“××”):** ××™×“×–×•×œ× ×“×¨×™×¤, ×¤×¨×•×¤×•×¤×•×œ, ×ª×™×•×¤× ×˜×œ.""",
                    "image": ""
                }
            },
            "×××–×Ÿ × ×•×–×œ×™× ××•×—×™": {
                "DI vs SIADH": {
                    "text": """## ×”×¤×¨×¢×•×ª × ×ª×¨×Ÿ ×•×©×ª×Ÿ (DI vs SIADH)

### Diabetes Insipidus (DI):
* **×”×’×“×¨×”:** ×—×¡×¨ ×‘-ADH (×œ×¨×•×‘ ××—×¨×™ × ×™×ª×•×—/×˜×¨××•××” ××•×—×™×ª).
* **×¡×™×× ×™×:** ×”×©×ª× ×” ××¨×•×‘×” (Polyuria), ×©×ª×Ÿ ×‘×”×™×¨ ×•××“×•×œ×œ, **×”×™×¤×¨× ×ª×¨××™×”** ×‘×“×.
* **×˜×™×¤×•×œ:** × ×•×–×œ×™×, DDAVP (×•××–×•×¤×¨×¡×™×Ÿ).

### SIADH:
* **×”×’×“×¨×”:** ×”×¤×¨×©×ª ×™×ª×¨ ×©×œ ADH.
* **×¡×™×× ×™×:** ××™×¢×•×˜ ×©×ª×Ÿ, ×©×ª×Ÿ ××¨×•×›×–, **×”×™×¤×•× ×ª×¨××™×”** ×‘×“× (×“×™×œ×•×œ).
* **×˜×™×¤×•×œ:** ×”×’×‘×œ×ª × ×•×–×œ×™×, ×¤×•×¡×™×“, ××œ×— ×”×™×¤×¨×˜×•× ×™.""",
                    "image": ""
                }
            }
        }
    },
    "ğŸ©¸ ×”××˜×•-××•× ×§×•×œ×•×’×™×”": {
        "description": "×œ×•×§××™×”, ××•×¦×¨×™ ×“×, TLS.",
        "subcategories": {
            "×œ×•×§××™×”": {
                "TLS": {
                    "text": """## Tumor Lysis Syndrome (TLS)
×¤×™×¨×•×§ ××¡×™×‘×™ ×©×œ ×ª××™ ×’×™×“×•×œ.
**××¢×‘×“×”:** ×”×™×¤×¨-××•×¨×™×¦××™×”, ×”×™×¤×¨-×§×œ××™×”, ×”×™×¤×¨-×¤×•×¡×¤×˜××™×” -> ×”×™×¤×•-×§×œ×¦××™×”.
**×¡×›× ×”:** ×›×©×œ ×›×œ×™×ª×™, ×“×•× ×œ×‘.

### ×˜×™×¤×•×œ:
1. ×”×™×“×¨×¦×™×” ××•×’×‘×¨×ª (×¤×™ 2-3 ××”×¨×’×™×œ). ×œ×œ× ××©×œ×’×Ÿ!
2. ××œ×•×¤×¨×™× ×•×œ.
3. **Rasburicase:** ××¤×¨×§ ×—×•××¦×” ××•×¨×™×ª. **××¡×•×¨ ×‘×—×•×œ×™ G6PD!**""",
                    "image": ""
                }
            },
            "××•×¦×¨×™ ×“×": {
                "××ª×Ÿ ×“× ×•×¨×›×™×‘×™×": {
                    "text": """## × ×•×”×œ ××ª×Ÿ ××•×¦×¨×™ ×“×
**PC (×›×“×•×¨×™×•×ª ××“×•××•×ª):** 10-15 ×"×œ/×§"×’. ×—×•×‘×” ×¤×™×œ×˜×¨.
**×˜×¡×™×•×ª (PLT):** 5-10 ×"×œ/×§"×’. **××¡×•×¨ ×‘××©××‘×” (IVAC)!** (×”×¨×¡ ××›×× ×™). ×œ×ª×ª ×‘×’×¨×‘×™×˜×¦×™×”.
**×¤×œ×–××” (FFP):** ××›×™×œ ×¤×§×˜×•×¨×™ ×§×¨×™×©×”. ×œ-DIC ××• ×“×™××•× ××¡×™×‘×™.""",
                    "image": ""
                }
            }
        }
    },
    "ğŸ ×’×¡×˜×¨×• ×•×ª×–×•× ×”": {
        "description": "TPN, ×›×©×œ ×›×‘×“.",
        "subcategories": {
            "×ª×–×•× ×”": {
                "TPN": {
                    "text": """## ×”×–× ×” ×ª×•×š ×•×¨×™×“×™×ª (TPN)
**××¨×›×™×‘×™×:** ×“×§×¡×˜×¨×•×–, ×—×•××¦×•×ª ×××™× ×•, ×œ×™×¤×™×“×™×, ××œ×§×˜×¨×•×œ×™×˜×™×.
**×¡×™×‘×•×›×™×:**
1. ×–×™×”×•× ×¦× ×ª×¨ ××¨×›×–×™ (CLABSI).
2. ××˜×‘×•×œ×™: ×”×™×¤×¨×’×œ×™×§××™×”, ×”×¤×¨×¢×•×ª ××œ×§×˜×¨×•×œ×™×˜×¨×™×•×ª.
3. **Refeeding Syndrome:** ×‘×™×œ×“×™× ×‘×ª×ª ×ª×–×•× ×” - × ×¤×™×œ×ª ×–×¨×—×Ÿ, ××©×œ×’×Ÿ ×•××’× ×–×™×•× ×¢× ×”×ª×—×œ×ª ×”×”×–× ×”. ×¡×›× ×ª ×—×™×™×!""",
                    "image": ""
                }
            }
        }
    }
}

ALL_QUESTIONS = [
    {"q": "××” ×”××™× ×•×Ÿ ×©×œ ××“×¨× ×œ×™×Ÿ IV ×‘×”×—×™×™××”?", "opts": ["0.01 ×\"×’/×§\"×’ (1:10,000)", "0.1 ×\"×’/×§\"×’", "1 ×\"×’/×§\"×’", "0.5 ×\"×’/×§\"×’"], "a": "0.01 ×\"×’/×§\"×’ (1:10,000)", "exp": "×“×™×œ×•×œ 1:10,000."},
    {"q": "××” ×”×¡×™×‘×•×š ×”×¢×™×§×¨×™ ×‘××ª×Ÿ ×¤× ×™×˜×•××™×Ÿ ×¢× ×’×œ×•×§×•×–?", "opts": ["×”×ª×’×‘×©×•×ª ×”×ª×¨×•×¤×”", "×”×™×¤×•×’×œ×™×§××™×”", "×™×ª×¨ ×œ×—×¥ ×“×", "××™×Ÿ ×‘×¢×™×”"], "a": "×”×ª×’×‘×©×•×ª ×”×ª×¨×•×¤×”", "exp": "×¤× ×™×˜×•××™×Ÿ ×œ× ×™×¦×™×‘ ×‘×’×œ×•×§×•×– ×•×©×•×§×¢. ×—×•×‘×” ×œ×ª×ª ×‘×¡×œ×™×™×Ÿ."},
    {"q": "××”×• ×‘×•×œ×•×¡ ×”× ×•×–×œ×™× ×”×¨××©×•× ×™ ×‘×©×•×§?", "opts": ["20 ×\"×œ/×§\"×’", "50 ×\"×œ/×§\"×’", "5 ×\"×œ/×§\"×’", "10 ×\"×œ/×§\"×’"], "a": "20 ×\"×œ/×§\"×’", "exp": "×‘×•×œ×•×¡ ××”×™×¨."},
    {"q": "××™×–×• ×ª×¨×•×¤×” ××¡×•×¨×” ×œ×©×™××•×© ×‘-TLS ×‘×—×•×œ×™ G6PD?", "opts": ["Rasburicase", "Allopurinol", "Furosemide", "Calcium"], "a": "Rasburicase", "exp": "×’×•×¨××ª ×œ×”××•×œ×™×–×” ×§×©×” ×‘×—×¡×¨ G6PD."},
    {"q": "××”×• ×”×˜×™×¤×•×œ ×”××™×™×“×™ ×‘×× ×¤×™×œ×§×¡×™×¡?", "opts": ["××“×¨× ×œ×™×Ÿ IM", "×¡×˜×¨×•××™×“×™×", "×•× ×˜×•×œ×™×Ÿ", "×× ×˜×™×‘×™×•×˜×™×§×”"], "a": "××“×¨× ×œ×™×Ÿ IM", "exp": "××•× ×¢ ×§×¨×™×¡×” ×”××•×“×™× ××™×ª."},
    {"q": "××“×•×¢ ××™×Ÿ ×œ×ª×ª ×˜×¡×™×•×ª ×‘××©××‘×” (IVAC)?", "opts": ["×”×¨×¡ ××›×× ×™ ×©×œ ×”×˜×¡×™×•×ª", "×¡×›× ×ª ×–×™×”×•×", "××”×™×¨ ××“×™", "×¡×›× ×ª ×§×¨×™×©×”"], "a": "×”×¨×¡ ××›×× ×™ ×©×œ ×”×˜×¡×™×•×ª", "exp": "×™×© ×œ×ª×ª ×‘×’×¨×‘×™×˜×¦×™×”."},
    {"q": "××” ×××¤×™×™×Ÿ Diabetes Insipidus?", "opts": ["×”×©×ª× ×” ××¨×•×‘×”, ×©×ª×Ÿ ×“×œ×™×œ, ×”×™×¤×¨× ×ª×¨××™×”", "××™×¢×•×˜ ×©×ª×Ÿ, ×”×™×¤×•× ×ª×¨××™×”", "×’×œ×•×§×•×– ×’×‘×•×” ×‘×©×ª×Ÿ", "×—×•× ×’×‘×•×”"], "a": "×”×©×ª× ×” ××¨×•×‘×”, ×©×ª×Ÿ ×“×œ×™×œ, ×”×™×¤×¨× ×ª×¨××™×”", "exp": "×—×¡×¨ ×‘-ADH."}
]


# ==============================================================================
# 3. ×× ×•×¢ ×”×¡×™××•×œ×¦×™×”: ×ª×¨×—×™×© ××ª×’×œ×’×œ (10 ×©×œ×‘×™×)
# ==============================================================================

class ScenarioStep:
    def __init__(self, description, vitals, options):
        self.description = description
        self.vitals = vitals
        self.options = options # List of dicts: {text, type, feedback}

class SimulationEngine:
    def __init__(self):
        self.reset()
        
    def reset(self):
        self.step_index = 0
        self.score = 100
        self.history = []
        self.is_dead = False
        self.is_won = False
        
        # ×‘× ×™×™×ª ×”×ª×¨×—×™×©: ×‘×¨×•× ×›×™×•×œ×™×˜×™×¡ -> ×”×™×“×¨×“×¨×•×ª -> ×¡×¤×¡×™×¡ -> ×©×•×§ -> ×”×—×™×™××”
        self.scenario_data = [
            # ×©×œ×‘ 1: ×™×¦×™×‘ ×™×—×¡×™×ª
            ScenarioStep(
                "×ª×™× ×•×§ ×‘×Ÿ 4 ×—×•×“×©×™×, ×¨×§×¢ ×©×œ ×¤×’×•×ª. ×”×ª×§×‘×œ ×¢× ×©×™×¢×•×œ, × ×–×œ×ª ×•×—×•× 38.5. ×‘××™×•×Ÿ: ××™ ×©×§×˜, × ×©×™××” ×××•××¦×ª.",
                {"HR": 150, "BP": "85/50", "Sat": "92%", "RR": 55},
                [
                    {"t": "×—××¦×Ÿ ×‘××©×§×¤×™×™×, ×©××™×‘×ª ×”×¤×¨×©×•×ª, × ×™×˜×•×¨", "type": "correct", "fb": "âœ… ×˜×™×¤×•×œ ×ª×•××š ×¨××©×•× ×™ ××¦×•×™×Ÿ."},
                    {"t": "××™× ×˜×•×‘×¦×™×” ××™×™×“×™×ª ×¢× ×¤×¨×•×¤×•×¤×•×œ", "type": "dangerous", "fb": "ğŸ’€ ××’×¨×¡×™×‘×™ ××“×™ ×•××¡×•×›×Ÿ ×œ×œ× ××™× ×“×™×§×¦×™×”!"},
                    {"t": "××ª×Ÿ ×× ×˜×™×‘×™×•×˜×™×§×” IV", "type": "wrong", "fb": "âŒ ×›×¨×’×¢ × ×¨××” ×•×™×¨××œ×™ (×‘×¨×•× ×›×™×•×œ×™×˜×™×¡), ×œ× ×“×—×•×£."},
                    {"t": "××™× ×”×œ×¦×™×™×ª ×•× ×˜×•×œ×™×Ÿ", "type": "partial", "fb": "âš ï¸ ×¤×—×•×ª ×™×¢×™×œ ×‘×‘×¨×•× ×›×™×•×œ×™×˜×™×¡ (×‘×¦×§×ª ×•×œ× ×›×™×•×•×¥), ××‘×œ ××¤×©×¨×™."}
                ]
            ),
            # ×©×œ×‘ 2: ×”×™×“×¨×“×¨×•×ª × ×©×™××ª×™×ª
            ScenarioStep(
                "×œ××—×¨ ×©×¢×”: ×”×ª×™× ×•×§ × ×¨××” ×¢×™×™×£ ×™×•×ª×¨. ×¡×˜×•×¨×¦×™×” ×™×•×¨×“×ª ×œ-88% ×¢× ×—××¦×Ÿ. ×¨×ª×™×¢×•×ª ×‘×™×Ÿ ×¦×œ×¢×™×•×ª ×§×©×•×ª. × ×©×™××•×ª 70 ×œ×“×§×”.",
                {"HR": 170, "BP": "80/45", "Sat": "88%", "RR": 70},
                [
                    {"t": "××¢×‘×¨ ×œ-High Flow (×”×™×™×¤×œ×•) ××• ×¡×™×¤××¤ (CPAP)", "type": "correct", "fb": "âœ… ×ª××™×›×” × ×©×™××ª×™×ª ×œ× ×¤×•×œ×©× ×™×ª ×”×™× ×”×¦×¢×“ ×”×‘× ×”× ×›×•×Ÿ."},
                    {"t": "×”×’×‘×¨×ª ×—××¦×Ÿ ×‘××©×§×¤×™×™× ×œ-10 ×œ×™×˜×¨", "type": "wrong", "fb": "âŒ ×œ× ×™×¢×™×œ ×•×œ× × ×¢×™× ×œ×ª×™× ×•×§."},
                    {"t": "×¡×“×¦×™×” ×¢× ××™×“×–×•×œ× ×œ×”×¨×’×¢×”", "type": "dangerous", "fb": "ğŸ’€ ××¡×•×›×Ÿ! ×™×“×›× ××ª ×”× ×©×™××” ×•×™×’×¨×•× ×œ×§×¨×™×¡×”."},
                    {"t": "×¦×™×œ×•× ×—×–×”", "type": "partial", "fb": "âš ï¸ ×—×©×•×‘ ×œ××‘×—× ×”, ××‘×œ ×§×•×“× ×¦×¨×™×š ×œ×™×™×¦×‘ × ×©×™××ª×™×ª."}
                ]
            ),
            # ×©×œ×‘ 3: ×”×•×¤×¢×ª ×¡×™×× ×™ ×¡×¤×¡×™×¡
            ScenarioStep(
                "×‘××”×œ×š ×”×œ×™×œ×”: ×—×•× ×¢×•×œ×” ×œ-39.5. ×”×ª×™× ×•×§ ××¤××˜×™. ×“×•×¤×§ ×¢×•×œ×”, ××™×œ×•×™ ×§×¤×™×œ×¨×™ 3 ×©× ×™×•×ª. ×’×¤×™×™× ×§×¨×™×¨×•×ª.",
                {"HR": 190, "BP": "75/40", "Sat": "92% (HF)", "RR": 60},
                [
                    {"t": "×¤×ª×™×—×ª ×•×¨×™×“, ×ª×¨×‘×™×•×ª, ×‘×•×œ×•×¡ × ×•×–×œ×™× 20 ×\"×œ/×§\"×’", "type": "correct", "fb": "âœ… ×–×™×”×•×™ ××¦×•×™×Ÿ ×©×œ ×—×©×“ ×œ×¡×¤×¡×™×¡/×©×•×§."},
                    {"t": "××ª×Ÿ ××§××•×œ ×•× ×¨×•×ª", "type": "wrong", "fb": "âŒ ×”×ª××§×“×•×ª ×‘×—×•× ×›×©×”×™×œ×“ ×‘×©×•×§."},
                    {"t": "××™× ×”×œ×¦×™×™×ª ××“×¨× ×œ×™×Ÿ", "type": "wrong", "fb": "âŒ ×œ× ×™×¢×–×•×¨ ×œ×‘×¢×™×” ×”×¤×¨×¤×•×–×™×•× ×™×ª."},
                    {"t": "×”××ª× ×” ×œ×¨×•×¤× ×‘×›×™×¨", "type": "dangerous", "fb": "ğŸ’€ ×¢×™×›×•×‘ ×‘×˜×™×¤×•×œ ×‘×©×•×§ ×”×•× ×§×¨×™×˜×™."}
                ]
            ),
            # ×©×œ×‘ 4: × ×¤×™×œ×ª ×œ×—×¥ ×“×
            ScenarioStep(
                "××—×¨×™ ×‘×•×œ×•×¡ ×¨××©×•×Ÿ: ××™×Ÿ ×©×™×¤×•×¨. ×œ×—×¥ ×“× ×™×•×¨×“! ×”×™×œ×“ ×—×™×•×•×¨ ×××•×“. × ×¨××” '×©×•×§ ×§×¨'.",
                {"HR": 200, "BP": "55/30", "Sat": "90%", "RR": 30},
                [
                    {"t": "×‘×•×œ×•×¡ × ×•×¡×£ 20 ×\"×œ/×§\"×’ + ×”×›× ×ª ××“×¨× ×œ×™×Ÿ ×œ×“×¨×™×¤", "type": "correct", "fb": "âœ… ×”×—×™×™××ª × ×•×–×œ×™× ××’×¨×¡×™×‘×™×ª ×•×”×›× ×ª ××™× ×•×˜×¨×•×¤×™×."},
                    {"t": "××ª×Ÿ ×¤×•×¡×™×“ (Furosemide)", "type": "dangerous", "fb": "ğŸ’€ ×”×™×œ×“ ×‘×©×•×§ ×”×™×¤×•×•×œ××™/×¡×¤×˜×™, ×¤×•×¡×™×“ ×™×”×¨×•×’ ××•×ª×•!"},
                    {"t": "××ª×Ÿ ×“×", "type": "wrong", "fb": "âŒ ××™×Ÿ ×¢×“×•×ª ×œ×“×™××•× ×›×¨×’×¢."},
                    {"t": "×× ×˜×™×‘×™×•×˜×™×§×” ×‘×œ×‘×“", "type": "partial", "fb": "âš ï¸ ×—×©×•×‘, ××‘×œ ×”×™×œ×“ ×¦×¨×™×š ×™×™×¦×•×‘ ×”××•×“×™× ××™ ××™×™×“×™."}
                ]
            ),
            # ×©×œ×‘ 5: ×”×ª×“×¨×“×¨×•×ª × ×©×™××ª×™×ª ×•×”×›×¨×”
            ScenarioStep(
                "×”×™×œ×“ ××•×¨×™×“ ×”×›×¨×” (GCS 8). × ×©×™××•×ª ××™×˜×™×•×ª (Gasps). ×—××¦×ª ××˜×‘×•×œ×™×ª ×§×©×” ×‘×‘×“×™×§×ª ×’×–×™×.",
                {"HR": 160, "BP": "60/35", "Sat": "85%", "RR": 10},
                [
                    {"t": "××™× ×˜×•×‘×¦×™×” ××™×™×“×™×ª (RSI) ×¢× ×§×˜××™×Ÿ ×•×¨×•×§×•×¨×•× ×™×•×", "type": "correct", "fb": "âœ… ××™× ×“×™×§×¦×™×” ×‘×¨×•×¨×” ×œ×”× ×©××”. ×§×˜××™×Ÿ ×©×•××¨ ×¢×œ ×œ\"×“."},
                    {"t": "××™× ×˜×•×‘×¦×™×” ×¢× ×¤×¨×•×¤×•×¤×•×œ ×•×¤× ×˜× ×™×œ", "type": "dangerous", "fb": "ğŸ’€ ×¤×¨×•×¤×•×¤×•×œ ×™×¤×™×œ ××ª ×œ×—×¥ ×”×“× ×œ××¤×¡."},
                    {"t": "×”××©×š ×”×™×™×¤×œ×• ×•×”×©×’×—×”", "type": "dangerous", "fb": "ğŸ’€ ×”×™×œ×“ × ×•×©× ××’×•× ×œ×™, ×”×•× ×™××•×ª ×œ×œ× ×˜×•×‘×•×¡."},
                    {"t": "××ª×Ÿ ×‘×™×§×¨×‘×•× ×˜ ×œ×—××¦×ª", "type": "wrong", "fb": "âŒ ×™×© ×œ×˜×¤×œ ×‘×‘×¢×™×” ×”× ×©×™××ª×™×ª (××•×•×¨×•×¨) ×§×•×“×."}
                ]
            ),
            # ×©×œ×‘ 6: ×“×•× ×œ×‘ (Peri-intubation arrest)
            ScenarioStep(
                "×‘××”×œ×š ×”××™× ×˜×•×‘×¦×™×”: ×”×™×œ×“ ×¤×™×ª×— ×‘×¨×“×™×§×¨×“×™×” ×§×©×” ×•××– ××¡×™×¡×˜×•×œ×” ×‘××•× ×™×˜×•×¨.",
                {"HR": 0, "BP": "0/0", "Sat": "?", "RR": 0},
                [
                    {"t": "×”×ª×—×œ×ª ×¢×™×¡×•×™×™× ×•××ª×Ÿ ××“×¨× ×œ×™×Ÿ 0.01 ×\"×’/×§\"×’", "type": "correct", "fb": "âœ… ×¤×¨×•×˜×•×§×•×œ PALS: ×¢×™×¡×•×™×™× ×•××“×¨× ×œ×™×Ÿ ×‘××¡×™×¡×˜×•×œ×”."},
                    {"t": "××ª×Ÿ ×©×•×§ ×—×©××œ×™ 2J/kg", "type": "wrong", "fb": "âŒ ×©×•×§ × ×•×ª× ×™× ×¨×§ ×‘-VF/VT, ×œ× ×‘××¡×™×¡×˜×•×œ×”."},
                    {"t": "××ª×Ÿ ××˜×¨×•×¤×™×Ÿ", "type": "wrong", "fb": "âŒ ×œ× ××•××œ×¥ ×¨×•×˜×™× ×™×ª ×‘×“×•× ×œ×‘ ×‘×™×œ×“×™×."},
                    {"t": "×‘×“×™×§×ª ×“×•×¤×§ ×‘××©×š ×“×§×”", "type": "dangerous", "fb": "ğŸ’€ ×‘×“×™×§×ª ×“×•×¤×§ ××§×¡' 10 ×©× ×™×•×ª!"}
                ]
            ),
             # ×©×œ×‘ 7: ×—×–×¨×ª ×“×•×¤×§ (ROSC)
            ScenarioStep(
                "×™×© ×“×•×¤×§! (ROSC). ×”×™×œ×“ ××•× ×©×. ×œ\"×“ ×¢×“×™×™×Ÿ × ××•×š ×××•×“.",
                {"HR": 160, "BP": "50/30", "Sat": "95%", "RR": "Vent"},
                [
                    {"t": "×”×ª×—×œ×ª ×“×¨×™×¤ ××“×¨× ×œ×™×Ÿ/× ×•×¨××“×¨× ×œ×™×Ÿ ×œ×™×™×¦×•×‘", "type": "correct", "fb": "âœ… ×ª××™×›×” ××™× ×•×˜×¨×•×¤×™×ª ×—×™×•× ×™×ª ×œ××—×¨ ×”×—×™×™××” (Post-arrest care)."},
                    {"t": "××ª×Ÿ ×¡×“×¦×™×” ×¢××•×§×” ×¢× ××™×“×–×•×œ×", "type": "dangerous", "fb": "ğŸ’€ ×™×¤×™×œ ×©×•×‘ ××ª ×œ×—×¥ ×”×“×."},
                    {"t": "×’××™×œ×” ××”× ×©××”", "type": "wrong", "fb": "âŒ ××•×§×“× ××“×™."},
                    {"t": "××ª×Ÿ × ×•×–×œ×™× ×œ×œ× ×”×’×‘×œ×”", "type": "partial", "fb": "âš ï¸ ×–×”×™×¨×•×ª ××‘×¦×§×ª ×¨×™××•×ª."}
                ]
            ),
             # ×©×œ×‘ 8: ×™×™×¦×•×‘ ×•×”××©×š ×˜×™×¤×•×œ
            ScenarioStep(
                "×”×™×œ×“ ×™×¦×™×‘ ×”××•×“×™× ××™×ª ×ª×—×ª ××“×¨× ×œ×™×Ÿ. ×—×•× 39.0. ×¦×¨×™×š ×œ×”×—×œ×™×˜ ×¢×œ ×”××©×š ×˜×™×¤×•×œ.",
                {"HR": 140, "BP": "85/55", "Sat": "98%", "RR": "Vent"},
                [
                    {"t": "×•×™×“×•× ×›×™×¡×•×™ ×× ×˜×™×‘×™×•×˜×™ ×¨×—×‘, ×”×›× ×¡×ª ×¦× ×ª×¨ ××¨×›×–×™, × ×™×˜×•×¨ ×©×ª×Ÿ", "type": "correct", "fb": "âœ… × ×™×”×•×œ ×˜×™×¤×•×œ × ××¨×¥ ×§×œ××¡×™."},
                    {"t": "×”×¤×¡×§×ª ××“×¨× ×œ×™×Ÿ ×‘×‘×ª ××—×ª", "type": "dangerous", "fb": "ğŸ’€ ×™×’×¨×•× ×œ×§×¨×™×¡×” ×—×•×–×¨×ª (Rebound)."},
                    {"t": "×”×•×¦××ª ×˜×•×‘×•×¡ (××§×¡×˜×•×‘×¦×™×”)", "type": "wrong", "fb": "âŒ ×”×™×œ×“ ×¢×“×™×™×Ÿ ×§×¨×™×˜×™."},
                    {"t": "××ª×Ÿ ×ª×–×•× ×” ××œ××” (TPN)", "type": "partial", "fb": "âš ï¸ ×œ× ×“×—×•×£ ×‘×©×œ×‘ ×”××§×•×˜×™."}
                ]
            )
        ]
        
    def get_current_step(self):
        if self.step_index < len(self.scenario_data):
            return self.scenario_data[self.step_index]
        return None

    def process_choice(self, choice_data):
        # ×¢×“×›×•×Ÿ × ×™×§×•×“
        if choice_data['type'] == 'correct':
            self.score += 10
        elif choice_data['type'] == 'partial':
            self.score += 5
        elif choice_data['type'] == 'wrong':
            self.score -= 10
        elif choice_data['type'] == 'dangerous':
            self.score -= 30
            self.is_dead = True
        
        # ×©××™×¨×ª ×œ×•×’
        self.history.append({
            "step": self.step_index + 1,
            "action": choice_data['t'],
            "feedback": choice_data['fb'],
            "result": "Dead" if self.is_dead else "Alive"
        })
        
        # ×”×ª×§×“××•×ª
        self.step_index += 1
        if self.step_index >= len(self.scenario_data) and not self.is_dead:
            self.is_won = True

# ××ª×—×•×œ ×× ×•×¢ ×‘-session
if 'sim' not in st.session_state:
    st.session_state.sim = SimulationEngine()


# ==============================================================================
# 4. × ×™×”×•×œ ××©×ª××© ×•×¦×“ ×©×¨×ª
# ==============================================================================

if 'user_info' not in st.session_state: st.session_state.user_info = {}
if 'completed_topics' not in st.session_state: st.session_state.completed_topics = set()

# ==============================================================================
# 5. ×××©×§ ××©×ª××© (UI)
# ==============================================================================

# --- ×¡×¨×’×œ ×¦×“ ---
with st.sidebar:
    st.image("https://img.icons8.com/color/96/nurse-male--v1.png", width=80)
    st.markdown("### ×¤×¨×•×¤×™×œ ××©×ª××©")
    
    if not st.session_state.user_info:
        with st.form("auth"):
            name = st.text_input("×©× ××œ×")
            email = st.text_input("××™××™×™×œ")
            if st.form_submit_button("×”×ª×—×‘×¨×•×ª"):
                st.session_state.user_info = {"name": name, "email": email}
                st.rerun()
    else:
        st.success(f"××—×•×‘×¨: {st.session_state.user_info['name']}")
        
        # ×—×™×©×•×‘ ×”×ª×§×“××•×ª
        total_p = 0
        for cat in FULL_DB.values():
            for sub in cat['subcategories'].values():
                total_p += len(sub)
        done = len(st.session_state.completed_topics)
        
        if total_p > 0:
            st.markdown(f"**×”×ª×§×“××•×ª ×œ××™×“×”:** {int(done/total_p*100)}%")
            st.progress(done/total_p)
            
        if st.button("×™×¦×™××”"):
            st.session_state.user_info = {}
            st.rerun()

    st.markdown("---")
    menu = st.radio("×ª×¤×¨×™×˜:", ["ğŸ  ×“×£ ×”×‘×™×ª", "ğŸ“š ×”×× ×¦×™×§×œ×•×¤×“×™×”", "ğŸš‘ ×¡×™××•×œ×˜×•×¨ ××ª×’×œ×’×œ", "âš™ï¸ × ×™×”×•×œ"])

# --- ×¢××•×“×™× ---

if menu == "ğŸ  ×“×£ ×”×‘×™×ª":
    st.title("PICU Master Class ğŸ¥")
    st.subheader("××¢×¨×›×ª ×”×“×¨×›×” ××ª×§×“××ª ×œ×˜×™×¤×•×œ × ××¨×¥ ×™×œ×“×™×")
    
    col1, col2 = st.columns([2, 1])
    with col1:
        st.markdown("""
        <div class="protocol-card">
        ×‘×¨×•×›×™× ×”×‘××™×. ×”××¢×¨×›×ª ×›×•×œ×œ×ª ××ª ×›×œ ×”×™×“×¢ ×”× ×“×¨×© ×œ×¢×‘×•×“×” ×‘××—×œ×§×”:
        * **×¤×¨××§×•×œ×•×’×™×”:** ××™× ×•× ×™×, ×“×™×œ×•×œ×™×, ×”×ª×•×•×™×•×ª × ×’×“.
        * **×¤×¨×•×˜×•×§×•×œ×™×:** ×”×—×™×™××”, ×©×•×§, ×˜×¨××•××”, ×”××˜×•-××•× ×§×•×œ×•×’×™×”.
        * **×¡×™××•×œ×˜×•×¨:** ×ª×¨×’×•×œ ×§×‘×œ×ª ×”×—×œ×˜×•×ª ×‘×–××Ÿ ×××ª.
        </div>
        """, unsafe_allow_html=True)
        
    with col2:
        st.info("ğŸ’¡ **×˜×™×¤ ×™×•××™:**\n×‘××ª×Ÿ ×¤× ×™×˜×•××™×Ÿ (Epanutin) - ×—×•×‘×” ×œ×“×œ×œ ×‘-Normal Saline ×‘×œ×‘×“! ×’×œ×•×§×•×– ×’×•×¨× ×œ×”×ª×’×‘×©×•×ª.")
        st.warning("âš ï¸ **×‘×˜×™×—×•×ª:**\n××™×Ÿ ×œ×ª×ª ×˜×¡×™×•×ª ×“×¨×š ××©××‘×” (IVAC). ×× ×’× ×•×Ÿ ×”××©××‘×” ×”×•×¨×¡ ××ª ×”×˜×¡×™×•×ª.")

elif menu == "ğŸ“š ×”×× ×¦×™×§×œ×•×¤×“×™×”":
    st.title("ğŸ“š ×”×¡×¤×¨×™×™×” ×”××§×¦×•×¢×™×ª")
    
    # ×©×œ×‘ 1: ×‘×—×™×¨×ª ×§×˜×’×•×¨×™×”
    cats = list(FULL_DB.keys())
    sel_cat = st.selectbox("×‘×—×¨ ×ª×—×•×:", cats)
    cat_data = FULL_DB[sel_cat]
    st.caption(cat_data.get('description', ''))
    
    # ×©×œ×‘ 2: ×ª×ª ×§×˜×’×•×¨×™×”
    subcats = list(cat_data['subcategories'].keys())
    sel_sub = st.radio("× ×•×©×:", subcats, horizontal=True)
    
    # ×©×œ×‘ 3: ×¤×¨×•×˜×•×§×•×œ
    protocols = cat_data['subcategories'][sel_sub]
    prot_names = list(protocols.keys())
    
    st.markdown("---")
    cols = st.columns(3)
    for i, p in enumerate(prot_names):
        stat = "âœ…" if p in st.session_state.completed_topics else "â­•"
        if cols[i%3].button(f"{stat} {p}", use_container_width=True):
            st.session_state.curr_prot = p

    # ×”×¦×’×ª ×ª×•×›×Ÿ
    if 'curr_prot' in st.session_state and st.session_state.curr_prot in protocols:
        p_name = st.session_state.curr_prot
        p_data = protocols[p_name]
        
        st.markdown(f"<div class='protocol-card'>", unsafe_allow_html=True)
        st.markdown(render_clean_html(p_data['text']), unsafe_allow_html=True)
        
        if p_data.get('image'):
            st.image(p_data['image'], width=400)
        st.markdown("</div>", unsafe_allow_html=True)
        
        # ×¡×™×•× ×•×ª×¨×’×•×œ
        c1, c2 = st.columns(2)
        with c1:
            done = p_name in st.session_state.completed_topics
            if st.checkbox("×¡×™×™××ª×™ ×œ×œ××•×“ × ×•×©× ×–×”", value=done, key=p_name):
                st.session_state.completed_topics.add(p_name)
            else:
                st.session_state.completed_topics.discard(p_name)
        
        with c2:
            with st.expander("ğŸ“ ×‘×—×Ÿ ××ª ×¢×¦××š"):
                # ×¡×™× ×•×Ÿ ×©××œ×•×ª
                qs = [q for q in ALL_QUESTIONS if p_name.split()[0] in q['q'] or p_name.split()[0] in q['exp']]
                if not qs: qs = random.sample(ALL_QUESTIONS, 1)
                
                q = random.choice(qs)
                st.write(f"**{q['q']}**")
                ans = st.radio("×ª×©×•×‘×”:", q['opts'], key=f"q_{p_name}")
                if st.button("×‘×“×™×§×”", key=f"btn_{p_name}"):
                    if ans == q['a']:
                        st.success("× ×›×•×Ÿ!")
                    else:
                        st.error(f"×˜×¢×•×ª. {q['exp']}")

elif menu == "ğŸš‘ ×¡×™××•×œ×˜×•×¨ ××ª×’×œ×’×œ":
    st.title("ğŸš‘ ×¡×™××•×œ×¦×™×”: ×”×™×“×¨×“×¨×•×ª × ×©×™××ª×™×ª ×•×”×œ×")
    
    sim = st.session_state.sim
    
    if st.button("ğŸ”„ ×”×ª×—×œ ×¡×™××•×œ×¦×™×” ××—×“×©"):
        sim.reset()
        st.rerun()
        
    step = sim.get_current_step()
    
    if sim.is_dead:
        st.error("ğŸ’€ ×”××˜×•×¤×œ × ×¤×˜×¨. ×”×¡×™××•×œ×¦×™×” ×”×¡×ª×™×™××” ×‘×›×™×©×œ×•×Ÿ.")
        st.write(f"× ×™×§×•×“ ×¡×•×¤×™: {sim.score}")
        with st.expander("×¨××” ××”×œ×š ××™×¨×•×¢×™×"):
            for h in sim.history:
                st.write(f"×©×œ×‘ {h['step']}: {h['action']} -> {h['result']} ({h['feedback']})")
                
    elif sim.is_won:
        st.balloons()
        st.success(f"ğŸ‰ ×›×œ ×”×›×‘×•×“! ×”××˜×•×¤×œ ×™×•×¦×‘ ×‘×”×¦×œ×—×”. × ×™×§×•×“: {sim.score}")
        with st.expander("×¡×™×›×•× ×˜×™×¤×•×œ"):
             for h in sim.history:
                st.write(f"âœ… {h['action']}")
                
    elif step:
        # ××•× ×™×˜×•×¨
        st.markdown(f"""
        <div class="scenario-monitor">
            <div><div class="monitor-val" style="color:{'red' if step.vitals['HR']>180 or step.vitals['HR']<60 else '#0f0'}">{step.vitals['HR']}</div><div class="monitor-lbl">HR</div></div>
            <div><div class="monitor-val" style="color:{'red' if '60' in str(step.vitals['BP']) else '#0f0'}">{step.vitals['BP']}</div><div class="monitor-lbl">BP</div></div>
            <div><div class="monitor-val" style="color:{'red' if '8' in str(step.vitals['Sat']) else '#0f0'}">{step.vitals['Sat']}</div><div class="monitor-lbl">SPO2</div></div>
            <div><div class="monitor-val">{step.vitals['RR']}</div><div class="monitor-lbl">RR</div></div>
        </div>
        """, unsafe_allow_html=True)
        
        st.markdown(f"### ×©×œ×‘ {sim.step_index + 1}: {step.description}")
        
        # ×”×¦×’×ª ××¤×©×¨×•×™×•×ª
        st.write("---")
        st.write("**×‘×—×¨ ××ª ×”×¤×¢×•×œ×” ×”×‘××”:**")
        
        cols = st.columns(2)
        for i, opt in enumerate(step.options):
            if cols[i % 2].button(opt['t'], key=f"opt_{sim.step_index}_{i}"):
                sim.process_choice(opt)
                st.rerun()

elif menu == "âš™ï¸ × ×™×”×•×œ":
    st.title("×××©×§ ×× ×”×œ")
    if st.session_state.user_info.get('email') == 'yishaycopp@gmail.com':
        st.success("××—×•×‘×¨ ×›×× ×”×œ (Admin)")
        
        cat = st.selectbox("×§×˜×’×•×¨×™×”", list(FULL_DB.keys()))
        sub = st.selectbox("×ª×ª-× ×•×©×", list(FULL_DB[cat]['subcategories'].keys()))
        prot = st.selectbox("×¤×¨×•×˜×•×§×•×œ", list(FULL_DB[cat]['subcategories'][sub].keys()))
        
        curr_txt = FULL_DB[cat]['subcategories'][sub][prot]['text']
        new_txt = st.text_area("×¢×¨×•×š ×ª×•×›×Ÿ:", value=curr_txt, height=300)
        
        if st.button("×©××•×¨ ×©×™× ×•×™×™×"):
            FULL_DB[cat]['subcategories'][sub][prot]['text'] = new_txt
            st.success("× ×©××¨!")
    else:
        st.error("××™×Ÿ ×”×¨×©××”.")
